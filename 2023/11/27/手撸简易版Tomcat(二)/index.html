<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="手撸简易版Tomcat(二)一、实现ServletContext在Java Web应用程序中，ServletContext代表应用程序的运行环境，一个Web应用程序对应一个唯一的ServletContext实例，ServletContext可以用于：  提供初始化和全局配置：可以从ServletContext获取Web App配置的初始化参数、资源路径等信息； 共享全局数据：ServletCont">
<meta property="og:type" content="article">
<meta property="og:title" content="手撸简易版Tomcat(二)">
<meta property="og:url" content="https://hulingf.github.io/2023/11/27/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/index.html">
<meta property="og:site_name" content="大军的秘密花园">
<meta property="og:description" content="手撸简易版Tomcat(二)一、实现ServletContext在Java Web应用程序中，ServletContext代表应用程序的运行环境，一个Web应用程序对应一个唯一的ServletContext实例，ServletContext可以用于：  提供初始化和全局配置：可以从ServletContext获取Web App配置的初始化参数、资源路径等信息； 共享全局数据：ServletCont">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://hulingf.github.io/imgs/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/image-20231127171157255.png">
<meta property="og:image" content="https://hulingf.github.io/imgs/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/image-20231127132735702.png">
<meta property="og:image" content="https://hulingf.github.io/imgs/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/image-20231127132833374.png">
<meta property="og:image" content="https://hulingf.github.io/imgs/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/image-20231127132910628.png">
<meta property="og:image" content="https://hulingf.github.io/imgs/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/image-20231127133206980.png">
<meta property="og:image" content="https://hulingf.github.io/imgs/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/image-20231127133339508.png">
<meta property="og:image" content="https://hulingf.github.io/imgs/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/image-20231127140913723.png">
<meta property="og:image" content="https://hulingf.github.io/imgs/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/image-20231127140954473.png">
<meta property="og:image" content="https://hulingf.github.io/imgs/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/image-20231127141041731.png">
<meta property="og:image" content="https://hulingf.github.io/imgs/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/image-20231127141115190.png">
<meta property="og:image" content="https://hulingf.github.io/imgs/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/image-20231127141201376.png">
<meta property="og:image" content="https://hulingf.github.io/imgs/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/image-20231127141308161.png">
<meta property="og:image" content="https://hulingf.github.io/imgs/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/image-20231127152238495.png">
<meta property="og:image" content="https://hulingf.github.io/imgs/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/image-20231127152338332.png">
<meta property="og:image" content="https://hulingf.github.io/imgs/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/image-20231127152509584.png">
<meta property="og:image" content="https://hulingf.github.io/imgs/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/image-20231127154211169.png">
<meta property="og:image" content="https://hulingf.github.io/imgs/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/image-20231127154049413.png">
<meta property="og:image" content="https://hulingf.github.io/imgs/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/image-20231127155242546.png">
<meta property="article:published_time" content="2023-11-27T05:27:34.419Z">
<meta property="article:modified_time" content="2023-11-27T09:11:59.767Z">
<meta property="article:author" content="hulingF">
<meta property="article:tag" content="框架实现">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://hulingf.github.io/imgs/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/image-20231127171157255.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>手撸简易版Tomcat(二)</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/hulingF">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2023/11/30/%E5%B0%B1%E4%B8%9A%E5%8F%91%E5%B1%95%E6%80%BB%E7%BB%93/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2023/11/27/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%B8%80)/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://hulingf.github.io/2023/11/27/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://hulingf.github.io/2023/11/27/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/&text=手撸简易版Tomcat(二)"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://hulingf.github.io/2023/11/27/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/&title=手撸简易版Tomcat(二)"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://hulingf.github.io/2023/11/27/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/&is_video=false&description=手撸简易版Tomcat(二)"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=手撸简易版Tomcat(二)&body=Check out this article: https://hulingf.github.io/2023/11/27/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://hulingf.github.io/2023/11/27/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/&title=手撸简易版Tomcat(二)"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://hulingf.github.io/2023/11/27/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/&title=手撸简易版Tomcat(二)"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://hulingf.github.io/2023/11/27/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/&title=手撸简易版Tomcat(二)"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://hulingf.github.io/2023/11/27/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/&title=手撸简易版Tomcat(二)"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://hulingf.github.io/2023/11/27/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/&name=手撸简易版Tomcat(二)&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://hulingf.github.io/2023/11/27/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/&t=手撸简易版Tomcat(二)"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat-%E4%BA%8C"><span class="toc-number">1.</span> <span class="toc-text">手撸简易版Tomcat(二)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%AE%9E%E7%8E%B0ServletContext"><span class="toc-number">1.1.</span> <span class="toc-text">一、实现ServletContext</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%AE%9E%E7%8E%B0FilterChain"><span class="toc-number">1.2.</span> <span class="toc-text">二、实现FilterChain</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E5%AE%9E%E7%8E%B0HttpSession"><span class="toc-number">1.3.</span> <span class="toc-text">三、实现HttpSession</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E5%AE%9E%E7%8E%B0Listener"><span class="toc-number">1.4.</span> <span class="toc-text">四、实现Listener</span></a></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        手撸简易版Tomcat(二)
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">hulingF</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-11-27T05:27:34.419Z" class="dt-published" itemprop="datePublished">2023-11-27</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0/" rel="tag">框架实现</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h1 id="手撸简易版Tomcat-二"><a href="#手撸简易版Tomcat-二" class="headerlink" title="手撸简易版Tomcat(二)"></a>手撸简易版Tomcat(二)</h1><h2 id="一、实现ServletContext"><a href="#一、实现ServletContext" class="headerlink" title="一、实现ServletContext"></a>一、实现ServletContext</h2><p>在Java Web应用程序中，<code>ServletContext</code>代表应用程序的运行环境，一个Web应用程序对应一个唯一的<code>ServletContext</code>实例，<code>ServletContext</code>可以用于：</p>
<ul>
<li>提供初始化和全局配置：可以从<code>ServletContext</code>获取Web App配置的初始化参数、资源路径等信息；</li>
<li>共享全局数据：<code>ServletContext</code>存储的数据可以被整个Web App的所有组件读写。</li>
</ul>
<p>既然<code>ServletContext</code>是一个Web App的全局唯一实例，而Web App又运行在Servlet容器中，我们在实现<code>ServletContext</code>时，完全可以把它当作Servlet容器来实现，它在内部维护一组Servlet实例，并根据Servlet配置的路由信息将请求转发给对应的Servlet处理。假设我们编写了两个Servlet：</p>
<ul>
<li>IndexServlet：映射路径为<code>/</code>；</li>
<li>HelloServlet：映射路径为<code>/hello</code>。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebServlet(urlPatterns = &quot;/&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IndexServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">html</span> <span class="operator">=</span> <span class="string">&quot;&lt;h1&gt;Index Page&lt;/h1&gt;&quot;</span>;</span><br><span class="line">        resp.setContentType(<span class="string">&quot;text/html&quot;</span>);</span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">pw</span> <span class="operator">=</span> resp.getWriter();</span><br><span class="line">        pw.write(html);</span><br><span class="line">        pw.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@WebServlet(urlPatterns = &quot;/hello&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">html</span> <span class="operator">=</span> <span class="string">&quot;&lt;h1&gt;Hello, &quot;</span> + (name == <span class="literal">null</span> ? <span class="string">&quot;world&quot;</span> : name) + <span class="string">&quot;.&lt;/h1&gt;&quot;</span>;</span><br><span class="line">        resp.setContentType(<span class="string">&quot;text/html&quot;</span>);</span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">pw</span> <span class="operator">=</span> resp.getWriter();</span><br><span class="line">        pw.write(html);</span><br><span class="line">        pw.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;request body data: &quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(req.getInputStream().readAllBytes()));</span><br><span class="line">        <span class="type">String</span> <span class="variable">html</span> <span class="operator">=</span> <span class="string">&quot;&lt;h1&gt;Hello, &quot;</span> + (name == <span class="literal">null</span> ? <span class="string">&quot;world&quot;</span> : name) + <span class="string">&quot;.&lt;/h1&gt;&quot;</span>;</span><br><span class="line">        resp.setContentType(<span class="string">&quot;text/html&quot;</span>);</span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">pw</span> <span class="operator">=</span> resp.getWriter();</span><br><span class="line">        pw.write(html);</span><br><span class="line">        pw.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么，处理HTTP请求的路径如下：</p>
<p><img src="/../../../../../../imgs/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/image-20231127171157255.png" alt="image-20231127171157255"></p>
<p>下面，我们来实现<code>ServletContext</code>。首先定义<code>ServletMapping</code>，它包含一个Servlet实例，以及将映射路径编译为正则表达式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AbstractMapping</span> <span class="keyword">implements</span> <span class="title class_">Comparable</span>&lt;AbstractMapping&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Pattern pattern;</span><br><span class="line">    <span class="keyword">final</span> String url;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AbstractMapping</span><span class="params">(String urlPattern)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.url = urlPattern;</span><br><span class="line">        <span class="built_in">this</span>.pattern = buildPattern(urlPattern);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">matches</span><span class="params">(String uri)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> pattern.matcher(uri).matches();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Pattern <span class="title function_">buildPattern</span><span class="params">(String urlPattern)</span> &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(urlPattern.length() + <span class="number">16</span>);</span><br><span class="line">        <span class="comment">// 正则表达式的开头</span></span><br><span class="line">        sb.append(<span class="string">&#x27;^&#x27;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; urlPattern.length(); i++) &#123;</span><br><span class="line">            <span class="type">char</span> <span class="variable">ch</span> <span class="operator">=</span> urlPattern.charAt(i);</span><br><span class="line">            <span class="keyword">if</span> (ch == <span class="string">&#x27;*&#x27;</span>) &#123;</span><br><span class="line">                <span class="comment">// 表示匹配任意字符</span></span><br><span class="line">                sb.append(<span class="string">&quot;.*&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ch &gt;= <span class="string">&#x27;a&#x27;</span> &amp;&amp; ch &lt;= <span class="string">&#x27;z&#x27;</span> || ch &gt;= <span class="string">&#x27;A&#x27;</span> &amp;&amp; ch &lt;= <span class="string">&#x27;Z&#x27;</span> || ch &gt;= <span class="string">&#x27;0&#x27;</span> &amp;&amp; ch &lt;= <span class="string">&#x27;9&#x27;</span>) &#123;</span><br><span class="line">                <span class="comment">// 常规字符保持一致</span></span><br><span class="line">                sb.append(ch);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 原字符转义，例如ch为&amp;等价于正则表达式\&amp;</span></span><br><span class="line">                sb.append(<span class="string">&#x27;\\&#x27;</span>).append(ch);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 正则表达式的结尾</span></span><br><span class="line">        sb.append(<span class="string">&#x27;$&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> Pattern.compile(sb.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compareTo</span><span class="params">(AbstractMapping o)</span> &#123;</span><br><span class="line">        <span class="comment">// 1.长路径的优先级小，自然排序是靠前排放，符合最长前缀匹配原则</span></span><br><span class="line">        <span class="comment">// 2.&quot;/&quot;和&quot;*&quot;的优先级最高，自然排序放在最后，处理都不匹配的情况</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">cmp</span> <span class="operator">=</span> <span class="built_in">this</span>.priority() - o.priority();</span><br><span class="line">        <span class="keyword">if</span> (cmp == <span class="number">0</span>) &#123;</span><br><span class="line">            cmp = <span class="built_in">this</span>.url.compareTo(o.url);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> cmp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 满足URI路径的最长前缀匹配</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">priority</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.url.equals(<span class="string">&quot;/&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> Integer.MAX_VALUE;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.url.startsWith(<span class="string">&quot;*&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> Integer.MAX_VALUE - <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">100000</span> - <span class="built_in">this</span>.url.length();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServletMapping</span> <span class="keyword">extends</span> <span class="title class_">AbstractMapping</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Servlet servlet;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ServletMapping</span><span class="params">(String urlPattern, Servlet servlet)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(urlPattern);</span><br><span class="line">        <span class="built_in">this</span>.servlet = servlet;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来实现<code>ServletContext</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServletContextImpl</span> <span class="keyword">implements</span> <span class="title class_">ServletContext</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> List&lt;ServletMapping&gt; servletMappings = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个数据结构足够能让我们实现根据请求路径路由到某个特定的Servlet：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServletContextImpl</span> <span class="keyword">implements</span> <span class="title class_">ServletContext</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// HTTP请求处理入口:</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="comment">// 请求路径:</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> request.getRequestURI();</span><br><span class="line">        <span class="comment">// 搜索Servlet:</span></span><br><span class="line">        <span class="type">Servlet</span> <span class="variable">servlet</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (ServletMapping mapping : <span class="built_in">this</span>.servletMappings) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mapping.matches(path)) &#123;</span><br><span class="line">                <span class="comment">// 路径匹配:</span></span><br><span class="line">                servlet = mapping.servlet;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (servlet == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 未匹配到任何Servlet显示404 Not Found:</span></span><br><span class="line">            <span class="type">PrintWriter</span> <span class="variable">pw</span> <span class="operator">=</span> response.getWriter();</span><br><span class="line">            pw.write(<span class="string">&quot;&lt;h1&gt;404 Not Found&lt;/h1&gt;&lt;p&gt;No mapping for URL: &quot;</span> + path + <span class="string">&quot;&lt;/p&gt;&quot;</span>);</span><br><span class="line">            pw.close();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 由Servlet继续处理请求:</span></span><br><span class="line">        servlet.service(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样我们就实现了<code>ServletContext</code>！</p>
<p>不过，细心的同学会发现，我们编写的两个Servlet：<code>IndexServlet</code>和<code>HelloServlet</code>，还没有被添加到<code>ServletContext</code>中。那么问题来了：Servlet在什么时候被初始化？</p>
<p>答案是在创建<code>ServletContext</code>实例后，就立刻初始化所有的Servlet。我们编写一个<code>initialize()</code>方法，用于初始化Servlet：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServletContextImpl</span> <span class="keyword">implements</span> <span class="title class_">ServletContext</span> &#123;</span><br><span class="line">    Map&lt;String, ServletRegistrationImpl&gt; servletRegistrations = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    List&lt;ServletMapping&gt; servletMappings = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initialize</span><span class="params">(List&lt;Class&lt;?&gt;&gt; servletClasses)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (Class&lt;?&gt; c : servletClasses) &#123;</span><br><span class="line">            <span class="type">WebServlet</span> <span class="variable">ws</span> <span class="operator">=</span> c.getAnnotation(WebServlet.class);</span><br><span class="line">            <span class="comment">// @WebServlet注解标注的Servlet会被注册处理</span></span><br><span class="line">            <span class="keyword">if</span> (ws != <span class="literal">null</span>) &#123;</span><br><span class="line">                logger.info(<span class="string">&quot;auto register @WebServlet: &#123;&#125;&quot;</span>, c.getName());</span><br><span class="line">                <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                Class&lt;? <span class="keyword">extends</span> <span class="title class_">Servlet</span>&gt; clazz = (Class&lt;? <span class="keyword">extends</span> <span class="title class_">Servlet</span>&gt;) c;</span><br><span class="line">                <span class="comment">// 注册的Servlet的名称默认是类名首字母小写的形式，如果@WebServlet注解设置了name参数则以该参数值为准</span></span><br><span class="line">                ServletRegistration.<span class="type">Dynamic</span> <span class="variable">registration</span> <span class="operator">=</span> <span class="built_in">this</span>.addServlet(AnnoUtils.getServletName(clazz), clazz);</span><br><span class="line">                <span class="comment">// 添加映射的请求路径</span></span><br><span class="line">                registration.addMapping(AnnoUtils.getServletUrlPatterns(clazz));</span><br><span class="line">                <span class="comment">// 可以省略，因为本项目Servlet实现不支持initParameter参数功能，因为用处不大</span></span><br><span class="line">                registration.setInitParameters(AnnoUtils.getServletInitParams(clazz));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// init servlets:</span></span><br><span class="line">        <span class="keyword">for</span> (String name : <span class="built_in">this</span>.servletRegistrations.keySet()) &#123;</span><br><span class="line">            <span class="type">ServletRegistrationImpl</span> <span class="variable">registration</span> <span class="operator">=</span> <span class="built_in">this</span>.servletRegistrations.get(name);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 初始化Servlet</span></span><br><span class="line">                registration.servlet.init(registration.getServletConfig());</span><br><span class="line">                <span class="comment">// servletMappings中添加Servlet路由信息</span></span><br><span class="line">                <span class="keyword">for</span> (String urlPattern : registration.getMappings()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (urlPattern.equals(<span class="string">&quot;/&quot;</span>)) &#123;</span><br><span class="line">                        <span class="comment">// &quot;/&quot;对应的Servlet处理所有匹配失败的情况包括&quot;/&quot;本身</span></span><br><span class="line">                        <span class="built_in">this</span>.servletMappings.add(<span class="keyword">new</span> <span class="title class_">ServletMapping</span>(<span class="string">&quot;*&quot;</span>, registration.servlet));</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="built_in">this</span>.servletMappings.add(<span class="keyword">new</span> <span class="title class_">ServletMapping</span>(urlPattern, registration.servlet));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// Servlet注册完成</span></span><br><span class="line">                registration.initialized = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ServletException e) &#123;</span><br><span class="line">                logger.error(<span class="string">&quot;init servlet failed: &quot;</span> + name + <span class="string">&quot; / &quot;</span> + registration.servlet.getClass().getName(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// important: sort mappings:</span></span><br><span class="line">        <span class="comment">// 排序后长路径的Servlet映射靠前，优先最长前缀匹配</span></span><br><span class="line">        <span class="comment">// 例如对于/test/hello请求来说:/test/hello的Servlet &gt; /test的Servlet &gt; /的Servlet</span></span><br><span class="line">        Collections.sort(<span class="built_in">this</span>.servletMappings);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ServletRegistration.Dynamic <span class="title function_">addServlet</span><span class="params">(String name, Class&lt;? extends Servlet&gt; clazz)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (clazz == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;class is null.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Servlet</span> <span class="variable">servlet</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            servlet = createInstance(clazz);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ServletException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> addServlet(name, servlet);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ServletRegistration.Dynamic <span class="title function_">addServlet</span><span class="params">(String name, Servlet servlet)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (name == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;name is null.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (servlet == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;servlet is null.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">ServletRegistrationImpl</span> <span class="variable">registration</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServletRegistrationImpl</span>(<span class="built_in">this</span>, name, servlet);</span><br><span class="line">        <span class="built_in">this</span>.servletRegistrations.put(name, registration);</span><br><span class="line">        <span class="keyword">return</span> registration;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getContextPath</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// only support root context path:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ServletContext <span class="title function_">getContext</span><span class="params">(String uripath)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;&quot;</span>.equals(uripath)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// all others are not exist:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ServletContext也不支持初始化参数，因为也不是很常用，没必要实现</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getInitParameter</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="comment">// no init parameters:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Enumeration&lt;String&gt; <span class="title function_">getInitParameterNames</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// no init parameters:</span></span><br><span class="line">        <span class="keyword">return</span> Collections.emptyEnumeration();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">setInitParameter</span><span class="params">(String name, String value)</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedOperationException</span>(<span class="string">&quot;setInitParameter&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Servlet API version: 6.0.0</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getMajorVersion</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">6</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getMinorVersion</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getEffectiveMajorVersion</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">6</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getEffectiveMinorVersion</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从Servlet 3.0规范开始，我们必须要提供<code>addServlet()</code>动态添加一个Servlet，并且返回<code>ServletRegistration.Dynamic</code>，因此，我们在<code>initialize()</code>方法中调用<code>addServlet()</code>，完成所有Servlet的创建和初始化。上面的代码中出现了注解工具类<code>AnnoUtils</code>和Servlet注册所需的<code>ServletRegistrationImpl</code>，注解工具类的功能比较简单，就是根据用户Sevlet实现类及其@WebServlet注解完成一些信息解析工作，例如获取Servlet名称、获取Servlet的映射路径集合等等，我们重点看一下<code>ServletRegistrationImpl</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServletRegistrationImpl</span> <span class="keyword">implements</span> <span class="title class_">ServletRegistration</span>.Dynamic &#123;</span><br><span class="line">	<span class="comment">// 容器上下文</span></span><br><span class="line">    <span class="keyword">final</span> ServletContext servletContext;</span><br><span class="line">    <span class="comment">// Servlet名称</span></span><br><span class="line">    <span class="keyword">final</span> String name;</span><br><span class="line">    <span class="comment">// Servlet实例</span></span><br><span class="line">    <span class="keyword">final</span> Servlet servlet;</span><br><span class="line">    <span class="comment">// 映射路径集合</span></span><br><span class="line">    <span class="keyword">final</span> List&lt;String&gt; urlPatterns = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(<span class="number">4</span>);</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 注册尚未结束</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">initialized</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ServletRegistrationImpl</span><span class="params">(ServletContext servletContext, String name, Servlet servlet)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.servletContext = servletContext;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.servlet = servlet;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ServletConfig <span class="title function_">getServletConfig</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServletConfig</span>() &#123;</span><br><span class="line">            <span class="comment">// Servlet的名称</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> String <span class="title function_">getServletName</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> ServletRegistrationImpl.<span class="built_in">this</span>.name;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Servlet的容器上下文</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> ServletContext <span class="title function_">getServletContext</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> ServletRegistrationImpl.<span class="built_in">this</span>.servletContext;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Servlet不支持initParameter参数功能</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> String <span class="title function_">getInitParameter</span><span class="params">(String name)</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Servlet不支持initParameter参数功能</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Enumeration&lt;String&gt; <span class="title function_">getInitParameterNames</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getClassName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> servlet.getClass().getName();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Set&lt;String&gt; <span class="title function_">addMapping</span><span class="params">(String... urlPatterns)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (urlPatterns == <span class="literal">null</span> || urlPatterns.length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Missing urlPatterns.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 添加url路径映射</span></span><br><span class="line">        <span class="built_in">this</span>.urlPatterns.addAll(Arrays.asList(urlPatterns));</span><br><span class="line">        <span class="comment">// 返回冲突的url路径，本项目的简单实现不会检测url路径是否冲突，例如IndexServlet的映射路径&quot;/index&quot;与HelloServlet的映射路径&quot;/index&quot;不会被认定为冲突，默认程序员不会写这种代码</span></span><br><span class="line">        <span class="keyword">return</span> Set.of();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Collection&lt;String&gt; <span class="title function_">getMappings</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.urlPatterns;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 未实现的方法...</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后我们修改<code>HttpConnector</code>，实例化<code>ServletContextImpl</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpConnector</span> <span class="keyword">implements</span> <span class="title class_">HttpHandler</span> &#123;</span><br><span class="line">    <span class="comment">// 持有ServletContext实例:</span></span><br><span class="line">    <span class="keyword">final</span> ServletContextImpl servletContext;</span><br><span class="line">    <span class="keyword">final</span> HttpServer httpServer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">HttpConnector</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 创建ServletContext:</span></span><br><span class="line">        <span class="built_in">this</span>.servletContext = <span class="keyword">new</span> <span class="title class_">ServletContextImpl</span>();</span><br><span class="line">        <span class="comment">// 初始化Servlet:</span></span><br><span class="line">        <span class="built_in">this</span>.servletContext.initialize(List.of(IndexServlet.class, HelloServlet.class));</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(HttpExchange exchange)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">adapter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpExchangeAdapter</span>(exchange);</span><br><span class="line">        <span class="type">var</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpServletRequestImpl</span>(adapter);</span><br><span class="line">        <span class="type">var</span> <span class="variable">response</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpServletResponseImpl</span>(adapter);</span><br><span class="line">        <span class="comment">// process:</span></span><br><span class="line">        <span class="built_in">this</span>.servletContext.process(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/../../../../../../imgs/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/image-20231127132735702.png" alt="image-20231127132735702"></p>
<p>运行服务器，输入<code>http://localhost:8080/</code>，查看<code>IndexServlet</code>的输出：</p>
<p><img src="/../../../../../../imgs/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/image-20231127132833374.png" alt="image-20231127132833374"></p>
<p>输入<code>http://localhost:8080/hello?name=Bob</code>，查看<code>HelloServlet</code>的输出：</p>
<p><img src="/../../../../../../imgs/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/image-20231127132910628.png" alt="image-20231127132910628"></p>
<p>输入错误的路径，存在<code>IndexServlet</code>的路径<code>/</code>默认处理所有不匹配的情况：</p>
<p><img src="/../../../../../../imgs/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/image-20231127133206980.png" alt="image-20231127133206980"></p>
<p>可见，我们已经成功完成了<code>ServletContext</code>和所有Servlet的管理，并实现了正确的路由。</p>
<p>有的同学会问：Servlet本身应该是Web App开发人员实现，而不是由服务器实现。我们在服务器中却写死了两个Servlet，这显然是不合理的。正确的方式是从外部war包加载Servlet，但是这个问题我们放到后面解决。</p>
<h2 id="二、实现FilterChain"><a href="#二、实现FilterChain" class="headerlink" title="二、实现FilterChain"></a>二、实现FilterChain</h2><p>上一节我们实现了<code>ServletContext</code>，并且能够管理所有的Servlet组件。本节我们继续增加对Filter组件的支持。</p>
<p>Filter是Servlet规范中的一个重要组件，它的作用是在HTTP请求到达Servlet之前进行预处理。它可以被一个或多个Filter按照一定的顺序组成一个处理链（FilterChain），用来处理一些公共逻辑，比如打印日志、登录检查等。</p>
<p>Filter还可以有针对性地拦截或者放行HTTP请求，本质上一个<code>FilterChain</code>就是一个<code>责任链模式</code>。在Servlet容器中，处理流程如下：</p>
<p><img src="/../../../../../../imgs/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/image-20231127133339508.png" alt="image-20231127133339508"></p>
<p>这里有几点需要注意：</p>
<ol>
<li>最终处理请求的Servlet是根据请求路径选择的；</li>
<li>Filter链上的Filter是根据请求路径匹配的，可能匹配0个或多个Filter；</li>
<li>匹配的Filter将组成FilterChain进行调用。</li>
</ol>
<p>下面，我们首先将<code>Filter</code>纳入<code>ServletContext</code>中管理。和<code>ServletMapping</code>类似，先定义<code>FilterMapping</code>，它包含一个<code>Filter</code>实例，以及将映射路径编译为正则表达式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AbstractMapping</span> <span class="keyword">implements</span> <span class="title class_">Comparable</span>&lt;AbstractMapping&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Pattern pattern;</span><br><span class="line">    <span class="keyword">final</span> String url;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AbstractMapping</span><span class="params">(String urlPattern)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.url = urlPattern;</span><br><span class="line">        <span class="built_in">this</span>.pattern = buildPattern(urlPattern);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">matches</span><span class="params">(String uri)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> pattern.matcher(uri).matches();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Pattern <span class="title function_">buildPattern</span><span class="params">(String urlPattern)</span> &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(urlPattern.length() + <span class="number">16</span>);</span><br><span class="line">        <span class="comment">// 正则表达式的开头</span></span><br><span class="line">        sb.append(<span class="string">&#x27;^&#x27;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; urlPattern.length(); i++) &#123;</span><br><span class="line">            <span class="type">char</span> <span class="variable">ch</span> <span class="operator">=</span> urlPattern.charAt(i);</span><br><span class="line">            <span class="keyword">if</span> (ch == <span class="string">&#x27;*&#x27;</span>) &#123;</span><br><span class="line">                <span class="comment">// 表示匹配任意字符</span></span><br><span class="line">                sb.append(<span class="string">&quot;.*&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ch &gt;= <span class="string">&#x27;a&#x27;</span> &amp;&amp; ch &lt;= <span class="string">&#x27;z&#x27;</span> || ch &gt;= <span class="string">&#x27;A&#x27;</span> &amp;&amp; ch &lt;= <span class="string">&#x27;Z&#x27;</span> || ch &gt;= <span class="string">&#x27;0&#x27;</span> &amp;&amp; ch &lt;= <span class="string">&#x27;9&#x27;</span>) &#123;</span><br><span class="line">                <span class="comment">// 常规字符保持一致</span></span><br><span class="line">                sb.append(ch);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 原字符转义，例如ch为&amp;等价于正则表达式\&amp;</span></span><br><span class="line">                sb.append(<span class="string">&#x27;\\&#x27;</span>).append(ch);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 正则表达式的结尾</span></span><br><span class="line">        sb.append(<span class="string">&#x27;$&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> Pattern.compile(sb.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compareTo</span><span class="params">(AbstractMapping o)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">cmp</span> <span class="operator">=</span> <span class="built_in">this</span>.priority() - o.priority();</span><br><span class="line">        <span class="keyword">if</span> (cmp == <span class="number">0</span>) &#123;</span><br><span class="line">            cmp = <span class="built_in">this</span>.url.compareTo(o.url);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> cmp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 满足URI路径的最长前缀匹配</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">priority</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.url.equals(<span class="string">&quot;/&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> Integer.MAX_VALUE;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.url.startsWith(<span class="string">&quot;*&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> Integer.MAX_VALUE - <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">100000</span> - <span class="built_in">this</span>.url.length();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FilterMapping</span> <span class="keyword">extends</span> <span class="title class_">AbstractMapping</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Filter filter;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FilterMapping</span><span class="params">(String urlPattern, Filter filter)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(urlPattern);</span><br><span class="line">        <span class="built_in">this</span>.filter = filter;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着，根据Servlet规范，我们需要提供<code>addFilter()</code>动态添加一个<code>Filter</code>，并且返回<code>FilterRegistration.Dynamic</code>，所以需要在<code>ServletContext</code>中实现相关方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServletContextImpl</span> <span class="keyword">implements</span> <span class="title class_">ServletContext</span> &#123;</span><br><span class="line">    Map&lt;String, FilterRegistrationImpl&gt; filterRegistrations = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    List&lt;FilterMapping&gt; filterMappings = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据Class Name添加Filter:</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> FilterRegistration.Dynamic <span class="title function_">addFilter</span><span class="params">(String name, String className)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> addFilter(name, Class.forName(className));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据Class添加Filter:</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> FilterRegistration.Dynamic <span class="title function_">addFilter</span><span class="params">(String name, Class&lt;? extends Filter&gt; clazz)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> addFilter(name, clazz.newInstance());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据Filter实例添加Filter:</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> FilterRegistration.Dynamic <span class="title function_">addFilter</span><span class="params">(String name, Filter filter)</span> &#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">registration</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterRegistrationImpl</span>(<span class="built_in">this</span>, name, filter);</span><br><span class="line">        <span class="built_in">this</span>.filterRegistrations.put(name, registration);</span><br><span class="line">        <span class="keyword">return</span> registration;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再添加一个<code>initFilters()</code>方法用于向容器添加<code>Filter</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServletContextImpl</span> <span class="keyword">implements</span> <span class="title class_">ServletContext</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initFilters</span><span class="params">(List&lt;Class&lt;?&gt;&gt; filterClasses)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (Class&lt;?&gt; c : filterClasses) &#123;</span><br><span class="line">            <span class="comment">// 获取@WebFilter注解:</span></span><br><span class="line">            <span class="type">WebFilter</span> <span class="variable">wf</span> <span class="operator">=</span> c.getAnnotation(WebFilter.class);</span><br><span class="line">            <span class="comment">// 添加Filter:</span></span><br><span class="line">            FilterRegistration.<span class="type">Dynamic</span> <span class="variable">registration</span> <span class="operator">=</span> <span class="built_in">this</span>.addFilter(AnnoUtils.getFilterName(clazz), clazz);</span><br><span class="line">            <span class="comment">// 添加URL映射:</span></span><br><span class="line">            registration.addMappingForUrlPatterns(EnumSet.of(DispatcherType.REQUEST), <span class="literal">true</span>, AnnoUtils.getFilterUrlPatterns(clazz));</span><br><span class="line">            <span class="comment">// 设置初始化参数:</span></span><br><span class="line">            registration.setInitParameters(AnnoUtils.getFilterInitParams(clazz));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (String name : <span class="built_in">this</span>.filterRegistrations.keySet()) &#123;</span><br><span class="line">            <span class="comment">// 依次处理每个FilterRegistration.Dynamic:</span></span><br><span class="line">            <span class="type">var</span> <span class="variable">registration</span> <span class="operator">=</span> <span class="built_in">this</span>.filterRegistrations.get(name);</span><br><span class="line">            <span class="comment">// 调用Filter.init()方法:</span></span><br><span class="line">            registration.filter.init(registration.getFilterConfig());</span><br><span class="line">            <span class="built_in">this</span>.nameToFilters.put(name, registration.filter);</span><br><span class="line">            <span class="comment">// 将Filter定义的每个URL映射编译为正则表达式:</span></span><br><span class="line">            <span class="keyword">for</span> (String urlPattern : registration.getUrlPatternMappings()) &#123;</span><br><span class="line">                <span class="built_in">this</span>.filterMappings.add(<span class="keyword">new</span> <span class="title class_">FilterMapping</span>(urlPattern, registration.filter));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样，我们就完成了对Filter组件的管理。</p>
<p>同样，我们介绍一下上面代码中出现的<code>FilterRegistrationImpl</code>类，与之前说过的<code>ServeletRegistrationImpl</code>非常相似：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FilterRegistrationImpl</span> <span class="keyword">implements</span> <span class="title class_">FilterRegistration</span>.Dynamic &#123;</span><br><span class="line">    <span class="comment">// 容器上下文</span></span><br><span class="line">    <span class="keyword">final</span> ServletContext servletContext;</span><br><span class="line">    <span class="comment">// Filter的名称</span></span><br><span class="line">    <span class="keyword">final</span> String name;</span><br><span class="line">    <span class="comment">// Filter的实例</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Filter filter;</span><br><span class="line">    <span class="comment">// Filter的初始化参数</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">InitParameters</span> <span class="variable">initParameters</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitParameters</span>();</span><br><span class="line">    <span class="comment">// 匹配路径</span></span><br><span class="line">    <span class="keyword">final</span> List&lt;String&gt; urlPatterns = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(<span class="number">4</span>);</span><br><span class="line">    <span class="comment">// Filter注册尚未结束</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="variable">initialized</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FilterRegistrationImpl</span><span class="params">(ServletContext servletContext, String name, Filter filter)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.servletContext = servletContext;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.filter = filter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> FilterConfig <span class="title function_">getFilterConfig</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FilterConfig</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> String <span class="title function_">getFilterName</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> FilterRegistrationImpl.<span class="built_in">this</span>.name;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> ServletContext <span class="title function_">getServletContext</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> FilterRegistrationImpl.<span class="built_in">this</span>.servletContext;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Filter组件支持initParameter参数功能</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> String <span class="title function_">getInitParameter</span><span class="params">(String name)</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> FilterRegistrationImpl.<span class="built_in">this</span>.initParameters.getInitParameter(name);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Filter组件支持initParameter参数功能</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Enumeration&lt;String&gt; <span class="title function_">getInitParameterNames</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> FilterRegistrationImpl.<span class="built_in">this</span>.initParameters.getInitParameterNames();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getClassName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> filter.getClass().getName();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// proxy to InitParameters:</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">setInitParameter</span><span class="params">(String name, String value)</span> &#123;</span><br><span class="line">        checkNotInitialized(<span class="string">&quot;setInitParameter&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.initParameters.setInitParameter(name, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getInitParameter</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.initParameters.getInitParameter(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Set&lt;String&gt; <span class="title function_">setInitParameters</span><span class="params">(Map&lt;String, String&gt; initParameters)</span> &#123;</span><br><span class="line">        checkNotInitialized(<span class="string">&quot;setInitParameter&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.initParameters.setInitParameters(initParameters);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, String&gt; <span class="title function_">getInitParameters</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.initParameters.getInitParameters();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAsyncSupported</span><span class="params">(<span class="type">boolean</span> isAsyncSupported)</span> &#123;</span><br><span class="line">        checkNotInitialized(<span class="string">&quot;setInitParameter&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (isAsyncSupported) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedOperationException</span>(<span class="string">&quot;Async is not supported.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addMappingForServletNames</span><span class="params">(EnumSet&lt;DispatcherType&gt; dispatcherTypes, <span class="type">boolean</span> isMatchAfter, String... servletNames)</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedOperationException</span>(<span class="string">&quot;addMappingForServletNames&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addMappingForUrlPatterns</span><span class="params">(EnumSet&lt;DispatcherType&gt; dispatcherTypes, <span class="type">boolean</span> isMatchAfter, String... urlPatterns)</span> &#123;</span><br><span class="line">        checkNotInitialized(<span class="string">&quot;addMappingForUrlPatterns&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!dispatcherTypes.contains(DispatcherType.REQUEST) || dispatcherTypes.size() != <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Only support DispatcherType.REQUEST.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (urlPatterns == <span class="literal">null</span> || urlPatterns.length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Missing urlPatterns.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (String urlPattern : urlPatterns) &#123;</span><br><span class="line">            <span class="built_in">this</span>.urlPatterns.add(urlPattern);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Collection&lt;String&gt; <span class="title function_">getServletNameMappings</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> List.of();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Collection&lt;String&gt; <span class="title function_">getUrlPatternMappings</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.urlPatterns;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">checkNotInitialized</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.initialized) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Cannot call &quot;</span> + name + <span class="string">&quot; after initialization.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下一步，是改造<code>process()</code>方法，把原来直接把请求扔给<code>Servlet</code>处理，改成先匹配<code>Filter</code>，处理后再扔给最终的<code>Servlet</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServletContextImpl</span> <span class="keyword">implements</span> <span class="title class_">ServletContext</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="comment">// 获取请求路径:</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> request.getRequestURI();</span><br><span class="line">        <span class="comment">// 查找Servlet:</span></span><br><span class="line">        <span class="type">Servlet</span> <span class="variable">servlet</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (ServletMapping mapping : <span class="built_in">this</span>.servletMappings) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mapping.matches(path)) &#123;</span><br><span class="line">                servlet = mapping.servlet;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (servlet == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 404错误:</span></span><br><span class="line">            <span class="type">PrintWriter</span> <span class="variable">pw</span> <span class="operator">=</span> response.getWriter();</span><br><span class="line">            pw.write(<span class="string">&quot;&lt;h1&gt;404 Not Found&lt;/h1&gt;&lt;p&gt;No mapping for URL: &quot;</span> + path + <span class="string">&quot;&lt;/p&gt;&quot;</span>);</span><br><span class="line">            pw.close();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 查找Filter:</span></span><br><span class="line">        List&lt;Filter&gt; enabledFilters = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (FilterMapping mapping : <span class="built_in">this</span>.filterMappings) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mapping.matches(path)) &#123;</span><br><span class="line">                enabledFilters.add(mapping.filter);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Filter[] filters = enabledFilters.toArray(Filter[]::<span class="keyword">new</span>);</span><br><span class="line">        <span class="comment">// 构造FilterChain实例:</span></span><br><span class="line">        <span class="type">FilterChain</span> <span class="variable">chain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterChainImpl</span>(filters, servlet);</span><br><span class="line">        <span class="comment">// 由FilterChain处理:</span></span><br><span class="line">        chain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意上述<code>FilterChain</code>不仅包含一个<code>Filter[]</code>数组，还包含一个<code>Servlet</code>，这样我们调用<code>chain.doFilter()</code>时，在<code>FilterChain</code>中最后一个处理请求的就是<code>Servlet</code>，这样设计可以简化我们实现<code>FilterChain</code>的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FilterChainImpl</span> <span class="keyword">implements</span> <span class="title class_">FilterChain</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> Filter[] filters;</span><br><span class="line">    <span class="keyword">final</span> Servlet servlet;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> total; <span class="comment">// Filter总数量</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">0</span>; <span class="comment">// 下一个要处理的Filter[index]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FilterChainImpl</span><span class="params">(Filter[] filters, Servlet servlet)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.filters = filters;</span><br><span class="line">        <span class="built_in">this</span>.servlet = servlet;</span><br><span class="line">        <span class="built_in">this</span>.total = filters.length;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="keyword">if</span> (index &lt; total) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">current</span> <span class="operator">=</span> index;</span><br><span class="line">            index++;</span><br><span class="line">            <span class="comment">// 调用下一个Filter处理:</span></span><br><span class="line">            filters[current].doFilter(request, response, <span class="built_in">this</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 调用Servlet处理:</span></span><br><span class="line">            servlet.service(request, response);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意<code>FilterChain</code>是一个递归调用，因为在执行<code>Filter.doFilter()</code>时，需要把<code>FilterChain</code>自身传进去，在执行<code>Filter.doFilter()</code>之前，就要把<code>index</code>调整到正确的值。</p>
<p>我们编写两个测试用的Filter：</p>
<ul>
<li>LogFilter：匹配<code>/*</code>，打印请求方法、路径等信息；</li>
<li>HelloFilter：匹配<code>/hello</code>，根据请求参数决定放行还是返回403错误。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebFilter(urlPatterns = &quot;/*&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogFilter</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">req</span> <span class="operator">=</span> (HttpServletRequest) request;</span><br><span class="line">        logger.info(<span class="string">&quot;&#123;&#125;: &#123;&#125;&quot;</span>, req.getMethod(), req.getRequestURI());</span><br><span class="line">        chain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@WebFilter(urlPatterns = &quot;/hello&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloFilter</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(getClass());</span><br><span class="line">    Set&lt;String&gt; names = Set.of(<span class="string">&quot;Bob&quot;</span>, <span class="string">&quot;Alice&quot;</span>, <span class="string">&quot;Tom&quot;</span>, <span class="string">&quot;Jerry&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">req</span> <span class="operator">=</span> (HttpServletRequest) request;</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">        logger.info(<span class="string">&quot;Check parameter name = &#123;&#125;&quot;</span>, name);</span><br><span class="line">        <span class="keyword">if</span> (name != <span class="literal">null</span> &amp;&amp; names.contains(name)) &#123;</span><br><span class="line">            chain.doFilter(request, response);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            logger.warn(<span class="string">&quot;Access denied: name = &#123;&#125;&quot;</span>, name);</span><br><span class="line">            <span class="type">HttpServletResponse</span> <span class="variable">resp</span> <span class="operator">=</span> (HttpServletResponse) response;</span><br><span class="line">            resp.sendError(<span class="number">403</span>, <span class="string">&quot;Forbidden&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/../../../../../../imgs/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/image-20231127140913723.png" alt="image-20231127140913723"></p>
<p>在初始化ServletContextImpl时将Filter加进去，先测试<code>http://localhost:8080/</code>：</p>
<p><img src="/../../../../../../imgs/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/image-20231127140954473.png" alt="image-20231127140954473"></p>
<p>观察后台输出，<code>LogFilter</code>应该起作用：</p>
<p><img src="/../../../../../../imgs/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/image-20231127141041731.png" alt="image-20231127141041731"></p>
<p>再测试<code>http://localhost:8080/hello?name=Bob</code>：</p>
<p><img src="/../../../../../../imgs/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/image-20231127141115190.png" alt="image-20231127141115190"></p>
<p>观察后台输出，<code>HelloFilter</code>和<code>LogFilter</code>应该起作用：</p>
<p><img src="/../../../../../../imgs/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/image-20231127141201376.png" alt="image-20231127141201376"></p>
<p>最后测试<code>http://localhost:8080/hello?name=Jim</code>：</p>
<p><img src="/../../../../../../imgs/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/image-20231127141308161.png" alt="image-20231127141308161"></p>
<p>可以看到，<code>HelloFilter</code>拦截了请求，返回403错误，最终的<code>HelloServlet</code>并没有处理该请求。</p>
<p>现在，我们就成功地在<code>ServletContext</code>中实现了对<code>Filter</code>的管理，以及根据每个请求，构造对应的<code>FilterChain</code>来处理请求。目前还有几个小问题：</p>
<p>一是和Servlet一样，Filter本身应该是Web App开发人员实现，而不是由服务器实现。我们在在服务器中写死了两个Filter，这个问题后续解决；</p>
<p>二是Servlet规范并没有规定多个Filter应该如何排序，我们在实现时也没有对Filter进行排序。如果要按固定顺序给Filter排序，从Servlet规范来说怎么排序都可以，通常是按<code>@WebFilter</code>定义的<code>filterName</code>进行排序，Spring Boot提供的一个<code>FilterRegistrationBean</code>允许开发人员自己定义Filter的顺序。</p>
<h2 id="三、实现HttpSession"><a href="#三、实现HttpSession" class="headerlink" title="三、实现HttpSession"></a>三、实现HttpSession</h2><p>HttpSession是Java Web App的一种机制，用于在客户端和服务器之间维护会话状态信息。</p>
<p>当客户端第一次请求Web应用程序时，服务器会为该客户端创建一个唯一的Session ID，该ID本质上是一个随机字符串，然后，将该ID存储在客户端的一个名为<code>JSESSIONID</code>的Cookie中。与此同时，服务器会在内存中创建一个<code>HttpSession</code>对象，与Session ID关联，用于存储与该客户端相关的状态信息。</p>
<p>当客户端发送后续请求时，服务器根据客户端发送的名为<code>JSESSIONID</code>的Cookie中获得Session ID，然后查找对应的<code>HttpSession</code>对象，并从中读取或继续写入状态信息。</p>
<p>Session主要用于维护一个客户端的会话状态。通常，用户成功登录后，可以通过如下代码创建一个新的<code>HttpSession</code>，并将用户ID、用户名等信息放入<code>HttpSession</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebServlet(urlPatterns = &quot;/login&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;username&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;password&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (loginOk(username, password)) &#123;</span><br><span class="line">            <span class="comment">// 登录成功，获取Session:</span></span><br><span class="line">            <span class="type">HttpSession</span> <span class="variable">session</span> <span class="operator">=</span> req.getSession();</span><br><span class="line">            <span class="comment">// 将用户名放入Session:</span></span><br><span class="line">            session.setAttribute(<span class="string">&quot;username&quot;</span>, username);</span><br><span class="line">            <span class="comment">// 返回首页:</span></span><br><span class="line">            resp.sendRedirect(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 登录失败:</span></span><br><span class="line">            resp.sendRedirect(<span class="string">&quot;/error&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在其他页面，可以随时获取<code>HttpSession</code>并取出用户信息，然后在页面展示给用户：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebServlet(urlPatterns = &quot;/&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IndexServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="comment">// 获取Session:</span></span><br><span class="line">        <span class="type">HttpSession</span> <span class="variable">session</span> <span class="operator">=</span> req.getSession();</span><br><span class="line">        <span class="comment">// 从Session中取出用户名:</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> (String) session.getAttribute(<span class="string">&quot;username&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (username == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 未获取到用户名，说明未登录:</span></span><br><span class="line">            resp.sendRedirect(<span class="string">&quot;/login&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 获取到用户名，说明已登录:</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">html</span> <span class="operator">=</span> <span class="string">&quot;&lt;p&gt;Welcome, &quot;</span> + username + <span class="string">&quot;!&lt;/p&gt;&quot;</span>;</span><br><span class="line">            resp.setContentType(<span class="string">&quot;text/html&quot;</span>);</span><br><span class="line">            <span class="type">PrintWriter</span> <span class="variable">pw</span> <span class="operator">=</span> resp.getWriter();</span><br><span class="line">            pw.write(html);</span><br><span class="line">            pw.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当用户登出时，需要调用<code>HttpSession</code>的<code>invalidate()</code>方法，让会话失效，这样，用户将重新回到未登录状态，因为后续调用<code>req.getSession()</code>将返回一个新的<code>HttpSession</code>，从这个新的<code>HttpSession</code>取出的<code>username</code>将是<code>null</code>。</p>
<p>HttpSession的生命周期如下所示：</p>
<ul>
<li><p>第一次调用<code>req.getSession()</code>时，服务器会为该客户端创建一个新的<code>HttpSession</code>对象；</p>
</li>
<li><p>后续调用<code>req.getSession()</code>时，服务器会返回与之关联的<code>HttpSession</code>对象；</p>
</li>
<li><p>调用<code>req.getSession().invalidate()</code>时，服务器会销毁该客户端对应的<code>HttpSession</code>对象；</p>
</li>
<li><p>当客户端一段时间内没有新的请求，服务器会根据Session超时自动销毁超时的<code>HttpSession</code>对象。</p>
</li>
</ul>
<p><code>HttpSession</code>是一个接口，Java的Web应用调用<code>HttpServletRequest</code>的<code>getSession()</code>方法时，需要返回一个<code>HttpSession</code>的实现类。</p>
<p>了解了以上关于<code>HttpSession</code>的相关规范后，我们就可以开始实现对<code>HttpSession</code>的支持。</p>
<p>首先，我们需要一个<code>SessionManager</code>，用来管理所有的Session：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SessionManager</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(getClass());</span><br><span class="line">    <span class="comment">// 引用ServletContext:</span></span><br><span class="line">    <span class="keyword">final</span> ServletContextImpl servletContext;</span><br><span class="line">    <span class="comment">// 持有SessionID -&gt; Session:</span></span><br><span class="line">    <span class="keyword">final</span> Map&lt;String, HttpSessionImpl&gt; sessions = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">// Session默认过期时间(秒):</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> inactiveInterval;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SessionManager</span><span class="params">(ServletContextImpl servletContext, <span class="type">int</span> interval)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.servletContext = servletContext;</span><br><span class="line">        <span class="built_in">this</span>.inactiveInterval = interval;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="built_in">this</span>, <span class="string">&quot;Session-Cleanup-Thread&quot;</span>);</span><br><span class="line">        <span class="comment">// Session过期清理线程是守护线程</span></span><br><span class="line">        t.setDaemon(<span class="literal">true</span>);</span><br><span class="line">        t.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据SessionID获取一个Session:</span></span><br><span class="line">    <span class="keyword">public</span> HttpSession <span class="title function_">getSession</span><span class="params">(String sessionId)</span> &#123;</span><br><span class="line">        <span class="type">HttpSessionImpl</span> <span class="variable">session</span> <span class="operator">=</span> sessions.get(sessionId);</span><br><span class="line">        <span class="keyword">if</span> (session == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Session未找到，创建一个新的Session:</span></span><br><span class="line">            session = <span class="keyword">new</span> <span class="title class_">HttpSessionImpl</span>(<span class="built_in">this</span>.servletContext, sessionId, inactiveInterval);</span><br><span class="line">            sessions.put(sessionId, session);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Session已存在，更新最后访问时间:</span></span><br><span class="line">            session.lastAccessedTime = System.currentTimeMillis();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> session;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 删除Session:</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">(HttpSession session)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.sessions.remove(session.getId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 每隔一分钟扫描一次，清理过期session</span></span><br><span class="line">                Thread.sleep(<span class="number">60_000L</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">long</span> <span class="variable">now</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">            <span class="keyword">for</span> (String sessionId : sessions.keySet()) &#123;</span><br><span class="line">                <span class="type">HttpSession</span> <span class="variable">session</span> <span class="operator">=</span> sessions.get(sessionId);</span><br><span class="line">                <span class="keyword">if</span> (session.getLastAccessedTime() + session.getMaxInactiveInterval() * <span class="number">1000L</span> &lt; now) &#123;</span><br><span class="line">                    logger.warn(<span class="string">&quot;remove expired session: &#123;&#125;, last access time: &#123;&#125;&quot;</span>, sessionId, DateUtils.formatDateTimeGMT(session.getLastAccessedTime()));</span><br><span class="line">                    session.invalidate();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>SessionManager</code>由<code>ServletContextImpl</code>持有唯一实例。</p>
<p>再编写一个<code>HttpSession</code>的实现类<code>HttpSessionImpl</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpSessionImpl</span> <span class="keyword">implements</span> <span class="title class_">HttpSession</span> &#123;</span><br><span class="line">    ServletContextImpl servletContext; <span class="comment">// ServletContext</span></span><br><span class="line">    String sessionId; <span class="comment">// SessionID</span></span><br><span class="line">    <span class="type">int</span> maxInactiveInterval; <span class="comment">// 过期时间(s)</span></span><br><span class="line">    <span class="type">long</span> creationTime; <span class="comment">// 创建时间(ms)</span></span><br><span class="line">    <span class="type">long</span> lastAccessedTime; <span class="comment">// 最后一次访问时间(ms)</span></span><br><span class="line">    Attributes attributes; <span class="comment">// getAttribute/setAttribute</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后，我们分析一下用户调用Session的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">HttpSession</span> <span class="variable">session</span> <span class="operator">=</span> request.getSession();</span><br><span class="line">session.invalidate();</span><br></pre></td></tr></table></figure>

<p>由于<code>HttpSession</code>是从<code>HttpServletRequest</code>获得的，因此，必须在<code>HttpServletRequestImpl</code>中引用<code>ServletContextImpl</code>，才能访问<code>SessionManager</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpServletRequestImpl</span> <span class="keyword">implements</span> <span class="title class_">HttpServletRequest</span> &#123;</span><br><span class="line">    <span class="comment">// 引用ServletContextImpl:</span></span><br><span class="line">    ServletContextImpl servletContext;</span><br><span class="line">    <span class="comment">// 引用HttpServletResponse:</span></span><br><span class="line">    HttpServletResponse response;</span><br><span class="line">    <span class="comment">// 请求头信息：</span></span><br><span class="line">    <span class="keyword">final</span> HttpHeaders headers;</span><br><span class="line">    <span class="comment">// 请求参数信息：</span></span><br><span class="line">    <span class="keyword">final</span> Parameters parameters;</span><br><span class="line">    <span class="comment">// 记录request对象的getInputStream方法和getReader方法的使用情况：</span></span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">inputCalled</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">HttpServletRequestImpl</span><span class="params">(ServletContextImpl servletContext, HttpExchangeRequest exchangeRequest, HttpServletResponse response)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.servletContext = servletContext;</span><br><span class="line">        <span class="built_in">this</span>.exchangeRequest = exchangeRequest;</span><br><span class="line">        <span class="built_in">this</span>.response = response;</span><br><span class="line">        <span class="built_in">this</span>.headers = <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>(exchangeRequest.getRequestHeaders());</span><br><span class="line">        <span class="built_in">this</span>.parameters = <span class="keyword">new</span> <span class="title class_">Parameters</span>(exchangeRequest, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ServletInputStream <span class="title function_">getInputStream</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 字节输入流只能调用一次，不能重复打开</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.inputCalled == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.inputCalled = Boolean.TRUE;</span><br><span class="line">            <span class="comment">// ServletInputStreamImpl内部维持了输入字节缓冲区和读取位置</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServletInputStreamImpl</span>(<span class="built_in">this</span>.exchangeRequest.getRequestBody());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Cannot reopen input stream after &quot;</span> + (<span class="built_in">this</span>.inputCalled ? <span class="string">&quot;getInputStream()&quot;</span> : <span class="string">&quot;getReader()&quot;</span>) + <span class="string">&quot; was called.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> BufferedReader <span class="title function_">getReader</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 字节输入流只能调用一次，不能重复打开</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.inputCalled == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.inputCalled = Boolean.FALSE;</span><br><span class="line">            <span class="comment">// 返回请求的字符输入流</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(<span class="built_in">this</span>.exchangeRequest.getRequestBody()), StandardCharsets.UTF_8));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Cannot reopen input stream after &quot;</span> + (<span class="built_in">this</span>.inputCalled ? <span class="string">&quot;getInputStream()&quot;</span> : <span class="string">&quot;getReader()&quot;</span>) + <span class="string">&quot; was called.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> HttpSession <span class="title function_">getSession</span><span class="params">(<span class="type">boolean</span> create)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">sessionId</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">// 获取所有Cookie:</span></span><br><span class="line">        Cookie[] cookies = getCookies();</span><br><span class="line">        <span class="keyword">if</span> (cookies != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 查找JSESSIONID:</span></span><br><span class="line">            <span class="keyword">for</span> (Cookie cookie : cookies) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">&quot;JSESSIONID&quot;</span>.equals(cookie.getName())) &#123;</span><br><span class="line">                    <span class="comment">// 拿到Session ID:</span></span><br><span class="line">                    sessionId = cookie.getValue();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 未获取到SessionID，且create=false，返回null:</span></span><br><span class="line">        <span class="keyword">if</span> (sessionId == <span class="literal">null</span> &amp;&amp; !create) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 未获取到SessionID，但create=true，创建新的Session:</span></span><br><span class="line">        <span class="keyword">if</span> (sessionId == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 如果Header已经发送，则无法创建Session，因为无法添加Cookie:</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.response.isCommitted()) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Cannot create session for response is commited.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 创建随机字符串作为SessionID:</span></span><br><span class="line">            sessionId = UUID.randomUUID().toString();</span><br><span class="line">            <span class="comment">// 构造一个名为JSESSIONID的Cookie:</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">cookieValue</span> <span class="operator">=</span> <span class="string">&quot;JSESSIONID=&quot;</span> + sessionId + <span class="string">&quot;; Path=/; SameSite=Strict; HttpOnly&quot;</span>;</span><br><span class="line">            <span class="comment">// 添加到HttpServletResponse的Header:</span></span><br><span class="line">            <span class="built_in">this</span>.response.addHeader(<span class="string">&quot;Set-Cookie&quot;</span>, cookieValue);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 返回一个Session对象:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.servletContext.sessionManager.getSession(sessionId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> HttpSession <span class="title function_">getSession</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> getSession(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Cookie[] getCookies() &#123;</span><br><span class="line">        <span class="comment">// 获取请求头中Cookie对应的字符串信息</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">cookieValue</span> <span class="operator">=</span> <span class="built_in">this</span>.getHeader(<span class="string">&quot;Cookie&quot;</span>);</span><br><span class="line">        <span class="comment">// 解析字符串</span></span><br><span class="line">        <span class="keyword">return</span> HttpUtils.parseCookies(cookieValue);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getHeader</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.headers.getHeader(name);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对<code>HttpServletRequestImpl</code>的改造主要是加入了<code>ServletContextImpl</code>和<code>HttpServletResponse</code>的引用：可以通过前者访问到<code>SessionManager</code>，而创建的新的SessionID需要通过后者把Cookie发送到客户端，因此，在<code>HttpConnector</code>中，做相应的修改如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpConnector</span> <span class="keyword">implements</span> <span class="title class_">HttpHandler</span> &#123;</span><br><span class="line">    <span class="comment">// 过期时间设置为600秒</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">SessionManager</span> <span class="variable">sessionManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SessionManager</span>(<span class="built_in">this</span>, <span class="number">600</span>);</span><br><span class="line">    ...</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(HttpExchange exchange)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">adapter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpExchangeAdapter</span>(exchange);</span><br><span class="line">        <span class="type">var</span> <span class="variable">response</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpServletResponseImpl</span>(adapter);</span><br><span class="line">        <span class="comment">// 创建Request时，需要引用servletContext和response:</span></span><br><span class="line">        <span class="type">var</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpServletRequestImpl</span>(<span class="built_in">this</span>.servletContext, adapter, response);</span><br><span class="line">        <span class="comment">// process:</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.servletContext.process(request, response);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当用户调用<code>session.invalidate()</code>时，要让Session失效，就需要从<code>SessionManager</code>中移除：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpSessionImpl</span> <span class="keyword">implements</span> <span class="title class_">HttpSession</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invalidate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 从SessionManager中移除:</span></span><br><span class="line">        <span class="built_in">this</span>.servletContext.sessionManager.remove(<span class="built_in">this</span>);</span><br><span class="line">        <span class="built_in">this</span>.sessionId = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后，我们还需要实现Session的自动过期。由于我们管理的Session实际上是以<code>Map&lt;String, HttpSession&gt;</code>存储的，所以，让Session自动过期就是定期扫描所有的Session，然后根据最后一次访问时间将过期的Session自动删除。给<code>SessionManager</code>加一个<code>Runnable</code>接口，并启动一个Daemon线程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SessionManager</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SessionManager</span><span class="params">(ServletContextImpl servletContext, <span class="type">int</span> interval)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// 启动Daemon线程:</span></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="built_in">this</span>);</span><br><span class="line">        t.setDaemon(<span class="literal">true</span>);</span><br><span class="line">        t.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 扫描线程:</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="comment">// 每60秒扫描一次:</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">60_000L</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 当前时间:</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">now</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">            <span class="comment">// 遍历Session:</span></span><br><span class="line">            <span class="keyword">for</span> (String sessionId : sessions.keySet()) &#123;</span><br><span class="line">                <span class="type">HttpSession</span> <span class="variable">session</span> <span class="operator">=</span> sessions.get(sessionId);</span><br><span class="line">                <span class="comment">// 判断是否过期:</span></span><br><span class="line">                <span class="keyword">if</span> (session.getLastAccessedTime() + session.getMaxInactiveInterval() * <span class="number">1000L</span> &lt; now) &#123;</span><br><span class="line">                    <span class="comment">// 删除过期的Session:</span></span><br><span class="line">                    logger.warn(<span class="string">&quot;remove expired session: &#123;&#125;, last access time: &#123;&#125;&quot;</span>, sessionId, DateUtils.formatDateTimeGMT(session.getLastAccessedTime()));</span><br><span class="line">                    session.invalidate();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将<code>HttpServletRequest</code>和<code>HttpServletResponse</code>与Cookie相关的实现方法补全，我们就得到了一个基于Cookie的<code>HttpSession</code>实现！</p>
<p>前面介绍过<code>HttpServletRequest</code>，那我们还是说一下<code>HttpServletResponse</code>补全后的内容吧，总体内容跟Request类似，不过Response的字节输出流和字符输出流是可以多次打开的，而且在发送响应前JSESSION对应的Cookie必须先设置好，不能一旦发送响应开始后便不能修改响应头部信息了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpServletResponseImpl</span> <span class="keyword">implements</span> <span class="title class_">HttpServletResponse</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> HttpExchangeResponse exchangeResponse;</span><br><span class="line">    <span class="comment">// 响应头，包含Cookie信息</span></span><br><span class="line">    <span class="keyword">final</span> HttpHeaders headers;</span><br><span class="line">    <span class="comment">// 默认的响应码</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">status</span> <span class="operator">=</span> <span class="number">200</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">bufferSize</span> <span class="operator">=</span> <span class="number">1024</span>;</span><br><span class="line">    <span class="comment">// 记录response的getOutputStream方法和getWriter方法的使用情况</span></span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">callOutput</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// 字节输出流</span></span><br><span class="line">    ServletOutputStream output;</span><br><span class="line">    <span class="comment">// 字符输出流</span></span><br><span class="line">    PrintWriter writer;</span><br><span class="line">    <span class="comment">// 响应内容类型，默认是text/html</span></span><br><span class="line">    String contentType;</span><br><span class="line">    <span class="comment">// 响应内容大小</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">contentLength</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 是否已发送响应的标记</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">committed</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">HttpServletResponseImpl</span><span class="params">(HttpExchangeResponse exchangeResponse)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.exchangeResponse = exchangeResponse;</span><br><span class="line">        <span class="built_in">this</span>.headers = <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>(exchangeResponse.getResponseHeaders());</span><br><span class="line">        <span class="built_in">this</span>.setContentType(<span class="string">&quot;text/html&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ServletOutputStream <span class="title function_">getOutputStream</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 第一次调用</span></span><br><span class="line">        <span class="keyword">if</span> (callOutput == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 开始发生响应，采用分块传输</span></span><br><span class="line">            commitHeaders(<span class="number">0</span>);</span><br><span class="line">            <span class="comment">// ServletOutputStreamImpl维护一个字节输出流</span></span><br><span class="line">            <span class="built_in">this</span>.output = <span class="keyword">new</span> <span class="title class_">ServletOutputStreamImpl</span>(<span class="built_in">this</span>.exchangeResponse.getResponseBody());</span><br><span class="line">            <span class="built_in">this</span>.callOutput = Boolean.TRUE;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.output;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 下一次调用直接使用之前已经创建好的输出流</span></span><br><span class="line">        <span class="keyword">if</span> (callOutput) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.output;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Cannot open output stream when writer is opened.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> PrintWriter <span class="title function_">getWriter</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 第一次调用</span></span><br><span class="line">        <span class="keyword">if</span> (callOutput == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 开始发生响应，采用分块传输</span></span><br><span class="line">            commitHeaders(<span class="number">0</span>);</span><br><span class="line">            <span class="comment">// 字符输出流</span></span><br><span class="line">            <span class="built_in">this</span>.writer = <span class="keyword">new</span> <span class="title class_">PrintWriter</span>(<span class="built_in">this</span>.exchangeResponse.getResponseBody(), <span class="literal">true</span>, StandardCharsets.UTF_8);</span><br><span class="line">            <span class="built_in">this</span>.callOutput = Boolean.FALSE;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.writer;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 下一次调用直接使用之前已经创建好的输出流</span></span><br><span class="line">        <span class="keyword">if</span> (!callOutput) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.writer;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Cannot open writer when output stream is opened.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">commitHeaders</span><span class="params">(<span class="type">long</span> length)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="built_in">this</span>.exchangeResponse.sendResponseHeaders(<span class="built_in">this</span>.status, length);</span><br><span class="line">        <span class="built_in">this</span>.committed = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">checkNotCommitted</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.committed) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Response is committed.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendError</span><span class="params">(<span class="type">int</span> sc, String msg)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        checkNotCommitted();</span><br><span class="line">        <span class="built_in">this</span>.status = sc;</span><br><span class="line">        <span class="comment">// 发送错误响应，不采用分块传输</span></span><br><span class="line">        commitHeaders(-<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendError</span><span class="params">(<span class="type">int</span> sc)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        sendError(sc, <span class="string">&quot;Error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendRedirect</span><span class="params">(String location)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        checkNotCommitted();</span><br><span class="line">        <span class="comment">// 设置临时重定向</span></span><br><span class="line">        <span class="built_in">this</span>.status = <span class="number">302</span>;</span><br><span class="line">        <span class="built_in">this</span>.headers.setHeader(<span class="string">&quot;Location&quot;</span>, location);</span><br><span class="line">        <span class="comment">// 发送错误响应，不采用分块传输</span></span><br><span class="line">        commitHeaders(-<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addHeader</span><span class="params">(String name, String value)</span> &#123;</span><br><span class="line">        checkNotCommitted();</span><br><span class="line">        <span class="built_in">this</span>.headers.addHeader(name, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后需要注意的一点是，和<code>HttpServletRequest</code>不同，访问<code>HttpServletRequest</code>实例的一定是一个线程，因此，<code>HttpServletRequest</code>的<code>getAttribute()</code>和<code>setAttribute()</code>不需要同步，底层存储用<code>HashMap</code>即可。但是，访问<code>HttpSession</code>实例的可能是多线程，所以，<code>HttpSession</code>的<code>getAttribute()</code>和<code>setAttribute()</code>需要实现并发访问，底层存储用<code>ConcurrentHashMap</code>即可。</p>
<p><img src="/../../../../../../imgs/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/image-20231127152238495.png" alt="image-20231127152238495"></p>
<p>访问<code>IndexServlet</code>，第一次访问时，将获取到新的<code>HttpSession</code>，此时，<code>HttpSession</code>没有用户信息，因此显示登录表单：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebServlet(urlPatterns = &quot;/&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IndexServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="type">HttpSession</span> <span class="variable">session</span> <span class="operator">=</span> req.getSession();</span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> (String) session.getAttribute(<span class="string">&quot;username&quot;</span>);</span><br><span class="line">        String html;</span><br><span class="line">        <span class="keyword">if</span> (username == <span class="literal">null</span>) &#123;</span><br><span class="line">            html = <span class="string">&quot;&lt;h1&gt;Index Page&lt;/h1&gt;&lt;form method=\&quot;post\&quot; action=\&quot;/login\&quot;&gt;&lt;legend&gt;Please Login&lt;/legend&gt;&lt;p&gt;User Name: &lt;input type=\&quot;text\&quot; name=\&quot;username\&quot;&gt;&lt;/p&gt;&lt;p&gt;Password: &lt;input type=\&quot;password\&quot; name=\&quot;password\&quot;&gt;&lt;/p&gt;&lt;p&gt;&lt;button type=\&quot;submit\&quot;&gt;Login&lt;/button&gt;&lt;/p&gt;&lt;/form&gt;&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            html = <span class="string">&quot;&lt;h1&gt;Index Page&lt;/h1&gt;&lt;p&gt;Welcome, &#123;username&#125;!&lt;/p&gt;&lt;p&gt;&lt;a href=\&quot;/logout\&quot;&gt;Logout&lt;/a&gt;&lt;/p&gt;&quot;</span>.replace(<span class="string">&quot;&#123;username&#125;&quot;</span>, username);</span><br><span class="line">        &#125;</span><br><span class="line">        resp.setContentType(<span class="string">&quot;text/html&quot;</span>);</span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">pw</span> <span class="operator">=</span> resp.getWriter();</span><br><span class="line">        pw.write(html);</span><br><span class="line">        pw.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@WebServlet(urlPatterns = &quot;/login&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line"></span><br><span class="line">    Map&lt;String, String&gt; users = Map.of( <span class="comment">// user database</span></span><br><span class="line">            <span class="string">&quot;bob&quot;</span>, <span class="string">&quot;bob123&quot;</span>, <span class="comment">//</span></span><br><span class="line">            <span class="string">&quot;alice&quot;</span>, <span class="string">&quot;alice123&quot;</span>, <span class="comment">//</span></span><br><span class="line">            <span class="string">&quot;root&quot;</span>, <span class="string">&quot;admin123&quot;</span> <span class="comment">//</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;username&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;password&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">expectedPassword</span> <span class="operator">=</span> users.get(username.toLowerCase());</span><br><span class="line">        <span class="keyword">if</span> (expectedPassword == <span class="literal">null</span> || !expectedPassword.equals(password)) &#123;</span><br><span class="line">            <span class="type">PrintWriter</span> <span class="variable">pw</span> <span class="operator">=</span> resp.getWriter();</span><br><span class="line">            pw.write(<span class="string">&quot;&lt;h1&gt;Login Failed&lt;/h1&gt;&lt;p&gt;Invalid username or password.&lt;/p&gt;&lt;p&gt;&lt;a href=\&quot;/\&quot;&gt;Try again&lt;/a&gt;&lt;/p&gt;&quot;</span>);</span><br><span class="line">            pw.close();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            req.getSession().setAttribute(<span class="string">&quot;username&quot;</span>, username);</span><br><span class="line">            resp.sendRedirect(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@WebServlet(urlPatterns = &quot;/logout&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogoutServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="type">HttpSession</span> <span class="variable">session</span> <span class="operator">=</span> req.getSession();</span><br><span class="line">        session.invalidate();</span><br><span class="line">        resp.sendRedirect(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/../../../../../../imgs/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/image-20231127152338332.png" alt="image-20231127152338332"></p>
<p>登录成功后，可以看到用户名已放入<code>HttpSession</code>，<code>IndexServlet</code>从<code>HttpSession</code>获取到用户名后将用户名显示出来：</p>
<p><img src="/../../../../../../imgs/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/image-20231127152509584.png" alt="image-20231127152509584"></p>
<p>刷新页面，<code>IndexServlet</code>仍将显示登录的用户名，因为根据Cookie拿到相同的SessionID后，获取的<code>HttpSession</code>是同一个实例。由于我们设定的<code>HttpSession</code>过期时间是10分钟，等待至少10分钟，观察控制台输出：</p>
<p><img src="/../../../../../../imgs/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/image-20231127154211169.png" alt="image-20231127154211169"></p>
<p>大约在15:25:33时清理了过期的Session，最后一次访问时间是15:36:14（注意时间需要经过时区调整），再次刷新页面将显示登录表单：</p>
<p><img src="/../../../../../../imgs/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/image-20231127154049413.png" alt="image-20231127154049413"></p>
<p>由于没有对<code>HttpSession</code>进行持久化处理，重启服务器后，将丢失所有用户的Session。如果希望重启服务器后保留用户的Session，则需要将Session数据持久化到文件或数据库，此功能要求用户放入<code>HttpSession</code>的Java对象必须是可序列化的；</p>
<p>因为Session不容易扩展，因此，大规模集群的Web App通常自己管理Cookie来实现登录功能，这样，将用户状态完全保存在浏览器端，不使用Session，服务器就可以做到无状态集群。</p>
<h2 id="四、实现Listener"><a href="#四、实现Listener" class="headerlink" title="四、实现Listener"></a>四、实现Listener</h2><p>在Java Web App中，除了Servlet、Filter和HttpSession外，还有一种Listener组件，用于事件监听。</p>
<p>Listener是Java Web App中的一种事件监听机制，用于监听Web应用程序中产生的事件，例如，在<code>ServletContext</code>初始化完成后，会触发<code>contextInitialized</code>事件，实现了<code>ServletContextListener</code>接口的Listener就可以接收到事件通知，可以在内部做一些初始化工作，如加载配置文件，初始化数据库连接池等。实现了<code>HttpSessionListener</code>接口的Listener可以接收到Session的创建和消耗事件，这样就可以统计在线用户数。</p>
<p>Listener机制是基于<code>观察者模式</code>实现的，即当某个事件发生时，Listener会接收到通知并执行相应的操作。</p>
<p>Servlet规范定义了很多种Listener接口，常用的Listener包括：</p>
<ul>
<li><code>ServletContextListener</code>：用于监听<code>ServletContext</code>的创建和销毁事件；</li>
<li><code>HttpSessionListener</code>：用于监听<code>HttpSession</code>的创建和销毁事件；</li>
<li><code>ServletRequestListener</code>：用于监听<code>ServletRequest</code>的创建和销毁事件；</li>
<li><code>ServletContextAttributeListener</code>：用于监听<code>ServletContext</code>属性的添加、修改和删除事件；</li>
<li><code>HttpSessionAttributeListener</code>：用于监听<code>HttpSession</code>属性的添加、修改和删除事件；</li>
<li><code>ServletRequestAttributeListener</code>：用于监听<code>ServletRequest</code>属性的添加、修改和删除事件。</li>
</ul>
<p>下面我们就来实现上述常用的Listener。</p>
<p>首先我们需要在<code>ServletContextImpl</code>中注册并管理所有的Listener，所以用不同的<code>List</code>持有注册的Listener：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServletContextImpl</span> <span class="keyword">implements</span> <span class="title class_">ServletContext</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">private</span> List&lt;ServletContextListener&gt; servletContextListeners = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> List&lt;ServletContextAttributeListener&gt; servletContextAttributeListeners = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> List&lt;ServletRequestListener&gt; servletRequestListeners = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> List&lt;ServletRequestAttributeListener&gt; servletRequestAttributeListeners = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> List&lt;HttpSessionAttributeListener&gt; httpSessionAttributeListeners = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> List&lt;HttpSessionListener&gt; httpSessionListeners = <span class="literal">null</span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后，实现<code>ServletContext</code>的<code>addListener()</code>接口，用于注册Listener：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServletContextImpl</span> <span class="keyword">implements</span> <span class="title class_">ServletContext</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addListener</span><span class="params">(String className)</span> &#123;</span><br><span class="line">        addListener(Class.forName(className));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addListener</span><span class="params">(Class&lt;? extends EventListener&gt; clazz)</span> &#123;</span><br><span class="line">        addListener(clazz.newInstance());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T <span class="keyword">extends</span> <span class="title class_">EventListener</span>&gt; <span class="keyword">void</span> <span class="title function_">addListener</span><span class="params">(T t)</span> &#123;</span><br><span class="line">        <span class="comment">// 根据Listener类型放入不同的List:</span></span><br><span class="line">        <span class="keyword">if</span> (t <span class="keyword">instanceof</span> ServletContextListener listener) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.servletContextListeners == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="built_in">this</span>.servletContextListeners = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">this</span>.servletContextListeners.add(listener);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (t <span class="keyword">instanceof</span> ServletContextAttributeListener listener) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.servletContextAttributeListeners == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="built_in">this</span>.servletContextAttributeListeners = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">this</span>.servletContextAttributeListeners.add(listener);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ...</span><br><span class="line">            ...代码略...</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Unsupported listener: &quot;</span> + t.getClass().getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来，就是在合适的时机，触发这些Listener。以<code>ServletContextAttributeListener</code>为例，统一触发的方法放在<code>ServletContextImpl</code>中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServletContextImpl</span> <span class="keyword">implements</span> <span class="title class_">ServletContext</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">invokeServletContextAttributeAdded</span><span class="params">(String name, Object value)</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;invoke ServletContextAttributeAdded: &#123;&#125; = &#123;&#125;&quot;</span>, name, value);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.servletContextAttributeListeners != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">var</span> <span class="variable">event</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServletContextAttributeEvent</span>(<span class="built_in">this</span>, name, value);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> listener : <span class="built_in">this</span>.servletContextAttributeListeners) &#123;</span><br><span class="line">                listener.attributeAdded(event);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">invokeServletContextAttributeRemoved</span><span class="params">(String name, Object value)</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;invoke ServletContextAttributeRemoved: &#123;&#125; = &#123;&#125;&quot;</span>, name, value);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.servletContextAttributeListeners != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">var</span> <span class="variable">event</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServletContextAttributeEvent</span>(<span class="built_in">this</span>, name, value);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> listener : <span class="built_in">this</span>.servletContextAttributeListeners) &#123;</span><br><span class="line">                listener.attributeRemoved(event);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">invokeServletContextAttributeReplaced</span><span class="params">(String name, Object value)</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;invoke ServletContextAttributeReplaced: &#123;&#125; = &#123;&#125;&quot;</span>, name, value);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.servletContextAttributeListeners != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">var</span> <span class="variable">event</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServletContextAttributeEvent</span>(<span class="built_in">this</span>, name, value);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> listener : <span class="built_in">this</span>.servletContextAttributeListeners) &#123;</span><br><span class="line">                listener.attributeReplaced(event);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当Web App的任何组件调用<code>ServletContext</code>的<code>setAttribute()</code>或<code>removeAttribute()</code>时，就可以触发事件通知：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServletContextImpl</span> <span class="keyword">implements</span> <span class="title class_">ServletContext</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAttribute</span><span class="params">(String name, Object value)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (value == <span class="literal">null</span>) &#123;</span><br><span class="line">            removeAttribute(name);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">old</span> <span class="operator">=</span> <span class="built_in">this</span>.attributes.setAttribute(name, value);</span><br><span class="line">            <span class="keyword">if</span> (old == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 触发attributeAdded:</span></span><br><span class="line">                <span class="built_in">this</span>.invokeServletContextAttributeAdded(name, value);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 触发attributeReplaced:</span></span><br><span class="line">                <span class="built_in">this</span>.invokeServletContextAttributeReplaced(name, value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">removeAttribute</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">old</span> <span class="operator">=</span> <span class="built_in">this</span>.attributes.removeAttribute(name);</span><br><span class="line">        <span class="comment">// 触发attributeRemoved:</span></span><br><span class="line">        <span class="built_in">this</span>.invokeServletContextAttributeRemoved(name, old);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其他事件触发也是类似的写法，此处不再重复。Servlet规范定义了各种Listener组件，我们支持了其中常用的大部分<code>EventListener</code>组件；Listener组件由<code>ServletContext</code>统一管理，并提供统一调度入口方法；通知机制允许多线程同时调用，如果要防止并发调用Listener的回调方法，需要Listener组件本身在内部做好同步。</p>
<p><img src="/../../../../../../imgs/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/image-20231127155242546.png" alt="image-20231127155242546"></p>
<p>为了测试Listener机制是否生效，我们还需要先编写不同类型的Listener，例如，<code>HelloHttpSessionAttributeListener</code>实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebListener</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloHelloHttpSessionAttributeListener</span> <span class="keyword">implements</span> <span class="title class_">HttpSessionAttributeListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">attributeAdded</span><span class="params">(HttpSessionBindingEvent event)</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;&gt;&gt;&gt; HttpSession attribute added: &#123;&#125; = &#123;&#125;&quot;</span>, event.getName(), event.getValue());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">attributeRemoved</span><span class="params">(HttpSessionBindingEvent event)</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;&gt;&gt;&gt; HttpSession attribute removed: &#123;&#125; = &#123;&#125;&quot;</span>, event.getName(), event.getValue());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">attributeReplaced</span><span class="params">(HttpSessionBindingEvent event)</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;&gt;&gt;&gt; HttpSession attribute replaced: &#123;&#125; = &#123;&#125;&quot;</span>, event.getName(), event.getValue());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在<code>HttpConnector</code>中注册所有的Listener：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Class&lt;? <span class="keyword">extends</span> <span class="title class_">EventListener</span>&gt;&gt; listenerClasses = List.of(HelloHttpSessionAttributeListener.class, ...);</span><br><span class="line"><span class="keyword">for</span> (Class&lt;? <span class="keyword">extends</span> <span class="title class_">EventListener</span>&gt; listenerClass : listenerClasses) &#123;</span><br><span class="line">    <span class="built_in">this</span>.servletContext.addListener(listenerClass);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动服务器，在浏览器中登录或登出，观察日志输出，在每个请求处理前后，可以看到<code>ServletRequestListener</code>的创建和销毁事件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">08:<span class="number">58</span>:<span class="number">23.944</span> [HTTP-Dispatcher] INFO  c.i.j.e.l.HelloServletRequestListener -- &gt;&gt;&gt; ServletRequest initialized: HttpServletRequestImpl@71a49a97[GET:/]</span><br><span class="line">...</span><br><span class="line">08:<span class="number">58</span>:<span class="number">24.008</span> [HTTP-Dispatcher] INFO  c.i.j.e.l.HelloServletRequestListener -- &gt;&gt;&gt; ServletRequest destroyed: HttpServletRequestImpl@71a49a97[GET:/]</span><br></pre></td></tr></table></figure>

<p>在第一次访问页面和登出时，可以看到<code>HttpSessionListener</code>的创建和销毁事件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">08:<span class="number">58</span>:<span class="number">23.947</span> [HTTP-Dispatcher] INFO  c.i.j.e.l.HelloHttpSessionListener -- &gt;&gt;&gt; HttpSession created: com.itranswarp.jerrymouse.engine.HttpSessionImpl@15037a31</span><br><span class="line">...</span><br><span class="line">08:<span class="number">58</span>:<span class="number">36.766</span> [HTTP-Dispatcher] INFO  c.i.j.e.l.HelloHttpSessionListener -- &gt;&gt;&gt; HttpSession destroyed: com.itranswarp.jerrymouse.engine.HttpSessionImpl@15037a31</span><br></pre></td></tr></table></figure>

<p>其他事件的触发也可以在日志中找到，这说明我们成功地实现了Servlet规范的Listener机制。</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="/tags/">Tag</a></li>
        
          <li><a target="_blank" rel="noopener" href="http://github.com/hulingF">Projects</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat-%E4%BA%8C"><span class="toc-number">1.</span> <span class="toc-text">手撸简易版Tomcat(二)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%AE%9E%E7%8E%B0ServletContext"><span class="toc-number">1.1.</span> <span class="toc-text">一、实现ServletContext</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%AE%9E%E7%8E%B0FilterChain"><span class="toc-number">1.2.</span> <span class="toc-text">二、实现FilterChain</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E5%AE%9E%E7%8E%B0HttpSession"><span class="toc-number">1.3.</span> <span class="toc-text">三、实现HttpSession</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E5%AE%9E%E7%8E%B0Listener"><span class="toc-number">1.4.</span> <span class="toc-text">四、实现Listener</span></a></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://hulingf.github.io/2023/11/27/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://hulingf.github.io/2023/11/27/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/&text=手撸简易版Tomcat(二)"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://hulingf.github.io/2023/11/27/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/&title=手撸简易版Tomcat(二)"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://hulingf.github.io/2023/11/27/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/&is_video=false&description=手撸简易版Tomcat(二)"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=手撸简易版Tomcat(二)&body=Check out this article: https://hulingf.github.io/2023/11/27/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://hulingf.github.io/2023/11/27/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/&title=手撸简易版Tomcat(二)"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://hulingf.github.io/2023/11/27/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/&title=手撸简易版Tomcat(二)"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://hulingf.github.io/2023/11/27/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/&title=手撸简易版Tomcat(二)"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://hulingf.github.io/2023/11/27/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/&title=手撸简易版Tomcat(二)"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://hulingf.github.io/2023/11/27/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/&name=手撸简易版Tomcat(二)&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://hulingf.github.io/2023/11/27/%E6%89%8B%E6%92%B8%E7%AE%80%E6%98%93%E7%89%88Tomcat(%E4%BA%8C)/&t=手撸简易版Tomcat(二)"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2023
    hulingF
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/hulingF">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
