<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="String类源码剖析一、String类的简介该String类表示字符串。Java程序中的所有字符串文本（如”abc”）都作为此类的实例实现。字符串是常量，它们的值在创建后无法更改。字符串缓冲区（也就是StringBuffer）支持可变字符串。由于字符串对象是不可变的，因此可以共享它们。下面是如何使用字符串的更多示例： 12345System.out.println(&quot;abc&quot;">
<meta property="og:type" content="article">
<meta property="og:title" content="String类源码剖析">
<meta property="og:url" content="https://hulingf.github.io/2023/09/08/String%E7%B1%BB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/index.html">
<meta property="og:site_name" content="大军的秘密花园">
<meta property="og:description" content="String类源码剖析一、String类的简介该String类表示字符串。Java程序中的所有字符串文本（如”abc”）都作为此类的实例实现。字符串是常量，它们的值在创建后无法更改。字符串缓冲区（也就是StringBuffer）支持可变字符串。由于字符串对象是不可变的，因此可以共享它们。下面是如何使用字符串的更多示例： 12345System.out.println(&quot;abc&quot;">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://hulingf.github.io/imgs/String%E7%B1%BB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/image-20230908115304282.png">
<meta property="og:image" content="https://hulingf.github.io/imgs/String%E7%B1%BB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/image-20230908121925509.png">
<meta property="og:image" content="https://hulingf.github.io/imgs/String%E7%B1%BB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/image-20230908201244380.png">
<meta property="og:image" content="https://hulingf.github.io/imgs/String%E7%B1%BB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/image-20230908203350214.png">
<meta property="og:image" content="https://hulingf.github.io/imgs/String%E7%B1%BB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/image-20230908205325748.png">
<meta property="og:image" content="https://hulingf.github.io/imgs/String%E7%B1%BB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/image-20230908214526497.png">
<meta property="og:image" content="https://hulingf.github.io/imgs/String%E7%B1%BB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/image-20230908215142595.png">
<meta property="og:image" content="https://hulingf.github.io/imgs/String%E7%B1%BB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/image-20230908215852842.png">
<meta property="og:image" content="https://hulingf.github.io/imgs/String%E7%B1%BB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/image-20230909084046439.png">
<meta property="og:image" content="https://hulingf.github.io/imgs/String%E7%B1%BB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/image-20230909084555312.png">
<meta property="og:image" content="https://hulingf.github.io/imgs/String%E7%B1%BB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/image-20230909104232598.png">
<meta property="article:published_time" content="2023-09-08T02:23:00.460Z">
<meta property="article:modified_time" content="2023-09-09T04:45:20.000Z">
<meta property="article:author" content="hulingF">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://hulingf.github.io/imgs/String%E7%B1%BB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/image-20230908115304282.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>String类源码剖析</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/hulingF">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2023/09/09/AbstractStringBuilder%E7%B1%BB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2023/09/06/Linux%20Fault%20Injection%E5%8E%9F%E7%90%86/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://hulingf.github.io/2023/09/08/String%E7%B1%BB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://hulingf.github.io/2023/09/08/String%E7%B1%BB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/&text=String类源码剖析"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://hulingf.github.io/2023/09/08/String%E7%B1%BB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/&title=String类源码剖析"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://hulingf.github.io/2023/09/08/String%E7%B1%BB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/&is_video=false&description=String类源码剖析"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=String类源码剖析&body=Check out this article: https://hulingf.github.io/2023/09/08/String%E7%B1%BB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://hulingf.github.io/2023/09/08/String%E7%B1%BB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/&title=String类源码剖析"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://hulingf.github.io/2023/09/08/String%E7%B1%BB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/&title=String类源码剖析"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://hulingf.github.io/2023/09/08/String%E7%B1%BB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/&title=String类源码剖析"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://hulingf.github.io/2023/09/08/String%E7%B1%BB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/&title=String类源码剖析"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://hulingf.github.io/2023/09/08/String%E7%B1%BB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/&name=String类源码剖析&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://hulingf.github.io/2023/09/08/String%E7%B1%BB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/&t=String类源码剖析"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#String%E7%B1%BB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90"><span class="toc-number">1.</span> <span class="toc-text">String类源码剖析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81String%E7%B1%BB%E7%9A%84%E7%AE%80%E4%BB%8B"><span class="toc-number">1.1.</span> <span class="toc-text">一、String类的简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81String%E7%B1%BB%E7%9A%84%E9%87%8D%E8%A6%81%E5%AD%97%E6%AE%B5"><span class="toc-number">1.2.</span> <span class="toc-text">二、String类的重要字段</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81String%E7%B1%BB%E7%9A%84%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95"><span class="toc-number">1.3.</span> <span class="toc-text">三、String类的构造方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81String%E7%B1%BB%E7%9A%84%E4%B8%80%E4%BA%9B%E6%96%B9%E6%B3%95"><span class="toc-number">1.4.</span> <span class="toc-text">四、String类的一些方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81String%E7%B1%BB%E7%9A%84equals%E6%96%B9%E6%B3%95"><span class="toc-number">1.5.</span> <span class="toc-text">五、String类的equals方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E3%80%81String%E7%B1%BB%E7%9A%84compareTo%E6%96%B9%E6%B3%95"><span class="toc-number">1.6.</span> <span class="toc-text">六、String类的compareTo方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83%E3%80%81String%E7%B1%BB%E7%9A%84startWith%E6%96%B9%E6%B3%95"><span class="toc-number">1.7.</span> <span class="toc-text">七、String类的startWith方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB%E3%80%81String%E7%B1%BB%E7%9A%84hashCode%E6%96%B9%E6%B3%95"><span class="toc-number">1.8.</span> <span class="toc-text">八、String类的hashCode方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B9%9D%E3%80%81String%E7%B1%BB%E7%9A%84subString%E6%96%B9%E6%B3%95"><span class="toc-number">1.9.</span> <span class="toc-text">九、String类的subString方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%81%E3%80%81String%E7%B1%BB%E7%9A%84concat%E6%96%B9%E6%B3%95"><span class="toc-number">1.10.</span> <span class="toc-text">十、String类的concat方法</span></a></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        String类源码剖析
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">hulingF</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-09-08T02:23:00.460Z" class="dt-published" itemprop="datePublished">2023-09-08</time>
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h1 id="String类源码剖析"><a href="#String类源码剖析" class="headerlink" title="String类源码剖析"></a>String类源码剖析</h1><h2 id="一、String类的简介"><a href="#一、String类的简介" class="headerlink" title="一、String类的简介"></a>一、String类的简介</h2><p>该String类表示字符串。Java程序中的所有字符串文本（如”abc”）都作为此类的实例实现。字符串是常量，它们的值在创建后无法更改。字符串缓冲区（也就是StringBuffer）支持可变字符串。由于字符串对象是<code>不可变</code>的，因此可以<code>共享</code>它们。下面是如何使用字符串的更多示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(<span class="string">&quot;abc&quot;</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">cde</span> <span class="operator">=</span> <span class="string">&quot;cde&quot;</span>;</span><br><span class="line">System.out.println(<span class="string">&quot;abc&quot;</span> + cde);</span><br><span class="line"><span class="type">String</span> <span class="variable">c</span> <span class="operator">=</span> <span class="string">&quot;abc&quot;</span>.substring(<span class="number">2</span>,<span class="number">3</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">d</span> <span class="operator">=</span> cde.substring(<span class="number">1</span>, <span class="number">2</span>);</span><br></pre></td></tr></table></figure>

<p>下面是String类的详细解读，需要注意特别注意<code>String的拼接操作</code>和<code>对象转String操作</code>。例如，<code>javac</code>编译器可能会利用<code>StringBuffer</code>、<code>StringBuilder</code>、<code>StringConcatFactory</code>等实现字符串拼接操作，而字符串转换操作往往利用从<code>Object</code>类继承的<code>toString</code>方法实现。</p>
<p><img src="/../../../../../../imgs/String%E7%B1%BB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/image-20230908115304282.png" alt="image-20230908115304282"></p>
<p>当String采用<code>UTF-16</code>编码格式时，辅助字符由一对<code>代理字符对</code>表示，索引值表示char码元，因此一个辅助字符在String中占据两个索引位置。String类提供了处理<code>码位</code>的方法以及处理<code>码元</code>(char值)的方法。关于编码相关的内容参考Character类以及<a href="https://hulingf.github.io/2023/08/02/Java%E5%9F%BA%E7%A1%80(%E4%BA%8C)/">Java基础-实用类 | 大军的秘密花园 (hulingf.github.io)</a>。</p>
<p><img src="/../../../../../../imgs/String%E7%B1%BB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/image-20230908121925509.png" alt="image-20230908121925509"></p>
<h2 id="二、String类的重要字段"><a href="#二、String类的重要字段" class="headerlink" title="二、String类的重要字段"></a>二、String类的重要字段</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">String</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span>, Comparable&lt;String&gt;, CharSequence &#123;</span><br><span class="line">   <span class="meta">@Stable</span></span><br><span class="line">   <span class="comment">//字节数组，存放String的内容，如果你看的是较低版本的源代码，这个变量可能是char[]类型，这个其实是JDK9开始对String做的一个优化</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">byte</span>[] value;</span><br><span class="line">   <span class="comment">//也是和String压缩优化有关，指定当前的LATIN1编码还是UTF16编码</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">byte</span> coder;</span><br><span class="line">   <span class="comment">//缓存的哈希值</span></span><br><span class="line">   <span class="keyword">private</span> <span class="type">int</span> hash;</span><br><span class="line">   <span class="comment">//序列化版本号</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">6849794470754667710L</span>;</span><br><span class="line">   <span class="comment">//优化压缩开关，默认开启</span></span><br><span class="line">   <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">COMPACT_STRINGS</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ObjectStreamField[] serialPersistentFields = <span class="keyword">new</span> <span class="title class_">ObjectStreamField</span>[<span class="number">0</span>];</span><br><span class="line">   <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">byte</span> <span class="variable">LATIN1</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">   <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">byte</span> <span class="variable">UTF16</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">   <span class="comment">//... 下面部分代码省略</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>从实现的接口角度看String：</p>
<ul>
<li>String类被final关键字修饰，因此不能被继承。</li>
<li>String的成员变量value使用final修饰，因此是不可变的，线程安全；</li>
<li>String类实现了Serializable接口，可以实现序列化。</li>
<li>String类实现了Comparable，可以比较大小。</li>
<li>String类实现了CharSequence接口，String本质是个数组，低版本中是char数组，JDK9以后优化成byte数组，从String的成员变量value就可以看出来。</li>
</ul>
<p>关于<code>value</code>字段：字符存储的字节数组，该字段受虚拟机信任，如果String实例是常量，则该字段会被<code>常量折叠</code>。在构建后重写该字段会导致问题。此外，它被标记为<code>Stable</code>，以信任数组的内容。JDK中还没有其他工具提供这种功能（目前还没有）。Stable在这里是安全的，因为值永远不会为空。</p>
<p>关于<code>coder</code>字段：用于对value中的字节进行编码的编码标识符。本实现支持的编码值为<code>LATIN1</code>和<code>UTF16</code>。该字段受虚拟机信任，如果 String 实例是常量，则该字段会被常量折叠。在构建后重写该字段会导致问题。</p>
<p>关于<code>hash</code>字段：缓存的字符串的hashcode值，默认为0。</p>
<p>关于<code>serialVersionUID</code>字段：serialVersionUID是一个序列化版本号，Java 通过这个 UID 来判定反序列化时的字节流与本地类的一致性，如果相同则可以进行反序列化，不同就会异常。</p>
<p>关于<code>serialPersistentFields</code>字段：这个用来保存要进行序列化的字段。默认情况下，所有的非transient非static修饰的字段都会被序列化，但可以用这个来进行选择序列化的字段。</p>
<p>关于<code>COMPACT_STRINGS</code>字段：如果禁用了字符串压缩，value中的字节总是以 UTF16 编码。对于有几种可能实现路径的方法，如果禁用字符串压缩，则只采用一种编码路径。对于优化 JIT 编译器来说，实例字段值通常是不透明的。因此，在对性能敏感的地方，首先要明确检查静态布尔值 COMPACT_STRINGS，然后再检查 coder 字段，因为静态布尔值 COMPACT_STRINGS 会被优化的 JIT 编译器常量折叠。对于代码如： if (coder &#x3D;&#x3D; LATIN1) { … } 可以更优化地写成 if (coder() &#x3D;&#x3D; LATIN1) { … } 或if (COMPACT_STRINGS &amp;&amp; coder &#x3D;&#x3D; LATIN1) { … } ，优化的 JIT 编译器可以将上述条件折叠为 COMPACT_STRINGS &#x3D;&#x3D; true &#x3D;&gt; if (coder &#x3D;&#x3D; LATIN1) { … } 或 COMPACT_STRINGS &#x3D;&#x3D; false &#x3D;&gt; if (false) { … }。</p>
<h2 id="三、String类的构造方法"><a href="#三、String类的构造方法" class="headerlink" title="三、String类的构造方法"></a>三、String类的构造方法</h2><p>第一个构造方法是无参构造方法，因为String是不可变类，因此创建一个空的String类没有必要！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">String</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.value = <span class="string">&quot;&quot;</span>.value;</span><br><span class="line">        <span class="built_in">this</span>.coder = <span class="string">&quot;&quot;</span>.coder;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>第二个构造方法是复制构造方法，注意value是个字节数组，直接赋值相当于两个字符型的value引用都指向同一个字节数组，但是因为String中的字节数组被final修饰不可变，因此共享是允许的！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">String</span><span class="params">(String original)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.value = original.value;</span><br><span class="line">        <span class="built_in">this</span>.coder = original.coder;</span><br><span class="line">        <span class="built_in">this</span>.hash = original.hash;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>第三个构造方法根据给定的char数组创建一个String对象，需要一一复制字符数组的内容，对字符数组的后续修改不会影响该String对象！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">String</span><span class="params">(<span class="type">char</span> value[])</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(value, <span class="number">0</span>, value.length, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>第四个构造方法与上一个类似，不过更加灵活，能够控制char数组的拷贝起始位置和拷贝长度，同时内部函数会检查参数有效性。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">String</span><span class="params">(<span class="type">char</span> value[], <span class="type">int</span> offset, <span class="type">int</span> count)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(value, offset, count, rangeCheck(value, offset, count));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Void <span class="title function_">rangeCheck</span><span class="params">(<span class="type">char</span>[] value, <span class="type">int</span> offset, <span class="type">int</span> count)</span> &#123;</span><br><span class="line">        checkBoundsOffCount(offset, count, value.length);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">checkBoundsOffCount</span><span class="params">(<span class="type">int</span> offset, <span class="type">int</span> count, <span class="type">int</span> length)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (offset &lt; <span class="number">0</span> || count &lt; <span class="number">0</span> || offset &gt; length - count) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">StringIndexOutOfBoundsException</span>(</span><br><span class="line">                <span class="string">&quot;offset &quot;</span> + offset + <span class="string">&quot;, count &quot;</span> + count + <span class="string">&quot;, length &quot;</span> + length);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>第五个构造方法是<code>包私有</code>的，尾部的<code>Void</code>参数是为了区别于其他（公开的）的构造方法，默认情况下COMPACT_STRING是开启的，关闭该选项可以使用<code>-XX:-CompactStrings</code>参数，如果字符数组的所有字符元素都位于Lantin1的范围内(0x00~0xFF)则使用单字节表示一个char码元，否则使用UTF-16即双字节表示一个char码元（BMP内的字符，如果是辅助平面的字符需要4字节即2个char码元）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">String(<span class="type">char</span>[] value, <span class="type">int</span> off, <span class="type">int</span> len, Void sig) &#123;</span><br><span class="line">        <span class="keyword">if</span> (len == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.value = <span class="string">&quot;&quot;</span>.value;</span><br><span class="line">            <span class="built_in">this</span>.coder = <span class="string">&quot;&quot;</span>.coder;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (COMPACT_STRINGS) &#123;</span><br><span class="line">            <span class="type">byte</span>[] val = StringUTF16.compress(value, off, len);</span><br><span class="line">            <span class="keyword">if</span> (val != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="built_in">this</span>.value = val;</span><br><span class="line">                <span class="built_in">this</span>.coder = LATIN1;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.coder = UTF16;</span><br><span class="line">        <span class="built_in">this</span>.value = StringUTF16.toBytes(value, off, len);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>观察StringUTF16.compress方法，逐一判断char数组的元素是否超出Latin1的最大表示范围0xFF，如果未超出则把char数组的char元素一一强转为byte类型，否则使用UTF-16编码方式。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] compress(<span class="type">char</span>[] val, <span class="type">int</span> off, <span class="type">int</span> len) &#123;</span><br><span class="line">        <span class="type">byte</span>[] ret = <span class="keyword">new</span> <span class="title class_">byte</span>[len];</span><br><span class="line">        <span class="keyword">if</span> (compress(val, off, ret, <span class="number">0</span>, len) == len) &#123;</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// compressedCopy char[] -&gt; byte[]</span></span><br><span class="line"><span class="meta">@HotSpotIntrinsicCandidate</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">compress</span><span class="params">(<span class="type">char</span>[] src, <span class="type">int</span> srcOff, <span class="type">byte</span>[] dst, <span class="type">int</span> dstOff, <span class="type">int</span> len)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">        <span class="type">char</span> <span class="variable">c</span> <span class="operator">=</span> src[srcOff];</span><br><span class="line">        <span class="keyword">if</span> (c &gt; <span class="number">0xFF</span>) &#123;</span><br><span class="line">            len = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        dst[dstOff] = (<span class="type">byte</span>)c;</span><br><span class="line">        srcOff++;</span><br><span class="line">        dstOff++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> len;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>观察StringUTF16.toBytes方法，所做的工作就是把char数组转换成byte数组，具体看代码注释：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] toBytes(<span class="type">char</span>[] value, <span class="type">int</span> off, <span class="type">int</span> len) &#123;</span><br><span class="line">    	<span class="comment">// 计算字节数组长度并创建</span></span><br><span class="line">        <span class="type">byte</span>[] val = newBytesFor(len);</span><br><span class="line">    	<span class="comment">// 填充字节数组</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">            putChar(val, i, value[off]);</span><br><span class="line">            off++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> val;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] newBytesFor(<span class="type">int</span> len) &#123;</span><br><span class="line">    	<span class="comment">// 检查len参数的有效性</span></span><br><span class="line">        <span class="keyword">if</span> (len &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NegativeArraySizeException</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (len &gt; MAX_LENGTH) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">OutOfMemoryError</span>(<span class="string">&quot;UTF16 String size is &quot;</span> + len +</span><br><span class="line">                                       <span class="string">&quot;, should be less than &quot;</span> + MAX_LENGTH);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 两个字节表示一个char码元</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">byte</span>[len &lt;&lt; <span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">putChar</span><span class="params">(<span class="type">byte</span>[] val, <span class="type">int</span> index, <span class="type">int</span> c)</span> &#123;</span><br><span class="line">    	<span class="comment">// 内部函数执行无边界检查</span></span><br><span class="line">        <span class="keyword">assert</span> index &gt;= <span class="number">0</span> &amp;&amp; index &lt; length(val) : <span class="string">&quot;Trusted caller missed bounds check&quot;</span>;</span><br><span class="line">    	<span class="comment">// 两个字节表示一个char码元，字节数据的先后位置考虑到大小端，默认是大端字节序</span></span><br><span class="line">        index &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">        val[index++] = (<span class="type">byte</span>)(c &gt;&gt; HI_BYTE_SHIFT);</span><br><span class="line">        val[index]   = (<span class="type">byte</span>)(c &gt;&gt; LO_BYTE_SHIFT);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">length</span><span class="params">(<span class="type">byte</span>[] value)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> value.length &gt;&gt; <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> HI_BYTE_SHIFT;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> LO_BYTE_SHIFT;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (isBigEndian()) &#123;</span><br><span class="line">            HI_BYTE_SHIFT = <span class="number">8</span>;</span><br><span class="line">            LO_BYTE_SHIFT = <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            HI_BYTE_SHIFT = <span class="number">0</span>;</span><br><span class="line">            LO_BYTE_SHIFT = <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>第六个构造函数是根据<code>int码位数组</code>创建String对象的，这跟上一个构造方法类似，不过需要注意的是采用UTF-16编码方式时需要计算<code>int码位数组</code>对应的<code>char码元数组</code>的长度，尤其是&#x3D;&#x3D;辅助平面的码位需要两个char码元&#x3D;&#x3D;。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">String</span><span class="params">(<span class="type">int</span>[] codePoints, <span class="type">int</span> offset, <span class="type">int</span> count)</span> &#123;</span><br><span class="line">    	<span class="comment">// 检查参数有效性</span></span><br><span class="line">        checkBoundsOffCount(offset, count, codePoints.length);</span><br><span class="line">    	<span class="comment">// 空字符串</span></span><br><span class="line">        <span class="keyword">if</span> (count == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.value = <span class="string">&quot;&quot;</span>.value;</span><br><span class="line">            <span class="built_in">this</span>.coder = <span class="string">&quot;&quot;</span>.coder;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    	<span class="comment">// 字符压缩，尝试使用Lantin1编码方式创建String对象</span></span><br><span class="line">        <span class="keyword">if</span> (COMPACT_STRINGS) &#123;</span><br><span class="line">            <span class="type">byte</span>[] val = StringLatin1.toBytes(codePoints, offset, count);</span><br><span class="line">            <span class="keyword">if</span> (val != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="built_in">this</span>.coder = LATIN1;</span><br><span class="line">                <span class="built_in">this</span>.value = val;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.coder = UTF16;</span><br><span class="line">        <span class="built_in">this</span>.value = StringUTF16.toBytes(codePoints, offset, count);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>观察StringLatin1.toBytes方法，使用单字节表示一个码位，压缩了String对象的占用空间(相比于UTF-16减少了50%)：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] toBytes(<span class="type">int</span>[] val, <span class="type">int</span> off, <span class="type">int</span> len) &#123;</span><br><span class="line">    	<span class="comment">// 创建等长的字节数组</span></span><br><span class="line">        <span class="type">byte</span>[] ret = <span class="keyword">new</span> <span class="title class_">byte</span>[len];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">cp</span> <span class="operator">=</span> val[off++];</span><br><span class="line">            <span class="comment">// 如果超出Lantin1最大范围，直接返回null</span></span><br><span class="line">            <span class="keyword">if</span> (!canEncode(cp)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 单字节表示一个码位</span></span><br><span class="line">            ret[i] = (<span class="type">byte</span>)cp;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">canEncode</span><span class="params">(<span class="type">int</span> cp)</span> &#123;</span><br><span class="line">    	<span class="comment">// cp位于0x00~0xFF范围（Lantin1）</span></span><br><span class="line">        <span class="keyword">return</span> cp &gt;&gt;&gt; <span class="number">8</span> == <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>观察StringUTF16.toBytes，具体逻辑见代码注释：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] toBytes(<span class="type">int</span>[] val, <span class="type">int</span> index, <span class="type">int</span> len) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">end</span> <span class="operator">=</span> index + len;</span><br><span class="line">        <span class="comment">// Pass 1: Compute precise size of char[]</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> len;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> index; i &lt; end; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">cp</span> <span class="operator">=</span> val[i];</span><br><span class="line">            <span class="comment">// 码位处于基本多语言平面内，一个char码元可以表示一个码位</span></span><br><span class="line">            <span class="keyword">if</span> (Character.isBmpCodePoint(cp))</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="comment">// 码位处于辅助平面内，两个char码元可以表示一个码位</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (Character.isValidCodePoint(cp))</span><br><span class="line">                n++;</span><br><span class="line">            <span class="comment">// 码位不正常，抛出异常</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(Integer.toString(cp));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Pass 2: Allocate and fill in &lt;high, low&gt; pair</span></span><br><span class="line">        <span class="type">byte</span>[] buf = newBytesFor(n);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> index, j = <span class="number">0</span>; i &lt; end; i++, j++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">cp</span> <span class="operator">=</span> val[i];</span><br><span class="line">            <span class="keyword">if</span> (Character.isBmpCodePoint(cp)) &#123;</span><br><span class="line">                <span class="comment">// 码位处于基本多语言平面内</span></span><br><span class="line">                putChar(buf, j, cp);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 码位处于辅助平面内，需要填充代理对（高位代理/低位代理）</span></span><br><span class="line">                putChar(buf, j++, Character.highSurrogate(cp));</span><br><span class="line">                putChar(buf, j, Character.lowSurrogate(cp));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> buf;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// len是char码元的数量，转换为byte需要加倍</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] newBytesFor(<span class="type">int</span> len) &#123;</span><br><span class="line">        <span class="keyword">if</span> (len &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NegativeArraySizeException</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (len &gt; MAX_LENGTH) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">OutOfMemoryError</span>(<span class="string">&quot;UTF16 String size is &quot;</span> + len +</span><br><span class="line">                                       <span class="string">&quot;, should be less than &quot;</span> + MAX_LENGTH);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">byte</span>[len &lt;&lt; <span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isBmpCodePoint</span><span class="params">(<span class="type">int</span> codePoint)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> codePoint &gt;&gt;&gt; <span class="number">16</span> == <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// Optimized form of:</span></span><br><span class="line">        <span class="comment">//     codePoint &gt;= MIN_VALUE(&#x27;\u0000&#x27;) &amp;&amp; codePoint &lt;= MAX_VALUE(&#x27;\uFFFF&#x27;)</span></span><br><span class="line">        <span class="comment">// We consistently use logical shift (&gt;&gt;&gt;) to facilitate</span></span><br><span class="line">        <span class="comment">// additional runtime optimizations.</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isValidCodePoint</span><span class="params">(<span class="type">int</span> codePoint)</span> &#123;</span><br><span class="line">        <span class="comment">// Optimized form of:</span></span><br><span class="line">        <span class="comment">//     codePoint &gt;= MIN_CODE_POINT(0x000000) &amp;&amp; codePoint &lt;= MAX_CODE_POINT(0X10FFFF)</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">plane</span> <span class="operator">=</span> codePoint &gt;&gt;&gt; <span class="number">16</span>;</span><br><span class="line">        <span class="keyword">return</span> plane &lt; ((MAX_CODE_POINT + <span class="number">1</span>) &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">char</span> <span class="title function_">highSurrogate</span><span class="params">(<span class="type">int</span> codePoint)</span> &#123;</span><br><span class="line">    	<span class="comment">// public static final char MIN_HIGH_SURROGATE = &#x27;\uD800&#x27;;</span></span><br><span class="line">    	<span class="comment">// public static final int MIN_SUPPLEMENTARY_CODE_POINT = 0x010000;</span></span><br><span class="line">    	<span class="comment">// 辅助码位范围是0x010000~10FFFF,码位-0x010000的范围是0x00000~0FFFFF,使用20位表示</span></span><br><span class="line">    	<span class="comment">// 相当于[(码位-0x010000)的高10位+0xD800]作为高位代理</span></span><br><span class="line">        <span class="keyword">return</span> (<span class="type">char</span>) ((codePoint &gt;&gt;&gt; <span class="number">10</span>)</span><br><span class="line">            + (MIN_HIGH_SURROGATE - (MIN_SUPPLEMENTARY_CODE_POINT &gt;&gt;&gt; <span class="number">10</span>)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">char</span> <span class="title function_">lowSurrogate</span><span class="params">(<span class="type">int</span> codePoint)</span> &#123;</span><br><span class="line">    	<span class="comment">// public static final char MIN_LOW_SURROGATE  = &#x27;\uDC00&#x27;;</span></span><br><span class="line">    	<span class="comment">// 相当于[(码位-0x010000)的低10位+0xDC00]作为低位代理</span></span><br><span class="line">        <span class="keyword">return</span> (<span class="type">char</span>) ((codePoint &amp; <span class="number">0x3ff</span>) + MIN_LOW_SURROGATE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">putChar</span><span class="params">(<span class="type">byte</span>[] val, <span class="type">int</span> index, <span class="type">int</span> c)</span> &#123;</span><br><span class="line">        <span class="keyword">assert</span> index &gt;= <span class="number">0</span> &amp;&amp; index &lt; length(val) : <span class="string">&quot;Trusted caller missed bounds check&quot;</span>;</span><br><span class="line">        index &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">        val[index++] = (<span class="type">byte</span>)(c &gt;&gt; HI_BYTE_SHIFT);</span><br><span class="line">        val[index]   = (<span class="type">byte</span>)(c &gt;&gt; LO_BYTE_SHIFT);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="四、String类的一些方法"><a href="#四、String类的一些方法" class="headerlink" title="四、String类的一些方法"></a>四、String类的一些方法</h2><p>length()方法返回String对象中Unicode码元的数量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">length</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> value.length &gt;&gt; coder();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="type">byte</span> <span class="title function_">coder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> COMPACT_STRINGS ? coder : UTF16;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">@Native</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">byte</span> <span class="variable">LATIN1</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="meta">@Native</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">byte</span> <span class="variable">UTF16</span>  <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>isEmpty()方法判断String对象是否是空字符串：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isEmpty</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> value.length == <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>isLatin1()方法判断String对象是否采用Latin1编码方式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isLatin1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> COMPACT_STRINGS &amp;&amp; coder == LATIN1;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>charAt(int index)方法返回char指定索引处的值。索引的范围从0到length()-1。char序列的第一个值在索引0处，下一个值在索引1处，依此类推，就像数组索引一样。如果索引指定的chat值是代理项，则返回代理项值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">char</span> <span class="title function_">charAt</span><span class="params">(<span class="type">int</span> index)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (isLatin1()) &#123;</span><br><span class="line">            <span class="keyword">return</span> StringLatin1.charAt(value, index);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> StringUTF16.charAt(value, index);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// StringLatin1.charAt</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">char</span> <span class="title function_">charAt</span><span class="params">(<span class="type">byte</span>[] value, <span class="type">int</span> index)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (index &lt; <span class="number">0</span> || index &gt;= value.length) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">StringIndexOutOfBoundsException</span>(index);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (<span class="type">char</span>)(value[index] &amp; <span class="number">0xff</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// StringUTF16.charAt</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">char</span> <span class="title function_">charAt</span><span class="params">(<span class="type">byte</span>[] value, <span class="type">int</span> index)</span> &#123;</span><br><span class="line">    	<span class="comment">// 检查index参数有效性</span></span><br><span class="line">        checkIndex(index, value);</span><br><span class="line">    	<span class="comment">// 获取指定索引处的char码元值</span></span><br><span class="line">        <span class="keyword">return</span> getChar(value, index);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">checkIndex</span><span class="params">(<span class="type">int</span> off, <span class="type">byte</span>[] val)</span> &#123;</span><br><span class="line">        String.checkIndex(off, length(val));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 计算码元的数量=byte数组长度/2</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">length</span><span class="params">(<span class="type">byte</span>[] value)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> value.length &gt;&gt; <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// index为负数或者超出length，则抛出字符串索引越界异常</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">checkIndex</span><span class="params">(<span class="type">int</span> index, <span class="type">int</span> length)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (index &lt; <span class="number">0</span> || index &gt;= length) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">StringIndexOutOfBoundsException</span>(<span class="string">&quot;index &quot;</span> + index +</span><br><span class="line">                                                      <span class="string">&quot;,length &quot;</span> + length);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="type">char</span> <span class="title function_">getChar</span><span class="params">(<span class="type">byte</span>[] val, <span class="type">int</span> index)</span> &#123;</span><br><span class="line">        <span class="keyword">assert</span> index &gt;= <span class="number">0</span> &amp;&amp; index &lt; length(val) : <span class="string">&quot;Trusted caller missed bounds check&quot;</span>;</span><br><span class="line">        index &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> (<span class="type">char</span>)(((val[index++] &amp; <span class="number">0xff</span>) &lt;&lt; HI_BYTE_SHIFT) |</span><br><span class="line">                      ((val[index]   &amp; <span class="number">0xff</span>) &lt;&lt; LO_BYTE_SHIFT));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><img src="/../../../../../../imgs/String%E7%B1%BB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/image-20230908201244380.png" alt="image-20230908201244380"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">codePointAt</span><span class="params">(<span class="type">int</span> index)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (isLatin1()) &#123;</span><br><span class="line">            checkIndex(index, value.length);</span><br><span class="line">            <span class="keyword">return</span> value[index] &amp; <span class="number">0xff</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> value.length &gt;&gt; <span class="number">1</span>;</span><br><span class="line">        checkIndex(index, length);</span><br><span class="line">        <span class="keyword">return</span> StringUTF16.codePointAt(value, index, length);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">codePointAt</span><span class="params">(<span class="type">byte</span>[] value, <span class="type">int</span> index, <span class="type">int</span> end)</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> codePointAt(value, index, end, <span class="literal">false</span> <span class="comment">/* unchecked */</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">codePointAt</span><span class="params">(<span class="type">byte</span>[] value, <span class="type">int</span> index, <span class="type">int</span> end, <span class="type">boolean</span> checked)</span> &#123;</span><br><span class="line">        <span class="keyword">assert</span> index &lt; end;</span><br><span class="line">        <span class="keyword">if</span> (checked) &#123;</span><br><span class="line">            checkIndex(index, value);</span><br><span class="line">        &#125;</span><br><span class="line">    	<span class="comment">// 获取指定索引处的码元值</span></span><br><span class="line">        <span class="type">char</span> <span class="variable">c1</span> <span class="operator">=</span> getChar(value, index);</span><br><span class="line">    	<span class="comment">// 如果该码元值是高位代理项的值并且后一个码元存在</span></span><br><span class="line">        <span class="keyword">if</span> (Character.isHighSurrogate(c1) &amp;&amp; ++index &lt; end) &#123;</span><br><span class="line">            <span class="keyword">if</span> (checked) &#123;</span><br><span class="line">                checkIndex(index, value);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 获取后一个索引处的码元值</span></span><br><span class="line">            <span class="type">char</span> <span class="variable">c2</span> <span class="operator">=</span> getChar(value, index);</span><br><span class="line">            <span class="comment">// 如果该码元值是低位代理项的值，则返回整个辅助码位(由高/低代理对表示)</span></span><br><span class="line">            <span class="keyword">if</span> (Character.isLowSurrogate(c2)) &#123;</span><br><span class="line">               <span class="keyword">return</span> Character.toCodePoint(c1, c2);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> c1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过代理对计算辅助码位</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">toCodePoint</span><span class="params">(<span class="type">char</span> high, <span class="type">char</span> low)</span> &#123;</span><br><span class="line">    	<span class="comment">// public static final int MIN_SUPPLEMENTARY_CODE_POINT = 0x010000;</span></span><br><span class="line">    	<span class="comment">// public static final char MIN_HIGH_SURROGATE = &#x27;\uD800&#x27;;</span></span><br><span class="line">    	<span class="comment">// public static final char MIN_LOW_SURROGATE  = &#x27;\uDC00&#x27;;</span></span><br><span class="line">        <span class="comment">// Optimized form of:</span></span><br><span class="line">        <span class="comment">// return ((high - MIN_HIGH_SURROGATE) &lt;&lt; 10)</span></span><br><span class="line">        <span class="comment">//         + (low - MIN_LOW_SURROGATE)</span></span><br><span class="line">        <span class="comment">//         + MIN_SUPPLEMENTARY_CODE_POINT;</span></span><br><span class="line">        <span class="keyword">return</span> ((high &lt;&lt; <span class="number">10</span>) + low) + (MIN_SUPPLEMENTARY_CODE_POINT</span><br><span class="line">                                       - (MIN_HIGH_SURROGATE &lt;&lt; <span class="number">10</span>)</span><br><span class="line">                                       - MIN_LOW_SURROGATE);</span><br></pre></td></tr></table></figure>

<p><img src="/../../../../../../imgs/String%E7%B1%BB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/image-20230908203350214.png" alt="image-20230908203350214"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getChars</span><span class="params">(<span class="type">int</span> srcBegin, <span class="type">int</span> srcEnd, <span class="type">char</span> dst[], <span class="type">int</span> dstBegin)</span> &#123;</span><br><span class="line">        checkBoundsBeginEnd(srcBegin, srcEnd, length());</span><br><span class="line">        checkBoundsOffCount(dstBegin, srcEnd - srcBegin, dst.length);</span><br><span class="line">        <span class="keyword">if</span> (isLatin1()) &#123;</span><br><span class="line">            StringLatin1.getChars(value, srcBegin, srcEnd, dst, dstBegin);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            StringUTF16.getChars(value, srcBegin, srcEnd, dst, dstBegin);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">checkBoundsBeginEnd</span><span class="params">(<span class="type">int</span> begin, <span class="type">int</span> end, <span class="type">int</span> length)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (begin &lt; <span class="number">0</span> || begin &gt; end || end &gt; length) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">StringIndexOutOfBoundsException</span>(</span><br><span class="line">                <span class="string">&quot;begin &quot;</span> + begin + <span class="string">&quot;, end &quot;</span> + end + <span class="string">&quot;, length &quot;</span> + length);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">checkBoundsOffCount</span><span class="params">(<span class="type">int</span> offset, <span class="type">int</span> count, <span class="type">int</span> length)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (offset &lt; <span class="number">0</span> || count &lt; <span class="number">0</span> || offset &gt; length - count) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">StringIndexOutOfBoundsException</span>(</span><br><span class="line">                <span class="string">&quot;offset &quot;</span> + offset + <span class="string">&quot;, count &quot;</span> + count + <span class="string">&quot;, length &quot;</span> + length);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// StringLatin1.getChars</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">getChars</span><span class="params">(<span class="type">byte</span>[] value, <span class="type">int</span> srcBegin, <span class="type">int</span> srcEnd, <span class="type">char</span> dst[], <span class="type">int</span> dstBegin)</span> &#123;</span><br><span class="line">        inflate(value, srcBegin, dst, dstBegin, srcEnd - srcBegin);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// inflatedCopy byte[] -&gt; char[]</span></span><br><span class="line"><span class="meta">@HotSpotIntrinsicCandidate</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">inflate</span><span class="params">(<span class="type">byte</span>[] src, <span class="type">int</span> srcOff, <span class="type">char</span>[] dst, <span class="type">int</span> dstOff, <span class="type">int</span> len)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">        dst[dstOff++] = (<span class="type">char</span>)(src[srcOff++] &amp; <span class="number">0xff</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// StringUTF16.getChars</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">getChars</span><span class="params">(<span class="type">byte</span>[] value, <span class="type">int</span> srcBegin, <span class="type">int</span> srcEnd, <span class="type">char</span> dst[], <span class="type">int</span> dstBegin)</span> &#123;</span><br><span class="line">        <span class="comment">// We need a range check here because &#x27;getChar&#x27; has no checks</span></span><br><span class="line">        <span class="keyword">if</span> (srcBegin &lt; srcEnd) &#123;</span><br><span class="line">            checkBoundsOffCount(srcBegin, srcEnd - srcBegin, value);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> srcBegin; i &lt; srcEnd; i++) &#123;</span><br><span class="line">            dst[dstBegin++] = getChar(value, i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="type">char</span> <span class="title function_">getChar</span><span class="params">(<span class="type">byte</span>[] val, <span class="type">int</span> index)</span> &#123;</span><br><span class="line">        <span class="keyword">assert</span> index &gt;= <span class="number">0</span> &amp;&amp; index &lt; length(val) : <span class="string">&quot;Trusted caller missed bounds check&quot;</span>;</span><br><span class="line">        index &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> (<span class="type">char</span>)(((val[index++] &amp; <span class="number">0xff</span>) &lt;&lt; HI_BYTE_SHIFT) |</span><br><span class="line">                      ((val[index]   &amp; <span class="number">0xff</span>) &lt;&lt; LO_BYTE_SHIFT));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="五、String类的equals方法"><a href="#五、String类的equals方法" class="headerlink" title="五、String类的equals方法"></a>五、String类的equals方法</h2><p>将此字符串与指定的对象进行比较。当且仅当参数不是null，并且是表示与此对象具有相同字符序列的String对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object anObject)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span> == anObject) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (anObject <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">aString</span> <span class="operator">=</span> (String)anObject;</span><br><span class="line">            <span class="keyword">if</span> (coder() == aString.coder()) &#123;</span><br><span class="line">                <span class="keyword">return</span> isLatin1() ? StringLatin1.equals(value, aString.value)</span><br><span class="line">                                  : StringUTF16.equals(value, aString.value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// StringLatin1.equals</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(<span class="type">byte</span>[] value, <span class="type">byte</span>[] other)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (value.length == other.length) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; value.length; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (value[i] != other[i]) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// StringUTF16.equals</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(<span class="type">byte</span>[] value, <span class="type">byte</span>[] other)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (value.length == other.length) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> value.length &gt;&gt; <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (getChar(value, i) != getChar(other, i)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><img src="/../../../../../../imgs/String%E7%B1%BB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/image-20230908205325748.png" alt="image-20230908205325748"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equalsIgnoreCase</span><span class="params">(String anotherString)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="built_in">this</span> == anotherString) ? <span class="literal">true</span></span><br><span class="line">                : (anotherString != <span class="literal">null</span>)</span><br><span class="line">                &amp;&amp; (anotherString.length() == length())</span><br><span class="line">                &amp;&amp; regionMatches(<span class="literal">true</span>, <span class="number">0</span>, anotherString, <span class="number">0</span>, length());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">regionMatches</span><span class="params">(<span class="type">boolean</span> ignoreCase, <span class="type">int</span> toffset,</span></span><br><span class="line"><span class="params">            String other, <span class="type">int</span> ooffset, <span class="type">int</span> len)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!ignoreCase) &#123;</span><br><span class="line">            <span class="keyword">return</span> regionMatches(toffset, other, ooffset, len);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Note: toffset, ooffset, or len might be near -1&gt;&gt;&gt;1.</span></span><br><span class="line">        <span class="keyword">if</span> ((ooffset &lt; <span class="number">0</span>) || (toffset &lt; <span class="number">0</span>)</span><br><span class="line">                || (toffset &gt; (<span class="type">long</span>)length() - len)</span><br><span class="line">                || (ooffset &gt; (<span class="type">long</span>)other.length() - len)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">byte</span> tv[] = value;</span><br><span class="line">        <span class="type">byte</span> ov[] = other.value;</span><br><span class="line">        <span class="keyword">if</span> (coder() == other.coder()) &#123;</span><br><span class="line">            <span class="keyword">return</span> isLatin1()</span><br><span class="line">              ? StringLatin1.regionMatchesCI(tv, toffset, ov, ooffset, len)</span><br><span class="line">              : StringUTF16.regionMatchesCI(tv, toffset, ov, ooffset, len);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> isLatin1()</span><br><span class="line">              ? StringLatin1.regionMatchesCI_UTF16(tv, toffset, ov, ooffset, len)</span><br><span class="line">              : StringUTF16.regionMatchesCI_Latin1(tv, toffset, ov, ooffset, len);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// StringLatin1.regionMatchesCI</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">regionMatchesCI</span><span class="params">(<span class="type">byte</span>[] value, <span class="type">int</span> toffset,</span></span><br><span class="line"><span class="params">                                          <span class="type">byte</span>[] other, <span class="type">int</span> ooffset, <span class="type">int</span> len)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">last</span> <span class="operator">=</span> toffset + len;</span><br><span class="line">        <span class="keyword">while</span> (toffset &lt; last) &#123;</span><br><span class="line">            <span class="type">char</span> <span class="variable">c1</span> <span class="operator">=</span> (<span class="type">char</span>)(value[toffset++] &amp; <span class="number">0xff</span>);</span><br><span class="line">            <span class="type">char</span> <span class="variable">c2</span> <span class="operator">=</span> (<span class="type">char</span>)(other[ooffset++] &amp; <span class="number">0xff</span>);</span><br><span class="line">            <span class="keyword">if</span> (c1 == c2) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">char</span> <span class="variable">u1</span> <span class="operator">=</span> Character.toUpperCase(c1);</span><br><span class="line">            <span class="type">char</span> <span class="variable">u2</span> <span class="operator">=</span> Character.toUpperCase(c2);</span><br><span class="line">            <span class="keyword">if</span> (u1 == u2) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (Character.toLowerCase(u1) == Character.toLowerCase(u2)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// StringUTF16.regionMatchesCI</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">regionMatchesCI</span><span class="params">(<span class="type">byte</span>[] value, <span class="type">int</span> toffset,</span></span><br><span class="line"><span class="params">                                          <span class="type">byte</span>[] other, <span class="type">int</span> ooffset, <span class="type">int</span> len)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">last</span> <span class="operator">=</span> toffset + len;</span><br><span class="line">        <span class="keyword">assert</span> toffset &gt;= <span class="number">0</span> &amp;&amp; ooffset &gt;= <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">assert</span> ooffset + len &lt;= length(other);</span><br><span class="line">        <span class="keyword">assert</span> last &lt;= length(value);</span><br><span class="line">        <span class="keyword">while</span> (toffset &lt; last) &#123;</span><br><span class="line">            <span class="type">char</span> <span class="variable">c1</span> <span class="operator">=</span> getChar(value, toffset++);</span><br><span class="line">            <span class="type">char</span> <span class="variable">c2</span> <span class="operator">=</span> getChar(other, ooffset++);</span><br><span class="line">            <span class="keyword">if</span> (c1 == c2) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// try converting both characters to uppercase.</span></span><br><span class="line">            <span class="comment">// If the results match, then the comparison scan should</span></span><br><span class="line">            <span class="comment">// continue.</span></span><br><span class="line">            <span class="type">char</span> <span class="variable">u1</span> <span class="operator">=</span> Character.toUpperCase(c1);</span><br><span class="line">            <span class="type">char</span> <span class="variable">u2</span> <span class="operator">=</span> Character.toUpperCase(c2);</span><br><span class="line">            <span class="keyword">if</span> (u1 == u2) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Unfortunately, conversion to uppercase does not work properly</span></span><br><span class="line">            <span class="comment">// for the Georgian alphabet, which has strange rules about case</span></span><br><span class="line">            <span class="comment">// conversion.  So we need to make one last check before</span></span><br><span class="line">            <span class="comment">// exiting.</span></span><br><span class="line">            <span class="keyword">if</span> (Character.toLowerCase(u1) == Character.toLowerCase(u2)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// StringLatin1.regionMatchesCI_UTF16</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">regionMatchesCI_UTF16</span><span class="params">(<span class="type">byte</span>[] value, <span class="type">int</span> toffset,</span></span><br><span class="line"><span class="params">                                                <span class="type">byte</span>[] other, <span class="type">int</span> ooffset, <span class="type">int</span> len)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">last</span> <span class="operator">=</span> toffset + len;</span><br><span class="line">        <span class="keyword">while</span> (toffset &lt; last) &#123;</span><br><span class="line">            <span class="type">char</span> <span class="variable">c1</span> <span class="operator">=</span> (<span class="type">char</span>)(value[toffset++] &amp; <span class="number">0xff</span>);</span><br><span class="line">            <span class="type">char</span> <span class="variable">c2</span> <span class="operator">=</span> StringUTF16.getChar(other, ooffset++);</span><br><span class="line">            <span class="keyword">if</span> (c1 == c2) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">char</span> <span class="variable">u1</span> <span class="operator">=</span> Character.toUpperCase(c1);</span><br><span class="line">            <span class="type">char</span> <span class="variable">u2</span> <span class="operator">=</span> Character.toUpperCase(c2);</span><br><span class="line">            <span class="keyword">if</span> (u1 == u2) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (Character.toLowerCase(u1) == Character.toLowerCase(u2)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// StringUTF16.regionMatchesCI_Latin1</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">regionMatchesCI_Latin1</span><span class="params">(<span class="type">byte</span>[] value, <span class="type">int</span> toffset,</span></span><br><span class="line"><span class="params">                                                 <span class="type">byte</span>[] other, <span class="type">int</span> ooffset,</span></span><br><span class="line"><span class="params">                                                 <span class="type">int</span> len)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> StringLatin1.regionMatchesCI_UTF16(other, ooffset, value, toffset, len);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="六、String类的compareTo方法"><a href="#六、String类的compareTo方法" class="headerlink" title="六、String类的compareTo方法"></a>六、String类的compareTo方法</h2><p><img src="/../../../../../../imgs/String%E7%B1%BB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/image-20230908214526497.png" alt="image-20230908214526497"></p>
<p>String继承Comparable接口并重写compareTo方法，比较的原则是从前往后逐个char码元按<code>字典顺序</code>比较大小，如果都相同则比较String对象的长度！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compareTo</span><span class="params">(String anotherString)</span> &#123;</span><br><span class="line">        <span class="type">byte</span> v1[] = value;</span><br><span class="line">        <span class="type">byte</span> v2[] = anotherString.value;</span><br><span class="line">        <span class="keyword">if</span> (coder() == anotherString.coder()) &#123;</span><br><span class="line">            <span class="keyword">return</span> isLatin1() ? StringLatin1.compareTo(v1, v2)</span><br><span class="line">                              : StringUTF16.compareTo(v1, v2);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> isLatin1() ? StringLatin1.compareToUTF16(v1, v2)</span><br><span class="line">                          : StringUTF16.compareToLatin1(v1, v2);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// StringLatin1.compareTo</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">compareTo</span><span class="params">(<span class="type">byte</span>[] value, <span class="type">byte</span>[] other)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">len1</span> <span class="operator">=</span> value.length;</span><br><span class="line">        <span class="type">int</span> <span class="variable">len2</span> <span class="operator">=</span> other.length;</span><br><span class="line">        <span class="keyword">return</span> compareTo(value, other, len1, len2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">compareTo</span><span class="params">(<span class="type">byte</span>[] value, <span class="type">byte</span>[] other, <span class="type">int</span> len1, <span class="type">int</span> len2)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">lim</span> <span class="operator">=</span> Math.min(len1, len2);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> <span class="number">0</span>; k &lt; lim; k++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (value[k] != other[k]) &#123;</span><br><span class="line">                <span class="keyword">return</span> getChar(value, k) - getChar(other, k);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> len1 - len2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// StringUTF16.compareTo</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">compareTo</span><span class="params">(<span class="type">byte</span>[] value, <span class="type">byte</span>[] other)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">len1</span> <span class="operator">=</span> length(value);</span><br><span class="line">        <span class="type">int</span> <span class="variable">len2</span> <span class="operator">=</span> length(other);</span><br><span class="line">        <span class="keyword">return</span> compareValues(value, other, len1, len2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">compareValues</span><span class="params">(<span class="type">byte</span>[] value, <span class="type">byte</span>[] other, <span class="type">int</span> len1, <span class="type">int</span> len2)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">lim</span> <span class="operator">=</span> Math.min(len1, len2);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> <span class="number">0</span>; k &lt; lim; k++) &#123;</span><br><span class="line">            <span class="type">char</span> <span class="variable">c1</span> <span class="operator">=</span> getChar(value, k);</span><br><span class="line">            <span class="type">char</span> <span class="variable">c2</span> <span class="operator">=</span> getChar(other, k);</span><br><span class="line">            <span class="keyword">if</span> (c1 != c2) &#123;</span><br><span class="line">                <span class="keyword">return</span> c1 - c2;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> len1 - len2;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// StringLatin1.compareToUTF16</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">compareToUTF16</span><span class="params">(<span class="type">byte</span>[] value, <span class="type">byte</span>[] other)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">len1</span> <span class="operator">=</span> length(value);</span><br><span class="line">        <span class="type">int</span> <span class="variable">len2</span> <span class="operator">=</span> StringUTF16.length(other);</span><br><span class="line">        <span class="keyword">return</span> compareToUTF16Values(value, other, len1, len2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">compareToUTF16Values</span><span class="params">(<span class="type">byte</span>[] value, <span class="type">byte</span>[] other, <span class="type">int</span> len1, <span class="type">int</span> len2)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">lim</span> <span class="operator">=</span> Math.min(len1, len2);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> <span class="number">0</span>; k &lt; lim; k++) &#123;</span><br><span class="line">            <span class="type">char</span> <span class="variable">c1</span> <span class="operator">=</span> getChar(value, k);</span><br><span class="line">            <span class="type">char</span> <span class="variable">c2</span> <span class="operator">=</span> StringUTF16.getChar(other, k);</span><br><span class="line">            <span class="keyword">if</span> (c1 != c2) &#123;</span><br><span class="line">                <span class="keyword">return</span> c1 - c2;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> len1 - len2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// StringUTF16.compareToLatin1</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">compareToLatin1</span><span class="params">(<span class="type">byte</span>[] value, <span class="type">byte</span>[] other)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> -StringLatin1.compareToUTF16(other, value);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="七、String类的startWith方法"><a href="#七、String类的startWith方法" class="headerlink" title="七、String类的startWith方法"></a>七、String类的startWith方法</h2><p><img src="/../../../../../../imgs/String%E7%B1%BB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/image-20230908215142595.png" alt="image-20230908215142595"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">startsWith</span><span class="params">(String prefix, <span class="type">int</span> toffset)</span> &#123;</span><br><span class="line">        <span class="comment">// Note: toffset might be near -1&gt;&gt;&gt;1.</span></span><br><span class="line">        <span class="keyword">if</span> (toffset &lt; <span class="number">0</span> || toffset &gt; length() - prefix.length()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">byte</span> ta[] = value;</span><br><span class="line">        <span class="type">byte</span> pa[] = prefix.value;</span><br><span class="line">        <span class="type">int</span> <span class="variable">po</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">pc</span> <span class="operator">=</span> pa.length;</span><br><span class="line">        <span class="keyword">if</span> (coder() == prefix.coder()) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">to</span> <span class="operator">=</span> isLatin1() ? toffset : toffset &lt;&lt; <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">while</span> (po &lt; pc) &#123;</span><br><span class="line">                <span class="keyword">if</span> (ta[to++] != pa[po++]) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (isLatin1()) &#123;  <span class="comment">// &amp;&amp; pcoder == UTF16</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// coder == UTF16 &amp;&amp; pcoder == LATIN1)</span></span><br><span class="line">            <span class="keyword">while</span> (po &lt; pc) &#123;</span><br><span class="line">                <span class="keyword">if</span> (StringUTF16.getChar(ta, toffset++) != (pa[po++] &amp; <span class="number">0xff</span>)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">               &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">startsWith</span><span class="params">(String prefix)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> startsWith(prefix, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">endsWith</span><span class="params">(String suffix)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> startsWith(suffix, length() - suffix.length());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="八、String类的hashCode方法"><a href="#八、String类的hashCode方法" class="headerlink" title="八、String类的hashCode方法"></a>八、String类的hashCode方法</h2><p><img src="/../../../../../../imgs/String%E7%B1%BB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/image-20230908215852842.png" alt="image-20230908215852842"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> hash;</span><br><span class="line">    	<span class="comment">// 空字符串的哈希值为0</span></span><br><span class="line">        <span class="keyword">if</span> (h == <span class="number">0</span> &amp;&amp; value.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            hash = h = isLatin1() ? StringLatin1.hashCode(value)</span><br><span class="line">                                  : StringUTF16.hashCode(value);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> h;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// StringLatin1.hashCode</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">(<span class="type">byte</span>[] value)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">byte</span> v : value) &#123;</span><br><span class="line">            h = <span class="number">31</span> * h + (v &amp; <span class="number">0xff</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> h;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// StringUTF16.hashCode</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">(<span class="type">byte</span>[] value)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> value.length &gt;&gt; <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">            h = <span class="number">31</span> * h + getChar(value, i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> h;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="九、String类的subString方法"><a href="#九、String类的subString方法" class="headerlink" title="九、String类的subString方法"></a>九、String类的subString方法</h2><p>subString方法是<code>截取子字符串</code>的方法，截取的开始索引范围是<code>0~length</code>。</p>
<p><img src="/../../../../../../imgs/String%E7%B1%BB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/image-20230909084046439.png" alt="image-20230909084046439"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">substring</span><span class="params">(<span class="type">int</span> beginIndex)</span> &#123;</span><br><span class="line">    	<span class="comment">// 起始坐标不能为负数</span></span><br><span class="line">        <span class="keyword">if</span> (beginIndex &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">StringIndexOutOfBoundsException</span>(beginIndex);</span><br><span class="line">        &#125;</span><br><span class="line">    	<span class="comment">// 子字符串的长度不能为负数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">subLen</span> <span class="operator">=</span> length() - beginIndex;</span><br><span class="line">        <span class="keyword">if</span> (subLen &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">StringIndexOutOfBoundsException</span>(subLen);</span><br><span class="line">        &#125;</span><br><span class="line">    	<span class="comment">// 快速返回自身引用</span></span><br><span class="line">        <span class="keyword">if</span> (beginIndex == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> isLatin1() ? StringLatin1.newString(value, beginIndex, subLen)</span><br><span class="line">                          : StringUTF16.newString(value, beginIndex, subLen);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// StringLatin1.newString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">newString</span><span class="params">(<span class="type">byte</span>[] val, <span class="type">int</span> index, <span class="type">int</span> len)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(Arrays.copyOfRange(val, index, index + len),</span><br><span class="line">                          LATIN1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// StringUTF16.newString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">newString</span><span class="params">(<span class="type">byte</span>[] val, <span class="type">int</span> index, <span class="type">int</span> len)</span> &#123;</span><br><span class="line">    	<span class="comment">// 尝试使用Lantin1编码方式是否可行</span></span><br><span class="line">        <span class="keyword">if</span> (String.COMPACT_STRINGS) &#123;</span><br><span class="line">            <span class="type">byte</span>[] buf = compress(val, index, len);</span><br><span class="line">            <span class="keyword">if</span> (buf != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(buf, LATIN1);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">last</span> <span class="operator">=</span> index + len;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(Arrays.copyOfRange(val, index &lt;&lt; <span class="number">1</span>, last &lt;&lt; <span class="number">1</span>), UTF16);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] compress(<span class="type">byte</span>[] val, <span class="type">int</span> off, <span class="type">int</span> len) &#123;</span><br><span class="line">        <span class="type">byte</span>[] ret = <span class="keyword">new</span> <span class="title class_">byte</span>[len];</span><br><span class="line">        <span class="keyword">if</span> (compress(val, off, ret, <span class="number">0</span>, len) == len) &#123;</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">compress</span><span class="params">(<span class="type">byte</span>[] src, <span class="type">int</span> srcOff, <span class="type">byte</span>[] dst, <span class="type">int</span> dstOff, <span class="type">int</span> len)</span> &#123;</span><br><span class="line">        <span class="comment">// We need a range check here because &#x27;getChar&#x27; has no checks</span></span><br><span class="line">        checkBoundsOffCount(srcOff, len, src);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">            <span class="type">char</span> <span class="variable">c</span> <span class="operator">=</span> getChar(src, srcOff);</span><br><span class="line">            <span class="comment">// 检查char码元值是否超出Lantin1的最大表示范围</span></span><br><span class="line">            <span class="keyword">if</span> (c &gt; <span class="number">0xFF</span>) &#123;</span><br><span class="line">                len = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            dst[dstOff] = (<span class="type">byte</span>)c;</span><br><span class="line">            srcOff++;</span><br><span class="line">            dstOff++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> len;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// UTF-16编码方式下两个字节表示一个16位的char码元</span></span><br><span class="line"><span class="keyword">static</span> <span class="type">char</span> <span class="title function_">getChar</span><span class="params">(<span class="type">byte</span>[] val, <span class="type">int</span> index)</span> &#123;</span><br><span class="line">        <span class="keyword">assert</span> index &gt;= <span class="number">0</span> &amp;&amp; index &lt; length(val) : <span class="string">&quot;Trusted caller missed bounds check&quot;</span>;</span><br><span class="line">        index &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> (<span class="type">char</span>)(((val[index++] &amp; <span class="number">0xff</span>) &lt;&lt; HI_BYTE_SHIFT) |</span><br><span class="line">                      ((val[index]   &amp; <span class="number">0xff</span>) &lt;&lt; LO_BYTE_SHIFT));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>从上面可以看出，最终很多都会调用到<code>Arrays.copyOfRange</code>方法进行实际的数组拷贝操作，需要注意的是当需要拷贝的长度即to-from大于原始数组的剩余长度即origin.length-from时，进行<code>补零</code>操作！</p>
<p><img src="/../../../../../../imgs/String%E7%B1%BB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/image-20230909084555312.png" alt="image-20230909084555312"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] copyOfRange(<span class="type">byte</span>[] original, <span class="type">int</span> from, <span class="type">int</span> to) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">newLength</span> <span class="operator">=</span> to - from;</span><br><span class="line">        <span class="keyword">if</span> (newLength &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(from + <span class="string">&quot; &gt; &quot;</span> + to);</span><br><span class="line">        <span class="type">byte</span>[] copy = <span class="keyword">new</span> <span class="title class_">byte</span>[newLength];</span><br><span class="line">        System.arraycopy(original, from, copy, <span class="number">0</span>,</span><br><span class="line">                         Math.min(original.length - from, newLength));</span><br><span class="line">        <span class="keyword">return</span> copy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">arraycopy</span><span class="params">(Object src,  <span class="type">int</span>  srcPos,</span></span><br><span class="line"><span class="params">                                        Object dest, <span class="type">int</span> destPos,</span></span><br><span class="line"><span class="params">                                        <span class="type">int</span> length)</span>;</span><br></pre></td></tr></table></figure>

<p>当然，subString方法还有重载方法，可以控制子字符串的起始位置和终止位置，具体如下：</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">substring</span><span class="params">(<span class="type">int</span> beginIndex, <span class="type">int</span> endIndex)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> length();</span><br><span class="line">        checkBoundsBeginEnd(beginIndex, endIndex, length);</span><br><span class="line">        <span class="type">int</span> <span class="variable">subLen</span> <span class="operator">=</span> endIndex - beginIndex;</span><br><span class="line">    	<span class="comment">// 等价于subString(0)</span></span><br><span class="line">        <span class="keyword">if</span> (beginIndex == <span class="number">0</span> &amp;&amp; endIndex == length) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> isLatin1() ? StringLatin1.newString(value, beginIndex, subLen)</span><br><span class="line">                          : StringUTF16.newString(value, beginIndex, subLen);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">checkBoundsBeginEnd</span><span class="params">(<span class="type">int</span> begin, <span class="type">int</span> end, <span class="type">int</span> length)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (begin &lt; <span class="number">0</span> || begin &gt; end || end &gt; length) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">StringIndexOutOfBoundsException</span>(</span><br><span class="line">                <span class="string">&quot;begin &quot;</span> + begin + <span class="string">&quot;, end &quot;</span> + end + <span class="string">&quot;, length &quot;</span> + length);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="十、String类的concat方法"><a href="#十、String类的concat方法" class="headerlink" title="十、String类的concat方法"></a>十、String类的concat方法</h2><p>将指定的字符串连接到此字符串的末尾。如果参数字符串的长度为0，则返回此String对象。否则，将返回一个String表示字符序列的对象，该字符序列是此String对象表示的字符序列和参数字符串表示的字符序列的串联。</p>
<p><img src="/../../../../../../imgs/String%E7%B1%BB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/image-20230909104232598.png" alt="image-20230909104232598"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">concat</span><span class="params">(String str)</span> &#123;</span><br><span class="line">    	<span class="comment">// 参数字符串是空字符串，直接返回原字符串对象</span></span><br><span class="line">        <span class="keyword">if</span> (str.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    	<span class="comment">// 编码方式相同时，直接拼接即可</span></span><br><span class="line">        <span class="keyword">if</span> (coder() == str.coder()) &#123;</span><br><span class="line">            <span class="type">byte</span>[] val = <span class="built_in">this</span>.value;</span><br><span class="line">            <span class="type">byte</span>[] oval = str.value;</span><br><span class="line">            <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> val.length + oval.length;</span><br><span class="line">            <span class="type">byte</span>[] buf = Arrays.copyOf(val, len);</span><br><span class="line">            System.arraycopy(oval, <span class="number">0</span>, buf, val.length, oval.length);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(buf, coder);</span><br><span class="line">        &#125;</span><br><span class="line">    	<span class="comment">// 编码方式不同时，统一转换成UTF-16</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> length();</span><br><span class="line">        <span class="type">int</span> <span class="variable">olen</span> <span class="operator">=</span> str.length();</span><br><span class="line">        <span class="type">byte</span>[] buf = StringUTF16.newBytesFor(len + olen);</span><br><span class="line">        getBytes(buf, <span class="number">0</span>, UTF16);</span><br><span class="line">        str.getBytes(buf, len, UTF16);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(buf, UTF16);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">getBytes</span><span class="params">(<span class="type">byte</span> dst[], <span class="type">int</span> dstBegin, <span class="type">byte</span> coder)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (coder() == coder) &#123;</span><br><span class="line">            System.arraycopy(value, <span class="number">0</span>, dst, dstBegin &lt;&lt; coder, value.length);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;    <span class="comment">// this.coder == LATIN &amp;&amp; coder == UTF16</span></span><br><span class="line">            StringLatin1.inflate(value, <span class="number">0</span>, dst, dstBegin, value.length);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a target="_blank" rel="noopener" href="http://github.com/hulingF">Projects</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#String%E7%B1%BB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90"><span class="toc-number">1.</span> <span class="toc-text">String类源码剖析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81String%E7%B1%BB%E7%9A%84%E7%AE%80%E4%BB%8B"><span class="toc-number">1.1.</span> <span class="toc-text">一、String类的简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81String%E7%B1%BB%E7%9A%84%E9%87%8D%E8%A6%81%E5%AD%97%E6%AE%B5"><span class="toc-number">1.2.</span> <span class="toc-text">二、String类的重要字段</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81String%E7%B1%BB%E7%9A%84%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95"><span class="toc-number">1.3.</span> <span class="toc-text">三、String类的构造方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81String%E7%B1%BB%E7%9A%84%E4%B8%80%E4%BA%9B%E6%96%B9%E6%B3%95"><span class="toc-number">1.4.</span> <span class="toc-text">四、String类的一些方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81String%E7%B1%BB%E7%9A%84equals%E6%96%B9%E6%B3%95"><span class="toc-number">1.5.</span> <span class="toc-text">五、String类的equals方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E3%80%81String%E7%B1%BB%E7%9A%84compareTo%E6%96%B9%E6%B3%95"><span class="toc-number">1.6.</span> <span class="toc-text">六、String类的compareTo方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83%E3%80%81String%E7%B1%BB%E7%9A%84startWith%E6%96%B9%E6%B3%95"><span class="toc-number">1.7.</span> <span class="toc-text">七、String类的startWith方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB%E3%80%81String%E7%B1%BB%E7%9A%84hashCode%E6%96%B9%E6%B3%95"><span class="toc-number">1.8.</span> <span class="toc-text">八、String类的hashCode方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B9%9D%E3%80%81String%E7%B1%BB%E7%9A%84subString%E6%96%B9%E6%B3%95"><span class="toc-number">1.9.</span> <span class="toc-text">九、String类的subString方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%81%E3%80%81String%E7%B1%BB%E7%9A%84concat%E6%96%B9%E6%B3%95"><span class="toc-number">1.10.</span> <span class="toc-text">十、String类的concat方法</span></a></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://hulingf.github.io/2023/09/08/String%E7%B1%BB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://hulingf.github.io/2023/09/08/String%E7%B1%BB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/&text=String类源码剖析"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://hulingf.github.io/2023/09/08/String%E7%B1%BB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/&title=String类源码剖析"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://hulingf.github.io/2023/09/08/String%E7%B1%BB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/&is_video=false&description=String类源码剖析"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=String类源码剖析&body=Check out this article: https://hulingf.github.io/2023/09/08/String%E7%B1%BB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://hulingf.github.io/2023/09/08/String%E7%B1%BB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/&title=String类源码剖析"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://hulingf.github.io/2023/09/08/String%E7%B1%BB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/&title=String类源码剖析"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://hulingf.github.io/2023/09/08/String%E7%B1%BB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/&title=String类源码剖析"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://hulingf.github.io/2023/09/08/String%E7%B1%BB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/&title=String类源码剖析"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://hulingf.github.io/2023/09/08/String%E7%B1%BB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/&name=String类源码剖析&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://hulingf.github.io/2023/09/08/String%E7%B1%BB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/&t=String类源码剖析"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2023
    hulingF
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/hulingF">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
