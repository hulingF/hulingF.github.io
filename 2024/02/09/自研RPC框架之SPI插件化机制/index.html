<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="自研RPC框架之SPI插件化机制1.启动类初始化启动类初始化时会创建默认的Configuration对象，其中包含了一些默认的参数选项，同时还会顺序加载解析XML文件中的配置项和SPI加载插件，JDK默认的SPI机制会遍历加载所有的实现类，这样效率还是相对较低的，无法做到按需加载，因此我们后面会借鉴Dubbo中的SPI改造自己的ServiceLoader。 12345678910111213141">
<meta property="og:type" content="article">
<meta property="og:title" content="自研RPC框架之SPI插件化机制">
<meta property="og:url" content="https://hulingf.github.io/2024/02/09/%E8%87%AA%E7%A0%94RPC%E6%A1%86%E6%9E%B6%E4%B9%8BSPI%E6%8F%92%E4%BB%B6%E5%8C%96%E6%9C%BA%E5%88%B6/index.html">
<meta property="og:site_name" content="大军的秘密花园">
<meta property="og:description" content="自研RPC框架之SPI插件化机制1.启动类初始化启动类初始化时会创建默认的Configuration对象，其中包含了一些默认的参数选项，同时还会顺序加载解析XML文件中的配置项和SPI加载插件，JDK默认的SPI机制会遍历加载所有的实现类，这样效率还是相对较低的，无法做到按需加载，因此我们后面会借鉴Dubbo中的SPI改造自己的ServiceLoader。 12345678910111213141">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://hulingf.github.io/imgs/%E8%87%AA%E7%A0%94RPC%E6%A1%86%E6%9E%B6%E4%B9%8BSPI%E6%8F%92%E4%BB%B6%E5%8C%96%E6%9C%BA%E5%88%B6/image-20240209225707312.png">
<meta property="article:published_time" content="2024-02-09T14:38:38.559Z">
<meta property="article:modified_time" content="2024-08-26T04:59:31.576Z">
<meta property="article:author" content="hulingF">
<meta property="article:tag" content="RPC">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://hulingf.github.io/imgs/%E8%87%AA%E7%A0%94RPC%E6%A1%86%E6%9E%B6%E4%B9%8BSPI%E6%8F%92%E4%BB%B6%E5%8C%96%E6%9C%BA%E5%88%B6/image-20240209225707312.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>自研RPC框架之SPI插件化机制</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/hulingF">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2024/02/10/%E8%87%AA%E7%A0%94RPC%E6%A1%86%E6%9E%B6%E4%B9%8B%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1%E6%B5%81%E7%A8%8B/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2024/02/09/%E8%87%AA%E7%A0%94RPC%E6%A1%86%E6%9E%B6%E4%B9%8B%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://hulingf.github.io/2024/02/09/%E8%87%AA%E7%A0%94RPC%E6%A1%86%E6%9E%B6%E4%B9%8BSPI%E6%8F%92%E4%BB%B6%E5%8C%96%E6%9C%BA%E5%88%B6/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://hulingf.github.io/2024/02/09/%E8%87%AA%E7%A0%94RPC%E6%A1%86%E6%9E%B6%E4%B9%8BSPI%E6%8F%92%E4%BB%B6%E5%8C%96%E6%9C%BA%E5%88%B6/&text=自研RPC框架之SPI插件化机制"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://hulingf.github.io/2024/02/09/%E8%87%AA%E7%A0%94RPC%E6%A1%86%E6%9E%B6%E4%B9%8BSPI%E6%8F%92%E4%BB%B6%E5%8C%96%E6%9C%BA%E5%88%B6/&title=自研RPC框架之SPI插件化机制"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://hulingf.github.io/2024/02/09/%E8%87%AA%E7%A0%94RPC%E6%A1%86%E6%9E%B6%E4%B9%8BSPI%E6%8F%92%E4%BB%B6%E5%8C%96%E6%9C%BA%E5%88%B6/&is_video=false&description=自研RPC框架之SPI插件化机制"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=自研RPC框架之SPI插件化机制&body=Check out this article: https://hulingf.github.io/2024/02/09/%E8%87%AA%E7%A0%94RPC%E6%A1%86%E6%9E%B6%E4%B9%8BSPI%E6%8F%92%E4%BB%B6%E5%8C%96%E6%9C%BA%E5%88%B6/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://hulingf.github.io/2024/02/09/%E8%87%AA%E7%A0%94RPC%E6%A1%86%E6%9E%B6%E4%B9%8BSPI%E6%8F%92%E4%BB%B6%E5%8C%96%E6%9C%BA%E5%88%B6/&title=自研RPC框架之SPI插件化机制"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://hulingf.github.io/2024/02/09/%E8%87%AA%E7%A0%94RPC%E6%A1%86%E6%9E%B6%E4%B9%8BSPI%E6%8F%92%E4%BB%B6%E5%8C%96%E6%9C%BA%E5%88%B6/&title=自研RPC框架之SPI插件化机制"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://hulingf.github.io/2024/02/09/%E8%87%AA%E7%A0%94RPC%E6%A1%86%E6%9E%B6%E4%B9%8BSPI%E6%8F%92%E4%BB%B6%E5%8C%96%E6%9C%BA%E5%88%B6/&title=自研RPC框架之SPI插件化机制"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://hulingf.github.io/2024/02/09/%E8%87%AA%E7%A0%94RPC%E6%A1%86%E6%9E%B6%E4%B9%8BSPI%E6%8F%92%E4%BB%B6%E5%8C%96%E6%9C%BA%E5%88%B6/&title=自研RPC框架之SPI插件化机制"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://hulingf.github.io/2024/02/09/%E8%87%AA%E7%A0%94RPC%E6%A1%86%E6%9E%B6%E4%B9%8BSPI%E6%8F%92%E4%BB%B6%E5%8C%96%E6%9C%BA%E5%88%B6/&name=自研RPC框架之SPI插件化机制&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://hulingf.github.io/2024/02/09/%E8%87%AA%E7%A0%94RPC%E6%A1%86%E6%9E%B6%E4%B9%8BSPI%E6%8F%92%E4%BB%B6%E5%8C%96%E6%9C%BA%E5%88%B6/&t=自研RPC框架之SPI插件化机制"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%87%AA%E7%A0%94RPC%E6%A1%86%E6%9E%B6%E4%B9%8BSPI%E6%8F%92%E4%BB%B6%E5%8C%96%E6%9C%BA%E5%88%B6"><span class="toc-number">1.</span> <span class="toc-text">自研RPC框架之SPI插件化机制</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%90%AF%E5%8A%A8%E7%B1%BB%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">1.1.</span> <span class="toc-text">1.启动类初始化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E9%85%8D%E7%BD%AE%E8%A7%A3%E6%9E%90%E8%BF%87%E7%A8%8B"><span class="toc-number">1.2.</span> <span class="toc-text">2.配置解析过程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-XML%E9%85%8D%E7%BD%AE%E5%8A%A0%E8%BD%BD"><span class="toc-number">1.3.</span> <span class="toc-text">3.XML配置加载</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-SPI%E9%85%8D%E7%BD%AE%E5%8A%A0%E8%BD%BD"><span class="toc-number">1.4.</span> <span class="toc-text">4.SPI配置加载</span></a></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        自研RPC框架之SPI插件化机制
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">hulingF</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-02-09T14:38:38.559Z" class="dt-published" itemprop="datePublished">2024-02-09</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/RPC/" rel="tag">RPC</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h1 id="自研RPC框架之SPI插件化机制"><a href="#自研RPC框架之SPI插件化机制" class="headerlink" title="自研RPC框架之SPI插件化机制"></a>自研RPC框架之SPI插件化机制</h1><h2 id="1-启动类初始化"><a href="#1-启动类初始化" class="headerlink" title="1.启动类初始化"></a>1.启动类初始化</h2><p>启动类初始化时会创建默认的Configuration对象，其中包含了一些默认的参数选项，同时还会顺序加载解析XML文件中的配置项和SPI加载插件，JDK默认的SPI机制会遍历加载所有的实现类，这样效率还是相对较低的，无法做到<code>按需加载</code>，因此我们后面会借鉴Dubbo中的SPI改造自己的ServiceLoader。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OpenrpcBootStrap</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(OpenrpcBootStrap.class);</span><br><span class="line">    <span class="comment">// 静态单例对象</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">OpenrpcBootStrap</span> <span class="variable">openrpcBootStrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OpenrpcBootStrap</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*****************************服务提供方相关字段*****************************/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 全局默认配置</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">Configuration</span> <span class="variable">configuration</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Configuration</span>();</span><br><span class="line">    <span class="comment">// 维护服务提供者发布的服务列表映射</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, ServiceConfig&gt; serviceList = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;(<span class="number">16</span>);</span><br><span class="line">    <span class="comment">// 启动预热钩子方法</span></span><br><span class="line">    <span class="type">OpenrpcStartupHook</span> <span class="variable">startupHook</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OpenrpcStartupHook</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">preheat</span><span class="params">()</span> &#123;</span><br><span class="line">            OpenrpcStartupHook.<span class="built_in">super</span>.preheat();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*****************************服务调用方相关字段*****************************/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 维护服务调用方需要的Netty连接Channel</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;InetSocketAddress, Channel&gt; channelCache = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;(<span class="number">16</span>);</span><br><span class="line">    <span class="comment">// 维护服务调用方的异步结果</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Long, CompletableFuture&lt;Object&gt;&gt; pendingCache = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;(<span class="number">128</span>);</span><br><span class="line">    <span class="comment">// 维护请求的本地线程变量</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;OpenrpcRequest&gt; threadLocal = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*****************************公用的一些方法*****************************/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 私有构造</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">OpenrpcBootStrap</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> OpenrpcBootStrap <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> openrpcBootStrap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> OpenrpcBootStrap <span class="title function_">application</span><span class="params">(String appName)</span> &#123;</span><br><span class="line">        configuration.setAppName(appName);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*****************************服务提供方相关方法*****************************/</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">limiter</span><span class="params">(Limiter limiter)</span> &#123;</span><br><span class="line">        configuration.setLimiter(limiter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setStartupHook</span><span class="params">(OpenrpcStartupHook startupHook)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.startupHook = startupHook;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> OpenrpcBootStrap <span class="title function_">publish</span><span class="params">(ServiceConfig service)</span> &#123;</span><br><span class="line">        configuration.getRegistry().register(service);</span><br><span class="line">        serviceList.put(service.getInterface().getName(), service);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> OpenrpcBootStrap <span class="title function_">scanPackage</span><span class="params">(String packageName)</span> &#123;</span><br><span class="line">        configuration.setPackageName(packageName);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;服务正在启动...&quot;</span>);</span><br><span class="line">        <span class="comment">// 注册关闭服务端应用程序的钩子函数</span></span><br><span class="line">        Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> <span class="title class_">OpenrpcShutdownHook</span>());</span><br><span class="line">        log.info(<span class="string">&quot;添加关闭钩子&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Netty的Reactor线程池，初始化了一个NioEventLoop数组，用来处理I/O操作，如接受新的连接和读写数据</span></span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">boss</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">worker</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ServerBootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();</span><br><span class="line">            bootstrap.group(boss, worker)</span><br><span class="line">                    .channel(NioServerSocketChannel.class)</span><br><span class="line">                    <span class="comment">// TCP默认开启了Nagle算法，该算法的作用是尽可能的发送大数据块，减少网络传输。TCP_NODELAY参数的作用就是控制是否启用Nagle算法。</span></span><br><span class="line">                    .childOption(ChannelOption.TCP_NODELAY, <span class="literal">true</span>)</span><br><span class="line">                    <span class="comment">// 是否开启TCP底层心跳机制</span></span><br><span class="line">                    .childOption(ChannelOption.SO_KEEPALIVE, <span class="literal">true</span>)</span><br><span class="line">                    <span class="comment">// 表示系统用于临时存放已完成三次握手的请求的队列的最大长度,如果连接建立频繁，服务器处理创建新连接较慢，可以适当调大这个参数</span></span><br><span class="line">                    .option(ChannelOption.SO_BACKLOG, <span class="number">128</span>)</span><br><span class="line">                    .localAddress(configuration.getPort())</span><br><span class="line">                    .childHandler(<span class="keyword">new</span> <span class="title class_">ProviderChannelInitializer</span>());</span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">channelFuture</span> <span class="operator">=</span> bootstrap.bind().sync();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 启动预热钩子,用户可以模拟调用和启动初始化缓存等工作</span></span><br><span class="line">            startupHook.preheat();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 服务已经完全启动，开始进行服务注册</span></span><br><span class="line">            registerService(configuration.getPackageName());</span><br><span class="line">            channelFuture.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                boss.shutdownGracefully().sync();</span><br><span class="line">                worker.shutdownGracefully().sync();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">registerService</span><span class="params">(String packageName)</span> &#123;</span><br><span class="line">        <span class="comment">// 延迟暴露</span></span><br><span class="line">        log.info(<span class="string">&quot;服务已经启动完毕，开始进行服务注册&quot;</span>);</span><br><span class="line">        <span class="comment">// 扫描指定路径下的所有包含OpenrpcService注解的实现类</span></span><br><span class="line">        Set&lt;Class&lt;?&gt;&gt; classes = ClassScanner.scanPackageByAnnotation(packageName, OpenrpcService.class);</span><br><span class="line">        <span class="comment">// 服务注册</span></span><br><span class="line">        <span class="keyword">for</span> (Class&lt;?&gt; clazz : classes) &#123;</span><br><span class="line">            Class&lt;?&gt;[] interfaces = clazz.getInterfaces();</span><br><span class="line">            <span class="keyword">for</span> (Class&lt;?&gt; anInterface : interfaces) &#123;</span><br><span class="line">                <span class="type">ServiceConfig</span> <span class="variable">serviceConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServiceConfig</span>();</span><br><span class="line">                serviceConfig.setInterface(anInterface);</span><br><span class="line">                serviceConfig.setWeight(clazz.getAnnotation(OpenrpcService.class).weight());</span><br><span class="line">                serviceConfig.setGroup(clazz.getAnnotation(OpenrpcService.class).group());</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">Object</span> <span class="variable">serviceImpl</span> <span class="operator">=</span> clazz.getConstructor().newInstance();</span><br><span class="line">                    serviceConfig.setRef(serviceImpl);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InstantiationException | IllegalAccessException | InvocationTargetException |</span><br><span class="line">                         NoSuchMethodException e) &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;接口实现类的无参构造函数不存在&quot;</span>);</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">                publish(serviceConfig);</span><br><span class="line">                log.info(<span class="string">&quot;服务注册成功:&#123;&#125;&quot;</span>, serviceConfig.getInterface().getName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*****************************服务调用方相关方法*****************************/</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> OpenrpcBootStrap <span class="title function_">reference</span><span class="params">(ReferenceConfig&lt;?&gt; reference)</span> &#123;</span><br><span class="line">        reference.setRegistry(configuration.getRegistry());</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> OpenrpcBootStrap <span class="title function_">serializeProtocol</span><span class="params">(String serializeProtocol)</span> &#123;</span><br><span class="line">        configuration.setSerializeProtocol(serializeProtocol);</span><br><span class="line">        configuration.setSerializer(SerializerFactory.getSerializer(serializeProtocol));</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> OpenrpcBootStrap <span class="title function_">compressProtocol</span><span class="params">(String compressProtocol)</span> &#123;</span><br><span class="line">        configuration.setCompressProtocol(compressProtocol);</span><br><span class="line">        configuration.setCompressor(CompressorFactory.getCompressor(compressProtocol));</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-配置解析过程"><a href="#2-配置解析过程" class="headerlink" title="2.配置解析过程"></a>2.配置解析过程</h2><p>我们的自研RPC框架有四种配置声明方式，优先级从高到低分别是<code>代码显式配置</code>、<code>SPI配置</code>、<code>XML配置</code>、<code>默认配置</code>，其中应用名称默认为”default”，服务提供方端口号默认为8123，包扫描路径默认为空，注册中心默认为空，负载均衡策略默认为轮询式负载均衡，序列化协议默认是hession，压缩协议默认不开启，压缩阈值默认为0，分布式ID生成器的节点ID默认为空即使用<code>主机MAC地址的低10位</code>，服务限流器默认不开启。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 全局配置信息</span></span><br><span class="line"><span class="comment"> * 优先级：代码显式声明 &gt; SPI配置 &gt; XML配置 &gt; 默认配置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Configuration</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(Configuration.class);</span><br><span class="line">    <span class="comment">// 默认应用名称</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">appName</span> <span class="operator">=</span> <span class="string">&quot;default&quot;</span>;</span><br><span class="line">    <span class="comment">// 默认端口号配置</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">8123</span>;</span><br><span class="line">    <span class="comment">// 默认包扫描路径</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">packageName</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="comment">// 注册中心配置</span></span><br><span class="line">    <span class="keyword">private</span> Registry registry;</span><br><span class="line">    <span class="keyword">private</span> RegistryConfig registryConfig;</span><br><span class="line">    <span class="comment">// 默认负载均衡器配置</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">loadBalancerType</span> <span class="operator">=</span> <span class="string">&quot;roundRobin&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">LoadBalancer</span> <span class="variable">loadBalancer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RoundRobinLoadBalancer</span>();</span><br><span class="line">    <span class="comment">// 默认序列化协议配置</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">serializeProtocol</span> <span class="operator">=</span> <span class="string">&quot;hessian&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> ObjectWrapper&lt;Serializer&gt; serializer = SerializerFactory.getSerializer(serializeProtocol);</span><br><span class="line">    <span class="comment">// 默认压缩协议配置</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">compressProtocol</span> <span class="operator">=</span> <span class="string">&quot;none&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> ObjectWrapper&lt;Compressor&gt; compressor = CompressorFactory.getCompressor(compressProtocol);</span><br><span class="line">    <span class="comment">// 默认压缩阈值</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">compressThreshold</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 默认分布式ID生成器</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">IdWorker</span> <span class="variable">idWorker</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IdWorker</span>(<span class="literal">null</span>);</span><br><span class="line">    <span class="comment">// 默认服务限流器配置</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Limiter</span> <span class="variable">limiter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NoneLimiter</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Configuration</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 1.默认配置</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.读取XML配置文件的配置信息</span></span><br><span class="line">        <span class="type">XMLResolver</span> <span class="variable">xmlResolver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XMLResolver</span>(<span class="built_in">this</span>);</span><br><span class="line">        xmlResolver.loadFromXML();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.SPI机制发现相关配置</span></span><br><span class="line">        <span class="type">SPIResolver</span> <span class="variable">spiResolver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SPIResolver</span>(<span class="built_in">this</span>);</span><br><span class="line">        spiResolver.loadFromSPI();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.代码显式配置</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-XML配置加载"><a href="#3-XML配置加载" class="headerlink" title="3.XML配置加载"></a>3.XML配置加载</h2><p>首先我们自定义了XML配置文件的元信息<code>openrpc-config.dtd</code>，其中包含了XML配置文件中所有可能的配置选项和形式，完整的配置文件<code>openrpc-config.xml</code>的内容如下:</p>
<p><img src="/imgs/%E8%87%AA%E7%A0%94RPC%E6%A1%86%E6%9E%B6%E4%B9%8BSPI%E6%8F%92%E4%BB%B6%E5%8C%96%E6%9C%BA%E5%88%B6/image-20240209225707312.png" alt="image-20240209225707312"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">loadFromXML</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 创建文档对象</span></span><br><span class="line">        <span class="type">DocumentBuilderFactory</span> <span class="variable">factory</span> <span class="operator">=</span> DocumentBuilderFactory.newInstance();</span><br><span class="line">        <span class="comment">// 禁用DTD校验</span></span><br><span class="line">        factory.setValidating(<span class="literal">false</span>);</span><br><span class="line">        <span class="comment">// 禁用外部实体解析</span></span><br><span class="line">        factory.setFeature(<span class="string">&quot;http://apache.org/xml/features/nonvalidating/load-external-dtd&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">        <span class="comment">// 读取XML配置文件的配置项</span></span><br><span class="line">        <span class="type">DocumentBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> factory.newDocumentBuilder();</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> ClassLoader.getSystemClassLoader().getResourceAsStream(<span class="string">&quot;openrpc-config.xml&quot;</span>);</span><br><span class="line">        <span class="type">Document</span> <span class="variable">doc</span> <span class="operator">=</span> builder.parse(inputStream);</span><br><span class="line">        <span class="comment">// 获取Xpath解析器</span></span><br><span class="line">        <span class="type">XPathFactory</span> <span class="variable">xPathfactory</span> <span class="operator">=</span> XPathFactory.newInstance();</span><br><span class="line">        <span class="type">XPath</span> <span class="variable">xpath</span> <span class="operator">=</span> xPathfactory.newXPath();</span><br><span class="line">        <span class="comment">// 解析端口号</span></span><br><span class="line">        configuration.setPort(resolvePort(doc, xpath));</span><br><span class="line">        <span class="comment">// 解析应用名称</span></span><br><span class="line">        configuration.setAppName(resolveAppName(doc, xpath));</span><br><span class="line">        <span class="comment">// 解析注册中心</span></span><br><span class="line">        configuration.setRegistryConfig(resolveRegistryConfig(doc, xpath));</span><br><span class="line">        <span class="comment">// 解析负载均衡器</span></span><br><span class="line">        configuration.setLoadBalancerType(resolveLoadBalancerType(doc, xpath));</span><br><span class="line">        configuration.setLoadBalancer(LoadBalancerFactory.getLoadBalancer(configuration.getLoadBalancerType()));</span><br><span class="line">        <span class="comment">// 解析压缩类型</span></span><br><span class="line">        configuration.setCompressProtocol(resolveCompressType(doc, xpath));</span><br><span class="line">        configuration.setCompressor(CompressorFactory.getCompressor(configuration.getCompressProtocol()));</span><br><span class="line">        <span class="comment">// 解析压缩阈值</span></span><br><span class="line">        configuration.setCompressThreshold(resolveCompressThreshold(doc, xpath));</span><br><span class="line">        <span class="comment">// 解析序列化类型</span></span><br><span class="line">        configuration.setSerializeProtocol(resolveSerializeType(doc, xpath));</span><br><span class="line">        configuration.setSerializer(SerializerFactory.getSerializer(configuration.getSerializeProtocol()));</span><br><span class="line">        <span class="comment">// 解析自定义负载均衡器</span></span><br><span class="line">        configuration.setLoadBalancer(resolveLoadBalancer(doc, xpath));</span><br><span class="line">        <span class="comment">// 解析ID生成器</span></span><br><span class="line">        configuration.setIdWorker(resolveIdWorker(doc, xpath));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ParserConfigurationException | SAXException | IOException e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;解析过程中发生异常&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面涉及到的所有解析方法内部其实都是调用了三个XML配置解析的工具方法，分别是<code>解析配置节点的内容(如&lt;port&gt;8080&lt;/port&gt;中的8080)</code>、<code>解析配置节点的属性值(如&lt;serializeType type=&quot;hessian&quot;/&gt;中的type属性值)</code>、<code>解析并实例化配置节点表示的类对象(如&lt;loadBalancer class=&quot;io.github.hulingf.loadbalancer.impl.RoundRobinLoadBalancer&quot;/&gt;中的class属性表示的类对象)</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> String <span class="title function_">parseString</span><span class="params">(Document doc, XPath xpath, String expression)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">XPathExpression</span> <span class="variable">expr</span> <span class="operator">=</span> xpath.compile(expression);</span><br><span class="line">        <span class="type">Node</span> <span class="variable">targetNode</span> <span class="operator">=</span> (Node) expr.evaluate(doc, XPathConstants.NODE);</span><br><span class="line">        <span class="keyword">if</span> (targetNode == <span class="literal">null</span>) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">return</span> targetNode.getTextContent();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (XPathExpressionException e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;解析节点的内容时发生异常&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">parseString</span><span class="params">(Document doc, XPath xpath, String expression, String attributeName)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">XPathExpression</span> <span class="variable">expr</span> <span class="operator">=</span> xpath.compile(expression);</span><br><span class="line">        <span class="type">Node</span> <span class="variable">targetNode</span> <span class="operator">=</span> (Node) expr.evaluate(doc, XPathConstants.NODE);</span><br><span class="line">        <span class="keyword">if</span> (targetNode == <span class="literal">null</span>) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">item</span> <span class="operator">=</span> targetNode.getAttributes().getNamedItem(attributeName);</span><br><span class="line">        <span class="keyword">if</span> (item == <span class="literal">null</span>) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">return</span> item.getNodeValue();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (XPathExpressionException e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;解析节点的属性时发生异常&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> &lt;T&gt; T <span class="title function_">parseObject</span><span class="params">(Document doc, XPath xpath, String expression, Class&lt;?&gt;[] paramTypes, Object... paramValues)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">XPathExpression</span> <span class="variable">expr</span> <span class="operator">=</span> xpath.compile(expression);</span><br><span class="line">        <span class="type">Node</span> <span class="variable">targetNode</span> <span class="operator">=</span> (Node) expr.evaluate(doc, XPathConstants.NODE);</span><br><span class="line">        <span class="keyword">if</span> (targetNode == <span class="literal">null</span>) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">item</span> <span class="operator">=</span> targetNode.getAttributes().getNamedItem(<span class="string">&quot;class&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (item == <span class="literal">null</span>) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> item.getNodeValue();</span><br><span class="line">        Class&lt;?&gt; aClass = Class.forName(className);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">instant</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (paramTypes == <span class="literal">null</span>) &#123;</span><br><span class="line">            instant = aClass.getConstructor().newInstance();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            instant = aClass.getConstructor(paramTypes).newInstance(paramValues);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (T) instant;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException | NoSuchMethodException | InstantiationException | IllegalAccessException |</span><br><span class="line">             InvocationTargetException | XPathExpressionException e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;解析节点对应的类对象时发现异常&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-SPI配置加载"><a href="#4-SPI配置加载" class="headerlink" title="4.SPI配置加载"></a>4.SPI配置加载</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">loadFromSPI</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 加载负载均衡器插件</span></span><br><span class="line">        ExtensionLoader&lt;LoadBalancer&gt; extensionLoader = ExtensionLoader.getExtensionLoader(LoadBalancer.class);</span><br><span class="line">        <span class="type">LoadBalancer</span> <span class="variable">loadBalancer</span> <span class="operator">=</span> extensionLoader.getExtension(configuration.getLoadBalancerType());</span><br><span class="line">        configuration.setLoadBalancer(loadBalancer);</span><br><span class="line">        <span class="comment">// 加载服务限流器插件，逻辑跟上面类似，省略</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>借鉴Dubbo的SPI机制，我们设计了自己的服务加载器，可以实现按需加载指定插件，效率更高，大致流程就是根据负载均衡插件名称如<code>random</code>从缓存<code>cachedInstances</code>中查找实现类实例，如果发现不存在则需要<code>加锁+双重检查</code>进行实现类单实例的创建；创建时首先从<code>cachedClasses</code>(如果为空同样需要<code>加锁+双重检查</code>创建)中根据指定负载均衡插件名称从<code>META-INF/extensions/</code>目录下的SPI文件中查找其类对象，然后根据类对象从<code>EXTENSION_INSTANCES</code>中获取对应实例，如果不存在则通过反射创建。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ExtensionLoader</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(ExtensionLoader.class);</span><br><span class="line">    <span class="comment">// SPI配置基础目录</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SERVICE_DIRECTORY</span> <span class="operator">=</span> <span class="string">&quot;META-INF/extensions/&quot;</span>;</span><br><span class="line">    <span class="comment">// 每个接口类型对应的扩展加载器</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, ExtensionLoader&lt;?&gt;&gt; EXTENSION_LOADERS = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">// 接口实现类对应的实例对象缓存</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, Object&gt; EXTENSION_INSTANCES = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">// 接口类型</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;?&gt; type;</span><br><span class="line">    <span class="comment">// 接口实现类实例的缓存(SPI文件的内容类似于random=com.huling.RandomLoadBalancer)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Holder&lt;Object&gt;&gt; cachedInstances = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">// 接口实现类的缓存，会查看SPI目录下的所有接口实现类</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Holder&lt;Map&lt;String, Class&lt;?&gt;&gt;&gt; cachedClasses = <span class="keyword">new</span> <span class="title class_">Holder</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">ExtensionLoader</span><span class="params">(Class&lt;?&gt; type)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.type = type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;S&gt; ExtensionLoader&lt;S&gt; <span class="title function_">getExtensionLoader</span><span class="params">(Class&lt;S&gt; type)</span> &#123;</span><br><span class="line">        <span class="comment">// 接口类型不能为空</span></span><br><span class="line">        <span class="keyword">if</span> (type == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Extension type should not be null.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 接口类型保证</span></span><br><span class="line">        <span class="keyword">if</span> (!type.isInterface()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Extension type must be an interface.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 接口类型需要标注有@SPI注解</span></span><br><span class="line">        <span class="keyword">if</span> (type.getAnnotation(SPI.class) == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Extension type must be annotated by @SPI&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// firstly get from cache, if not hit, create one</span></span><br><span class="line">        ExtensionLoader&lt;S&gt; extensionLoader = (ExtensionLoader&lt;S&gt;) EXTENSION_LOADERS.get(type);</span><br><span class="line">        <span class="keyword">if</span> (extensionLoader == <span class="literal">null</span>) &#123;</span><br><span class="line">            EXTENSION_LOADERS.putIfAbsent(type, <span class="keyword">new</span> <span class="title class_">ExtensionLoader</span>&lt;S&gt;(type));</span><br><span class="line">            extensionLoader = (ExtensionLoader&lt;S&gt;) EXTENSION_LOADERS.get(type);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> extensionLoader;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">getExtension</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isBlank(name)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Extension name should not be null or empty.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// firstly get from cache, if not hit, create one</span></span><br><span class="line">        Holder&lt;Object&gt; holder = cachedInstances.get(name);</span><br><span class="line">        <span class="keyword">if</span> (holder == <span class="literal">null</span>) &#123;</span><br><span class="line">            cachedInstances.putIfAbsent(name, <span class="keyword">new</span> <span class="title class_">Holder</span>&lt;&gt;());</span><br><span class="line">            holder = cachedInstances.get(name);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// create a singleton if no instance exists</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">instance</span> <span class="operator">=</span> holder.get();</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 锁的是接口实现类的holder实例</span></span><br><span class="line">            <span class="comment">// 多实例间的并发加锁可以同时进行加快多实例的生成，单个实例的并发加锁只会允许一个实例的生成</span></span><br><span class="line">            <span class="keyword">synchronized</span> (holder) &#123;</span><br><span class="line">                <span class="comment">// 双重检查的单例实例生成，holder内部维护的实例使用volatile修饰</span></span><br><span class="line">                instance = holder.get();</span><br><span class="line">                <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</span><br><span class="line">                    instance = createExtension(name);</span><br><span class="line">                    holder.set(instance);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (T) instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> T <span class="title function_">createExtension</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="comment">// load all extension classes of type T from file and get specific one by name</span></span><br><span class="line">        Class&lt;?&gt; clazz = getExtensionClasses().get(name);</span><br><span class="line">        <span class="keyword">if</span> (clazz == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;No such extension of name &quot;</span> + name);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">T</span> <span class="variable">instance</span> <span class="operator">=</span> (T) EXTENSION_INSTANCES.get(clazz);</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                EXTENSION_INSTANCES.putIfAbsent(clazz, clazz.newInstance());</span><br><span class="line">                instance = (T) EXTENSION_INSTANCES.get(clazz);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(e.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Class&lt;?&gt;&gt; getExtensionClasses() &#123;</span><br><span class="line">        <span class="comment">// get the loaded extension class from the cache</span></span><br><span class="line">        Map&lt;String, Class&lt;?&gt;&gt; classes = cachedClasses.get();</span><br><span class="line">        <span class="comment">// double check</span></span><br><span class="line">        <span class="keyword">if</span> (classes == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (cachedClasses) &#123;</span><br><span class="line">                classes = cachedClasses.get();</span><br><span class="line">                <span class="keyword">if</span> (classes == <span class="literal">null</span>) &#123;</span><br><span class="line">                    classes = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">                    <span class="comment">// load all extensions from our extensions directory</span></span><br><span class="line">                    loadDirectory(classes);</span><br><span class="line">                    cachedClasses.set(classes);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> classes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">loadDirectory</span><span class="params">(Map&lt;String, Class&lt;?&gt;&gt; extensionClasses)</span> &#123;</span><br><span class="line">        <span class="comment">// 拼接SPI基础目录+接口名称获取SPI文件的路径</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> ExtensionLoader.SERVICE_DIRECTORY + type.getName();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Enumeration&lt;URL&gt; urls;</span><br><span class="line">            <span class="type">ClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> ExtensionLoader.class.getClassLoader();</span><br><span class="line">            urls = classLoader.getResources(fileName);</span><br><span class="line">            <span class="keyword">if</span> (urls != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">while</span> (urls.hasMoreElements()) &#123;</span><br><span class="line">                    <span class="type">URL</span> <span class="variable">resourceUrl</span> <span class="operator">=</span> urls.nextElement();</span><br><span class="line">                    loadResource(extensionClasses, classLoader, resourceUrl);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">loadResource</span><span class="params">(Map&lt;String, Class&lt;?&gt;&gt; extensionClasses, ClassLoader classLoader, URL resourceUrl)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(resourceUrl.openStream(), UTF_8))) &#123;</span><br><span class="line">            String line;</span><br><span class="line">            <span class="comment">// read every line</span></span><br><span class="line">            <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// get index of comment</span></span><br><span class="line">                <span class="keyword">final</span> <span class="type">int</span> <span class="variable">ci</span> <span class="operator">=</span> line.indexOf(<span class="string">&#x27;#&#x27;</span>);</span><br><span class="line">                <span class="keyword">if</span> (ci &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// string after # is comment so we ignore it</span></span><br><span class="line">                    line = line.substring(<span class="number">0</span>, ci);</span><br><span class="line">                &#125;</span><br><span class="line">                line = line.trim();</span><br><span class="line">                <span class="keyword">if</span> (line.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">ei</span> <span class="operator">=</span> line.indexOf(<span class="string">&#x27;=&#x27;</span>);</span><br><span class="line">                        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> line.substring(<span class="number">0</span>, ei).trim();</span><br><span class="line">                        <span class="type">String</span> <span class="variable">clazzName</span> <span class="operator">=</span> line.substring(ei + <span class="number">1</span>).trim();</span><br><span class="line">                        <span class="comment">// our SPI use key-value pair so both of them must not be empty</span></span><br><span class="line">                        <span class="keyword">if</span> (name.length() &gt; <span class="number">0</span> &amp;&amp; clazzName.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            Class&lt;?&gt; clazz = classLoader.loadClass(clazzName);</span><br><span class="line">                            extensionClasses.put(name, clazz);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">                        log.error(e.getMessage());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="/tags/">Tag</a></li>
        
          <li><a target="_blank" rel="noopener" href="http://github.com/hulingF">Projects</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%87%AA%E7%A0%94RPC%E6%A1%86%E6%9E%B6%E4%B9%8BSPI%E6%8F%92%E4%BB%B6%E5%8C%96%E6%9C%BA%E5%88%B6"><span class="toc-number">1.</span> <span class="toc-text">自研RPC框架之SPI插件化机制</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%90%AF%E5%8A%A8%E7%B1%BB%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">1.1.</span> <span class="toc-text">1.启动类初始化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E9%85%8D%E7%BD%AE%E8%A7%A3%E6%9E%90%E8%BF%87%E7%A8%8B"><span class="toc-number">1.2.</span> <span class="toc-text">2.配置解析过程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-XML%E9%85%8D%E7%BD%AE%E5%8A%A0%E8%BD%BD"><span class="toc-number">1.3.</span> <span class="toc-text">3.XML配置加载</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-SPI%E9%85%8D%E7%BD%AE%E5%8A%A0%E8%BD%BD"><span class="toc-number">1.4.</span> <span class="toc-text">4.SPI配置加载</span></a></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://hulingf.github.io/2024/02/09/%E8%87%AA%E7%A0%94RPC%E6%A1%86%E6%9E%B6%E4%B9%8BSPI%E6%8F%92%E4%BB%B6%E5%8C%96%E6%9C%BA%E5%88%B6/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://hulingf.github.io/2024/02/09/%E8%87%AA%E7%A0%94RPC%E6%A1%86%E6%9E%B6%E4%B9%8BSPI%E6%8F%92%E4%BB%B6%E5%8C%96%E6%9C%BA%E5%88%B6/&text=自研RPC框架之SPI插件化机制"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://hulingf.github.io/2024/02/09/%E8%87%AA%E7%A0%94RPC%E6%A1%86%E6%9E%B6%E4%B9%8BSPI%E6%8F%92%E4%BB%B6%E5%8C%96%E6%9C%BA%E5%88%B6/&title=自研RPC框架之SPI插件化机制"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://hulingf.github.io/2024/02/09/%E8%87%AA%E7%A0%94RPC%E6%A1%86%E6%9E%B6%E4%B9%8BSPI%E6%8F%92%E4%BB%B6%E5%8C%96%E6%9C%BA%E5%88%B6/&is_video=false&description=自研RPC框架之SPI插件化机制"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=自研RPC框架之SPI插件化机制&body=Check out this article: https://hulingf.github.io/2024/02/09/%E8%87%AA%E7%A0%94RPC%E6%A1%86%E6%9E%B6%E4%B9%8BSPI%E6%8F%92%E4%BB%B6%E5%8C%96%E6%9C%BA%E5%88%B6/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://hulingf.github.io/2024/02/09/%E8%87%AA%E7%A0%94RPC%E6%A1%86%E6%9E%B6%E4%B9%8BSPI%E6%8F%92%E4%BB%B6%E5%8C%96%E6%9C%BA%E5%88%B6/&title=自研RPC框架之SPI插件化机制"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://hulingf.github.io/2024/02/09/%E8%87%AA%E7%A0%94RPC%E6%A1%86%E6%9E%B6%E4%B9%8BSPI%E6%8F%92%E4%BB%B6%E5%8C%96%E6%9C%BA%E5%88%B6/&title=自研RPC框架之SPI插件化机制"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://hulingf.github.io/2024/02/09/%E8%87%AA%E7%A0%94RPC%E6%A1%86%E6%9E%B6%E4%B9%8BSPI%E6%8F%92%E4%BB%B6%E5%8C%96%E6%9C%BA%E5%88%B6/&title=自研RPC框架之SPI插件化机制"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://hulingf.github.io/2024/02/09/%E8%87%AA%E7%A0%94RPC%E6%A1%86%E6%9E%B6%E4%B9%8BSPI%E6%8F%92%E4%BB%B6%E5%8C%96%E6%9C%BA%E5%88%B6/&title=自研RPC框架之SPI插件化机制"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://hulingf.github.io/2024/02/09/%E8%87%AA%E7%A0%94RPC%E6%A1%86%E6%9E%B6%E4%B9%8BSPI%E6%8F%92%E4%BB%B6%E5%8C%96%E6%9C%BA%E5%88%B6/&name=自研RPC框架之SPI插件化机制&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://hulingf.github.io/2024/02/09/%E8%87%AA%E7%A0%94RPC%E6%A1%86%E6%9E%B6%E4%B9%8BSPI%E6%8F%92%E4%BB%B6%E5%8C%96%E6%9C%BA%E5%88%B6/&t=自研RPC框架之SPI插件化机制"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2024
    hulingF
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/hulingF">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'hulingF';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>

<!-- utterances Comments -->

</body>
</html>
