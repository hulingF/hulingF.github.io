<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="KRF框架原理深入剖析1.KRF故障注入实战演练需要的依赖: 1sudo apt install gcc make libelf-dev ruby linux-headers-$(uname -r)  构建步骤: 1234git clone https:&#x2F;&#x2F;github.com&#x2F;trailofbits&#x2F;krf &amp;&amp; cd krfmake -j$(nproc)sudo make in">
<meta property="og:type" content="article">
<meta property="og:title" content="KRF框架原理深入剖析">
<meta property="og:url" content="https://hulingf.github.io/2024/02/12/KRF%E6%A1%86%E6%9E%B6%E5%8E%9F%E7%90%86%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90/index.html">
<meta property="og:site_name" content="大军的秘密花园">
<meta property="og:description" content="KRF框架原理深入剖析1.KRF故障注入实战演练需要的依赖: 1sudo apt install gcc make libelf-dev ruby linux-headers-$(uname -r)  构建步骤: 1234git clone https:&#x2F;&#x2F;github.com&#x2F;trailofbits&#x2F;krf &amp;&amp; cd krfmake -j$(nproc)sudo make in">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://hulingf.github.io/imgs/KRF%E6%A1%86%E6%9E%B6%E5%8E%9F%E7%90%86%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90/image-20240212150148360.png">
<meta property="og:image" content="https://hulingf.github.io/imgs/KRF%E6%A1%86%E6%9E%B6%E5%8E%9F%E7%90%86%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90/image-20240212150157274.png">
<meta property="og:image" content="https://hulingf.github.io/imgs/KRF%E6%A1%86%E6%9E%B6%E5%8E%9F%E7%90%86%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90/image-20240212150549412.png">
<meta property="og:image" content="https://hulingf.github.io/imgs/KRF%E6%A1%86%E6%9E%B6%E5%8E%9F%E7%90%86%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90/image-20240212150836239.png">
<meta property="og:image" content="https://hulingf.github.io/imgs/KRF%E6%A1%86%E6%9E%B6%E5%8E%9F%E7%90%86%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90/image-20240212151337254.png">
<meta property="og:image" content="https://hulingf.github.io/imgs/KRF%E6%A1%86%E6%9E%B6%E5%8E%9F%E7%90%86%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90/image-20240212151934265.png">
<meta property="og:image" content="https://hulingf.github.io/imgs/KRF%E6%A1%86%E6%9E%B6%E5%8E%9F%E7%90%86%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90/image-20240212152054112.png">
<meta property="og:image" content="https://hulingf.github.io/imgs/KRF%E6%A1%86%E6%9E%B6%E5%8E%9F%E7%90%86%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90/image-20240212152130110.png">
<meta property="og:image" content="https://hulingf.github.io/imgs/KRF%E6%A1%86%E6%9E%B6%E5%8E%9F%E7%90%86%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90/image-20240212161337069.png">
<meta property="og:image" content="https://hulingf.github.io/imgs/KRF%E6%A1%86%E6%9E%B6%E5%8E%9F%E7%90%86%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90/image-20240212161424886.png">
<meta property="article:published_time" content="2024-02-12T06:58:30.294Z">
<meta property="article:modified_time" content="2024-02-12T08:58:02.473Z">
<meta property="article:author" content="hulingF">
<meta property="article:tag" content="Linux">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://hulingf.github.io/imgs/KRF%E6%A1%86%E6%9E%B6%E5%8E%9F%E7%90%86%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90/image-20240212150148360.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>KRF框架原理深入剖析</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/hulingF">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" aria-label="Next post" href="/2024/02/12/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E6%95%85%E9%9A%9C%E6%B3%A8%E5%85%A5%E6%A1%86%E6%9E%B6%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://hulingf.github.io/2024/02/12/KRF%E6%A1%86%E6%9E%B6%E5%8E%9F%E7%90%86%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://hulingf.github.io/2024/02/12/KRF%E6%A1%86%E6%9E%B6%E5%8E%9F%E7%90%86%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90/&text=KRF框架原理深入剖析"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://hulingf.github.io/2024/02/12/KRF%E6%A1%86%E6%9E%B6%E5%8E%9F%E7%90%86%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90/&title=KRF框架原理深入剖析"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://hulingf.github.io/2024/02/12/KRF%E6%A1%86%E6%9E%B6%E5%8E%9F%E7%90%86%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90/&is_video=false&description=KRF框架原理深入剖析"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=KRF框架原理深入剖析&body=Check out this article: https://hulingf.github.io/2024/02/12/KRF%E6%A1%86%E6%9E%B6%E5%8E%9F%E7%90%86%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://hulingf.github.io/2024/02/12/KRF%E6%A1%86%E6%9E%B6%E5%8E%9F%E7%90%86%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90/&title=KRF框架原理深入剖析"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://hulingf.github.io/2024/02/12/KRF%E6%A1%86%E6%9E%B6%E5%8E%9F%E7%90%86%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90/&title=KRF框架原理深入剖析"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://hulingf.github.io/2024/02/12/KRF%E6%A1%86%E6%9E%B6%E5%8E%9F%E7%90%86%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90/&title=KRF框架原理深入剖析"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://hulingf.github.io/2024/02/12/KRF%E6%A1%86%E6%9E%B6%E5%8E%9F%E7%90%86%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90/&title=KRF框架原理深入剖析"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://hulingf.github.io/2024/02/12/KRF%E6%A1%86%E6%9E%B6%E5%8E%9F%E7%90%86%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90/&name=KRF框架原理深入剖析&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://hulingf.github.io/2024/02/12/KRF%E6%A1%86%E6%9E%B6%E5%8E%9F%E7%90%86%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90/&t=KRF框架原理深入剖析"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#KRF%E6%A1%86%E6%9E%B6%E5%8E%9F%E7%90%86%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90"><span class="toc-number">1.</span> <span class="toc-text">KRF框架原理深入剖析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-KRF%E6%95%85%E9%9A%9C%E6%B3%A8%E5%85%A5%E5%AE%9E%E6%88%98%E6%BC%94%E7%BB%83"><span class="toc-number">1.1.</span> <span class="toc-text">1.KRF故障注入实战演练</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-KRF%E6%80%BB%E4%BD%93%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.2.</span> <span class="toc-text">2.KRF总体架构设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-KRF%E6%A1%86%E6%9E%B6%E6%9E%84%E5%BB%BA%E8%BF%87%E7%A8%8B"><span class="toc-number">1.3.</span> <span class="toc-text">3.KRF框架构建过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1%E6%A0%B9%E7%9B%AE%E5%BD%95Makefile"><span class="toc-number">1.3.1.</span> <span class="toc-text">3.1根目录Makefile</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2krfx%E6%A0%B8%E5%BF%83%E6%A8%A1%E5%9D%97%E6%9E%84%E5%BB%BA"><span class="toc-number">1.3.2.</span> <span class="toc-text">3.2krfx核心模块构建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3krfctl%E5%AD%90%E6%A8%A1%E5%9D%97%E6%9E%84%E5%BB%BA"><span class="toc-number">1.3.3.</span> <span class="toc-text">3.3krfctl子模块构建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4%E5%85%B6%E4%BB%96%E5%AD%90%E6%A8%A1%E5%9D%97%E6%9E%84%E5%BB%BA"><span class="toc-number">1.3.4.</span> <span class="toc-text">3.4其他子模块构建</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-KRF%E6%A1%86%E6%9E%B6%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90"><span class="toc-number">1.4.</span> <span class="toc-text">4.KRF框架源码剖析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1krfx%E5%86%85%E6%A0%B8%E6%A8%A1%E5%9D%97%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90"><span class="toc-number">1.4.1.</span> <span class="toc-text">4.1krfx内核模块源码剖析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2krfctl%E7%A8%8B%E5%BA%8F%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90"><span class="toc-number">1.4.2.</span> <span class="toc-text">4.2krfctl程序源码剖析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3krfexec%E7%A8%8B%E5%BA%8F%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90"><span class="toc-number">1.4.3.</span> <span class="toc-text">4.3krfexec程序源码剖析</span></a></li></ol></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        KRF框架原理深入剖析
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">hulingF</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-02-12T06:58:30.294Z" class="dt-published" itemprop="datePublished">2024-02-12</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/Linux/" rel="tag">Linux</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h1 id="KRF框架原理深入剖析"><a href="#KRF框架原理深入剖析" class="headerlink" title="KRF框架原理深入剖析"></a>KRF框架原理深入剖析</h1><h2 id="1-KRF故障注入实战演练"><a href="#1-KRF故障注入实战演练" class="headerlink" title="1.KRF故障注入实战演练"></a>1.KRF故障注入实战演练</h2><p>需要的依赖:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install gcc make libelf-dev ruby linux-headers-$(uname -r)</span><br></pre></td></tr></table></figure>

<p>构建步骤:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/trailofbits/krf &amp;&amp; cd krf</span><br><span class="line">make -j$(nproc)</span><br><span class="line">sudo make install # Installs module to /lib/modules and utils to /usr/local/bin</span><br><span class="line">sudo make insmod # Loads module</span><br></pre></td></tr></table></figure>

<p>实战演练:</p>
<p><img src="/../../../../../../imgs/KRF%E6%A1%86%E6%9E%B6%E5%8E%9F%E7%90%86%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90/image-20240212150148360.png" alt="image-20240212150148360"></p>
<h2 id="2-KRF总体架构设计"><a href="#2-KRF总体架构设计" class="headerlink" title="2.KRF总体架构设计"></a>2.KRF总体架构设计</h2><p><img src="/../../../../../../imgs/KRF%E6%A1%86%E6%9E%B6%E5%8E%9F%E7%90%86%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90/image-20240212150157274.png" alt="image-20240212150157274"></p>
<h2 id="3-KRF框架构建过程"><a href="#3-KRF框架构建过程" class="headerlink" title="3.KRF框架构建过程"></a>3.KRF框架构建过程</h2><h3 id="3-1根目录Makefile"><a href="#3-1根目录Makefile" class="headerlink" title="3.1根目录Makefile"></a>3.1根目录Makefile</h3><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> CFLAGS := -std=gnu99 -Wall -Werror -pedantic</span><br><span class="line"><span class="keyword">export</span> PLATFORM := <span class="variable">$(<span class="built_in">shell</span> uname -s | tr &#x27;[:upper:]&#x27; &#x27;[:lower:]&#x27;)</span></span><br><span class="line"></span><br><span class="line">CLANG_FORMAT := clang-format</span><br><span class="line">ALL_SRCS := <span class="variable">$(<span class="built_in">shell</span> find . -type f \( -name &#x27;*.c&#x27; -o -name &#x27;*.h&#x27; \)</span>)</span><br><span class="line">PREFIX = /usr/local</span><br><span class="line"></span><br><span class="line"><span class="section">all: module krfexec krfctl krfmesg example</span></span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: module</span></span><br><span class="line"><span class="section">module:</span></span><br><span class="line">	<span class="variable">$(MAKE)</span> -C src/module/<span class="variable">$(PLATFORM)</span> module</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: krfexec</span></span><br><span class="line"><span class="section">krfexec:</span></span><br><span class="line">	<span class="variable">$(MAKE)</span> -C src/krfexec</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: krfctl</span></span><br><span class="line"><span class="section">krfctl:</span></span><br><span class="line">	<span class="variable">$(MAKE)</span> -C src/krfctl</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: krfmesg</span></span><br><span class="line"><span class="section">krfmesg:</span></span><br><span class="line">	<span class="variable">$(MAKE)</span> -C src/krfmesg</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: insmod</span></span><br><span class="line"><span class="section">insmod:</span></span><br><span class="line">	<span class="variable">$(MAKE)</span> -C src/module/<span class="variable">$(PLATFORM)</span> insmod</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: rmmod</span></span><br><span class="line"><span class="section">rmmod:</span></span><br><span class="line">	<span class="variable">$(MAKE)</span> -C src/module/<span class="variable">$(PLATFORM)</span> rmmod</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: example</span></span><br><span class="line"><span class="section">example:</span></span><br><span class="line">	<span class="variable">$(MAKE)</span> -C example</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: clean</span></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	<span class="variable">$(MAKE)</span> -C src/module/<span class="variable">$(PLATFORM)</span> clean</span><br><span class="line">	<span class="variable">$(MAKE)</span> -C src/krfexec clean</span><br><span class="line">	<span class="variable">$(MAKE)</span> -C src/krfctl clean</span><br><span class="line">	<span class="variable">$(MAKE)</span> -C example clean</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: fmt</span></span><br><span class="line"><span class="section">fmt:</span></span><br><span class="line">	<span class="variable">$(CLANG_FORMAT)</span> -i -style=file <span class="variable">$(ALL_SRCS)</span></span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: install-module</span></span><br><span class="line"><span class="section">install-module: module</span></span><br><span class="line">	<span class="variable">$(MAKE)</span> -C src/module/<span class="variable">$(PLATFORM)</span> install</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: install-utils</span></span><br><span class="line"><span class="section">install-utils: krfexec krfctl krfmesg</span></span><br><span class="line">	install -d <span class="variable">$(DESTDIR)</span><span class="variable">$(PREFIX)</span>/bin</span><br><span class="line">	install src/krfexec/krfexec <span class="variable">$(DESTDIR)</span><span class="variable">$(PREFIX)</span>/bin</span><br><span class="line">	install src/krfctl/krfctl <span class="variable">$(DESTDIR)</span><span class="variable">$(PREFIX)</span>/bin</span><br><span class="line">	install src/krfmesg/krfmesg <span class="variable">$(DESTDIR)</span><span class="variable">$(PREFIX)</span>/bin</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: install</span></span><br><span class="line"><span class="section">install: install-module install-utils</span></span><br></pre></td></tr></table></figure>

<h3 id="3-2krfx核心模块构建"><a href="#3-2krfx核心模块构建" class="headerlink" title="3.2krfx核心模块构建"></a>3.2krfx核心模块构建</h3><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># krfx核心模块名称</span></span><br><span class="line">MOD := krfx</span><br><span class="line"></span><br><span class="line"><span class="comment"># Ignore this insanity: we need to do some pathname rewriting</span></span><br><span class="line"><span class="comment"># thanks to the subprocess make that actually does the building.</span></span><br><span class="line">KRF_SYSCALL_SRCS_FAKE := <span class="variable">$(<span class="built_in">notdir</span> $(<span class="built_in">wildcard</span> $M/syscalls/*.c)</span>)</span><br><span class="line">KRF_SYSCALL_OBJS_FAKE := $(KRF_SYSCALL_SRCS_FAKE:.c=.o)</span><br><span class="line">KRF_SYSCALL_OBJS = <span class="variable">$(<span class="built_in">foreach</span> obj,<span class="variable">$(KRF_SYSCALL_OBJS_FAKE)</span>,syscalls/<span class="variable">$(obj)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 系统调用的YML文件列表</span></span><br><span class="line">KRF_SYSCALL_YMLS = <span class="variable">$(<span class="built_in">wildcard</span> ../codegen/linux/*.yml)</span></span><br><span class="line">ccflags-y := -DKRF_CODEGEN=1 -DLINUX -std=gnu99 -Wno-declaration-after-statement</span><br><span class="line">obj-m += <span class="variable">$(MOD)</span>.o</span><br><span class="line"><span class="variable">$(MOD)</span>-objs := krf.o syscalls.o netlink.o ../krf.o ../config.o <span class="variable">$(KRF_SYSCALL_OBJS)</span></span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: all</span></span><br><span class="line"><span class="section">all: module</span></span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: module</span></span><br><span class="line"><span class="section">module: ../codegen/linux/.linux.mk</span></span><br><span class="line">	<span class="variable">$(MAKE)</span> -C /lib/modules/<span class="variable">$(<span class="built_in">shell</span> uname -r)</span>/build M=<span class="variable">$(<span class="built_in">shell</span> pwd)</span> modules</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: codegen</span></span><br><span class="line"><span class="section">codegen: ../codegen/linux/.linux.mk</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据系统调用如read.yml文件生成对应的krf_sys_internal_read函数</span></span><br><span class="line"><span class="section">../codegen/linux/.linux.mk: ../codegen/linux/codegen <span class="variable">$(KRF_SYSCALL_YMLS)</span></span></span><br><span class="line">	ruby ../codegen/linux/codegen <span class="variable">$(FAULTS)</span></span><br><span class="line">	@touch ../codegen/linux/.linux.mk</span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	<span class="variable">$(MAKE)</span> -C /lib/modules/<span class="variable">$(<span class="built_in">shell</span> uname -r)</span>/build M=<span class="variable">$(<span class="built_in">shell</span> pwd)</span> clean</span><br><span class="line">	rm -f ../*.o *.ur-safe ../*.ur-safe <span class="comment"># some garbage not cleaned by the kernel&#x27;s clean target</span></span><br><span class="line">	rm -f *.gen.x *.gen.h */*.gen.h */*.gen.c ../codegen/linux/.linux.mk <span class="comment"># codegen files</span></span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: install</span></span><br><span class="line"><span class="section">install: <span class="variable">$(MOD)</span>.ko</span></span><br><span class="line">	sudo <span class="variable">$(MAKE)</span> -C /lib/modules/<span class="variable">$(<span class="built_in">shell</span> uname -r)</span>/build M=<span class="variable">$(<span class="built_in">shell</span> pwd)</span> modules_install</span><br><span class="line">	sudo depmod -a</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: insmod</span></span><br><span class="line"><span class="section">insmod: <span class="variable">$(MOD)</span>.ko</span></span><br><span class="line">	sudo insmod <span class="variable">$(MOD)</span>.ko</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: rmmod</span></span><br><span class="line"><span class="section">rmmod:</span></span><br><span class="line">	sudo rmmod <span class="variable">$(MOD)</span></span><br></pre></td></tr></table></figure>

<p><img src="/../../../../../../imgs/KRF%E6%A1%86%E6%9E%B6%E5%8E%9F%E7%90%86%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90/image-20240212150549412.png" alt="image-20240212150549412"></p>
<p><img src="/../../../../../../imgs/KRF%E6%A1%86%E6%9E%B6%E5%8E%9F%E7%90%86%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90/image-20240212150836239.png" alt="image-20240212150836239"></p>
<p><img src="/../../../../../../imgs/KRF%E6%A1%86%E6%9E%B6%E5%8E%9F%E7%90%86%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90/image-20240212151337254.png" alt="image-20240212151337254"></p>
<h3 id="3-3krfctl子模块构建"><a href="#3-3krfctl子模块构建" class="headerlink" title="3.3krfctl子模块构建"></a>3.3krfctl子模块构建</h3><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">PROG := krfctl</span><br><span class="line">SRCS := <span class="variable">$(PROG)</span>.c table.gen.c profiles.gen.c <span class="variable">$(<span class="built_in">wildcard</span> ./<span class="variable">$(PLATFORM)</span>/*.c)</span></span><br><span class="line">OBJS := $(SRCS:.c=.o)</span><br><span class="line">YMLS = <span class="variable">$(<span class="built_in">wildcard</span> ../module/codegen/<span class="variable">$(PLATFORM)</span>/*.yml)</span></span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: all</span></span><br><span class="line"><span class="section">all: <span class="variable">$(PROG)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成系统调用名称-&gt;系统调用号的映射</span></span><br><span class="line"><span class="section">table.gen.c: gentable</span></span><br><span class="line">	ruby gentable</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成系统调用类型-&gt;系统调用列表的映射</span></span><br><span class="line"><span class="section">profiles.gen.c: genprofiles <span class="variable">$(YMLS)</span></span></span><br><span class="line">	ruby genprofiles</span><br><span class="line"></span><br><span class="line"><span class="variable">$(OBJS)</span>: <span class="variable">$(SRCS)</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$(PROG)</span>: <span class="variable">$(OBJS)</span></span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: clean</span></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	rm -f <span class="variable">$(PROG)</span> <span class="variable">$(OBJS)</span></span><br><span class="line">	rm -f *.gen.c <span class="comment"># gentable/genprofiles files</span></span><br></pre></td></tr></table></figure>

<p><img src="/../../../../../../imgs/KRF%E6%A1%86%E6%9E%B6%E5%8E%9F%E7%90%86%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90/image-20240212151934265.png" alt="image-20240212151934265"></p>
<p><img src="/../../../../../../imgs/KRF%E6%A1%86%E6%9E%B6%E5%8E%9F%E7%90%86%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90/image-20240212152054112.png" alt="image-20240212152054112"></p>
<h3 id="3-4其他子模块构建"><a href="#3-4其他子模块构建" class="headerlink" title="3.4其他子模块构建"></a>3.4其他子模块构建</h3><p><img src="/../../../../../../imgs/KRF%E6%A1%86%E6%9E%B6%E5%8E%9F%E7%90%86%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90/image-20240212152130110.png" alt="image-20240212152130110"></p>
<h2 id="4-KRF框架源码剖析"><a href="#4-KRF框架源码剖析" class="headerlink" title="4.KRF框架源码剖析"></a>4.KRF框架源码剖析</h2><h3 id="4-1krfx内核模块源码剖析"><a href="#4-1krfx内核模块源码剖析" class="headerlink" title="4.1krfx内核模块源码剖析"></a>4.1krfx内核模块源码剖析</h3><p>首先，看一看头文件定义的信息:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Strings used to generate procfs filenames and sysctl strings */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KRF_PROC_DIR <span class="string">&quot;krf&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KRF_RNG_STATE_FILENAME <span class="string">&quot;rng_state&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KRF_PROBABILITY_FILENAME <span class="string">&quot;probability&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KRF_CONTROL_FILENAME <span class="string">&quot;control&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KRF_LOG_FAULTS_FILENAME <span class="string">&quot;log_faults&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KRF_TARGETING_FILENAME <span class="string">&quot;targeting&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Targeting modes */</span></span><br><span class="line"><span class="comment">/* 筛选模式条件的枚举类 */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">  KRF_T_MODE_PERSONALITY = <span class="number">0</span>,</span><br><span class="line">  KRF_T_MODE_PID,</span><br><span class="line">  KRF_T_MODE_UID,</span><br><span class="line">  KRF_T_MODE_GID,</span><br><span class="line">  KRF_T_MODE_INODE,</span><br><span class="line">  <span class="comment">// Insert new modes here</span></span><br><span class="line">  <span class="comment">// KRF_T_NUM_MODES是可选筛选模式的上限，也表示筛选模式的数目</span></span><br><span class="line">  KRF_T_NUM_MODES</span><br><span class="line">&#125; <span class="type">krf_target_mode_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Netlink Defines */</span></span><br><span class="line"><span class="comment">/* Protocol family, consistent in both kernel prog and user prog. */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NETLINK_KRF 28</span></span><br><span class="line"><span class="comment">/* Multicast group, consistent in both kernel prog and user prog. */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NETLINK_MYGROUP 28</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* All of our options are unsigned ints,</span></span><br><span class="line"><span class="comment"> * so 32 bytes should be more than enough for their string reps</span></span><br><span class="line"><span class="comment"> * plus a trailing newline.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KRF_PROCFS_MAX_SIZE 255</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 可选筛选模式的最大数目，考虑mode_mask只有32位且最后1位是边界位[KRF_T_NUM_MODES]，因此[KRF_T_MODE_MAX]=32-1=31</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KRF_T_MODE_MAX 31</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KRF_T_MODE_MAX_MASK (1 &lt;&lt; KRF_T_MODE_MAX)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 极限情况：[0~30]位是有效模式位，31位是KRF_T_NUM_MODES位</span></span><br><span class="line"><span class="keyword">_Static_assert</span>(((KRF_T_NUM_MODES) &lt;= (KRF_T_MODE_MAX)), <span class="string">&quot;Too many modes&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 筛选项结构体，包含有效筛选模式和对应的筛选值</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> mode_mask;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> target_data[KRF_T_MODE_MAX];</span><br><span class="line">&#125; <span class="type">krf_target_options_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> krf_rng_state = <span class="number">0</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> krf_probability = <span class="number">1000</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> krf_targeted_uid = <span class="number">1002</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> krf_log_faults = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 默认情况下无有效筛选模式，不进行故障注入，执行原系统调用函数</span></span><br><span class="line"><span class="type">krf_target_options_t</span> krf_target_options = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 故障系统调用表</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> *krf_faultable_table[KRF_NR_SYSCALLS] = &#123;&#125;;</span><br><span class="line"><span class="comment">// 系统调用备份表</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> *krf_sys_call_table[KRF_NR_SYSCALLS] = &#123;&#125;;</span><br><span class="line"><span class="comment">// 内核系统调用表</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> **linux_sys_call_table = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 可选的系统调用数目</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KRF_NR_SYSCALLS (NR_syscalls)</span></span><br></pre></td></tr></table></figure>

<p><img src="/../../../../../../imgs/KRF%E6%A1%86%E6%9E%B6%E5%8E%9F%E7%90%86%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90/image-20240212161337069.png" alt="image-20240212161337069"></p>
<p><img src="/../../../../../../imgs/KRF%E6%A1%86%E6%9E%B6%E5%8E%9F%E7%90%86%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90/image-20240212161424886.png" alt="image-20240212161424886"></p>
<p>然后，查看剖析几个函数的代码:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 恢复内核的系统调用表</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">krf_flush_table</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  <span class="type">int</span> nr;</span><br><span class="line">  <span class="keyword">for</span> (nr = <span class="number">0</span>; nr &lt; KRF_NR_SYSCALLS; nr++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (krf_sys_call_table[nr]) &#123;</span><br><span class="line">      KRF_SAFE_WRITE(&#123; KRF_EXTRACT_SYSCALL(KRF_SYSCALL_TABLE[nr]) = krf_sys_call_table[nr]; &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 控制系统调用的故障注入</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">control_file_handler</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> sys_num)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (sys_num &gt;= KRF_NR_SYSCALLS) &#123;</span><br><span class="line">    KRF_LOG(<span class="string">&quot;krf: flushing all faulty syscalls\n&quot;</span>);</span><br><span class="line">    krf_flush_table();</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (krf_faultable_table[sys_num] != <span class="literal">NULL</span>) &#123;</span><br><span class="line">    KRF_SAFE_WRITE(</span><br><span class="line">        &#123; KRF_EXTRACT_SYSCALL(KRF_SYSCALL_TABLE[sys_num]) = krf_faultable_table[sys_num]; &#125;);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Valid syscall, but not supported by KRF</span></span><br><span class="line">    KRF_LOG(<span class="string">&quot;krf: user requested faulting of unsupported slot %u\n&quot;</span>, sys_num);</span><br><span class="line">    <span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 读取筛选模式</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">targeting_file_read_handler</span><span class="params">(<span class="type">char</span> *buf)</span> &#123;</span><br><span class="line">  <span class="type">size_t</span> offset = <span class="number">0</span>;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> current_mode;</span><br><span class="line">  <span class="comment">// 逐个遍历krf_target_options结构体中的有效筛选模式位</span></span><br><span class="line">  <span class="keyword">for</span> (current_mode = <span class="number">0</span>; current_mode &lt; KRF_T_NUM_MODES; current_mode++) &#123;</span><br><span class="line">    <span class="keyword">if</span> ((krf_target_options.mode_mask &amp; (<span class="number">1</span> &lt;&lt; current_mode)) &amp;&amp; (offset &lt; KRF_PROCFS_MAX_SIZE)) &#123;</span><br><span class="line">      offset += <span class="built_in">sprintf</span>(buf + offset, <span class="string">&quot;%u %u\n&quot;</span>, current_mode,</span><br><span class="line">                        krf_target_options.target_data[current_mode]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 写入筛选模式</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">targeting_file_write_handler</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> mode, <span class="type">unsigned</span> <span class="type">int</span> data)</span> &#123;</span><br><span class="line">  <span class="comment">// 如果mode和data都为0，则重置筛选模式</span></span><br><span class="line">  <span class="keyword">if</span> ((mode == <span class="number">0</span>) &amp;&amp; (data == <span class="number">0</span>)) &#123; <span class="comment">// If both arguments are zero, remove all targeting</span></span><br><span class="line">    krf_target_options.mode_mask = <span class="number">0</span>;</span><br><span class="line">    KRF_LOG(<span class="string">&quot;krf: flushing all targeting options\n&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mode &gt;= KRF_T_NUM_MODES) &#123;</span><br><span class="line">      <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置特定的有效筛选模式位如personality、uid、gid、inode</span></span><br><span class="line">    krf_target_options.mode_mask |= (<span class="number">1</span> &lt;&lt; mode);</span><br><span class="line">    <span class="comment">// 设置对应的筛选模式值</span></span><br><span class="line">    krf_target_options.target_data[mode] = data;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后，我们看一下krfx内核模块的代码:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// krfx内核模块</span></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;William Woodruff &lt;william@yossarian.net&gt;&quot;</span>);</span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;A Kernelspace Randomized Faulter&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Kernels 5.6 and newer: procfs uses `struct proc_ops` instead of `struct file_operations`.</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> LINUX_VERSION_CODE &gt;= KERNEL_VERSION(5, 6, 0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HAVE_PROC_OPS</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Kernels 5.7 and newer: kallsyms_lookup_name has been unexported for Google reasons (tm),</span></span><br><span class="line"><span class="comment">// so we need to use kprobes to grab its address.</span></span><br><span class="line"><span class="comment">// See: https://github.com/xcellerator/linux_kernel_hacking</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> LINUX_VERSION_CODE &gt;= KERNEL_VERSION(5, 7, 0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KALLSYMS_LOOKUP_NAME_UNEXPORTED</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kprobes.h&gt;</span></span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">kprobe</span> <span class="title">kp</span> =</span> &#123;.symbol_name = <span class="string">&quot;kallsyms_lookup_name&quot;</span>&#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">krf_init</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">krf_teardown</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">rng_state_file_read</span><span class="params">(<span class="keyword">struct</span> file *, <span class="type">char</span> __user *, <span class="type">size_t</span>, <span class="type">loff_t</span> *)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">rng_state_file_write</span><span class="params">(<span class="keyword">struct</span> file *, <span class="type">const</span> <span class="type">char</span> __user *, <span class="type">size_t</span>, <span class="type">loff_t</span> *)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">probability_file_read</span><span class="params">(<span class="keyword">struct</span> file *, <span class="type">char</span> __user *, <span class="type">size_t</span>, <span class="type">loff_t</span> *)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">probability_file_write</span><span class="params">(<span class="keyword">struct</span> file *, <span class="type">const</span> <span class="type">char</span> __user *, <span class="type">size_t</span>, <span class="type">loff_t</span> *)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">control_file_write</span><span class="params">(<span class="keyword">struct</span> file *, <span class="type">const</span> <span class="type">char</span> __user *, <span class="type">size_t</span>, <span class="type">loff_t</span> *)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">log_faults_file_read</span><span class="params">(<span class="keyword">struct</span> file *, <span class="type">char</span> __user *, <span class="type">size_t</span>, <span class="type">loff_t</span> *)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">log_faults_file_write</span><span class="params">(<span class="keyword">struct</span> file *, <span class="type">const</span> <span class="type">char</span> __user *, <span class="type">size_t</span>, <span class="type">loff_t</span> *)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">targeting_file_read</span><span class="params">(<span class="keyword">struct</span> file *, <span class="type">char</span> __user *, <span class="type">size_t</span>, <span class="type">loff_t</span> *)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">targeting_file_write</span><span class="params">(<span class="keyword">struct</span> file *, <span class="type">const</span> <span class="type">char</span> __user *, <span class="type">size_t</span>, <span class="type">loff_t</span> *)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">proc_dir_entry</span> *<span class="title">krf_dir</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> HAVE_PROC_OPS</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">proc_ops</span> <span class="title">rng_state_file_ops</span> =</span> &#123;</span><br><span class="line">    .proc_read = rng_state_file_read,</span><br><span class="line">    .proc_write = rng_state_file_write,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">proc_ops</span> <span class="title">probability_file_ops</span> =</span> &#123;</span><br><span class="line">    .proc_read = probability_file_read,</span><br><span class="line">    .proc_write = probability_file_write,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">proc_ops</span> <span class="title">control_file_ops</span> =</span> &#123;</span><br><span class="line">    .proc_write = control_file_write,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">proc_ops</span> <span class="title">log_faults_file_ops</span> =</span> &#123;</span><br><span class="line">    .proc_read = log_faults_file_read,</span><br><span class="line">    .proc_write = log_faults_file_write,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">proc_ops</span> <span class="title">targeting_file_ops</span> =</span> &#123;</span><br><span class="line">    .proc_read = targeting_file_read,</span><br><span class="line">    .proc_write = targeting_file_write,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">rng_state_file_ops</span> =</span> &#123;</span><br><span class="line">    .owner = THIS_MODULE,</span><br><span class="line">    .read = rng_state_file_read,</span><br><span class="line">    .write = rng_state_file_write,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">probability_file_ops</span> =</span> &#123;</span><br><span class="line">    .owner = THIS_MODULE,</span><br><span class="line">    .read = probability_file_read,</span><br><span class="line">    .write = probability_file_write,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注意：[/proc/krf/control]故障注入控制文件无法读取</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">control_file_ops</span> =</span> &#123;</span><br><span class="line">    .owner = THIS_MODULE,</span><br><span class="line">    .write = control_file_write,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">log_faults_file_ops</span> =</span> &#123;</span><br><span class="line">    .owner = THIS_MODULE,</span><br><span class="line">    .read = log_faults_file_read,</span><br><span class="line">    .write = log_faults_file_write,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">targeting_file_ops</span> =</span> &#123;</span><br><span class="line">    .owner = THIS_MODULE,</span><br><span class="line">    .read = targeting_file_read,</span><br><span class="line">    .write = targeting_file_write,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">init_module</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((ret = krf_init()) != <span class="number">0</span>) &#123;</span><br><span class="line">    printk(KERN_ERR <span class="string">&quot;krf_init failed with %d\n&quot;</span>, ret);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> KRF_CODEGEN</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;krf.gen.x&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  printk(KERN_INFO <span class="string">&quot;krf &quot;</span> KRF_VERSION <span class="string">&quot; loaded\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">cleanup_module</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  krf_teardown();</span><br><span class="line"></span><br><span class="line">  printk(KERN_INFO <span class="string">&quot;krf &quot;</span> KRF_VERSION <span class="string">&quot; unloaded\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">krf_init</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> KALLSYMS_LOOKUP_NAME_UNEXPORTED</span></span><br><span class="line">  <span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="title function_">long</span> <span class="params">(*<span class="type">kallsyms_lookup_name_t</span>)</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *name)</span>;</span><br><span class="line">  <span class="type">kallsyms_lookup_name_t</span> kallsyms_lookup_name;</span><br><span class="line">  <span class="keyword">if</span> (register_kprobe(&amp;kp) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    printk(KERN_ERR <span class="string">&quot;krf couldn&#x27;t register a kprobe to sniff kallsyms_lookup_name\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  kallsyms_lookup_name = (<span class="type">kallsyms_lookup_name_t</span>)kp.addr;</span><br><span class="line">  unregister_kprobe(&amp;kp);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  <span class="comment">// 创建内核netlink套接字</span></span><br><span class="line">  <span class="keyword">if</span> (setup_netlink_socket() &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 获取Linux内核系统调用表</span></span><br><span class="line">  linux_sys_call_table = (<span class="type">void</span> *)kallsyms_lookup_name(<span class="string">&quot;sys_call_table&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (linux_sys_call_table == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    printk(KERN_ERR <span class="string">&quot;krf couldn&#x27;t load the syscall table\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-2</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 备份内核的系统调用表</span></span><br><span class="line">  <span class="built_in">memcpy</span>(krf_sys_call_table, linux_sys_call_table, KRF_NR_SYSCALLS * <span class="keyword">sizeof</span>(<span class="type">unsigned</span> <span class="type">long</span> *));</span><br><span class="line">  <span class="comment">// 创建KRF的故障注入配置目录</span></span><br><span class="line">  krf_dir = proc_mkdir(KRF_PROC_DIR, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (krf_dir == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    printk(KERN_ERR <span class="string">&quot;krf couldn&#x27;t create /proc/&quot;</span> KRF_PROC_DIR);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-2</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 创建KRF的具体故障注入配置项如rng_state、故障发生概率、故障系统调用名称、日志开关、筛选模式</span></span><br><span class="line">  <span class="keyword">if</span> (proc_create(KRF_RNG_STATE_FILENAME, <span class="number">644</span>, krf_dir, &amp;rng_state_file_ops) == <span class="literal">NULL</span> ||</span><br><span class="line">      proc_create(KRF_PROBABILITY_FILENAME, <span class="number">644</span>, krf_dir, &amp;probability_file_ops) == <span class="literal">NULL</span> ||</span><br><span class="line">      proc_create(KRF_CONTROL_FILENAME, <span class="number">644</span>, krf_dir, &amp;control_file_ops) == <span class="literal">NULL</span> ||</span><br><span class="line">      proc_create(KRF_LOG_FAULTS_FILENAME, <span class="number">644</span>, krf_dir, &amp;log_faults_file_ops) == <span class="literal">NULL</span> ||</span><br><span class="line">      proc_create(KRF_TARGETING_FILENAME, <span class="number">644</span>, krf_dir, &amp;targeting_file_ops) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    printk(KERN_ERR <span class="string">&quot;krf couldn&#x27;t create /proc entries\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-3</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">krf_teardown</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  <span class="comment">// 模块卸载时首先恢复内核原系统调用表</span></span><br><span class="line">  krf_flush_table();</span><br><span class="line">  <span class="comment">// 其次移除KRF的故障注入配置目录</span></span><br><span class="line">  remove_proc_subtree(KRF_PROC_DIR, <span class="literal">NULL</span>);</span><br><span class="line">  <span class="comment">// 最后销毁内核的netlink套接字</span></span><br><span class="line">  destroy_netlink_socket();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注意：[/proc/krf/rng_state]随机数文件无内容，利用该文件的read方法作为桥梁，实际读取的是内核的krf_rng_state变量</span></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">rng_state_file_read</span><span class="params">(<span class="keyword">struct</span> file *f, <span class="type">char</span> __user *ubuf, <span class="type">size_t</span> size, <span class="type">loff_t</span> *off)</span> &#123;</span><br><span class="line">  <span class="type">char</span> buf[KRF_PROCFS_MAX_SIZE + <span class="number">1</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="type">size_t</span> buflen = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">sprintf</span>(buf, <span class="string">&quot;%u\n&quot;</span>, krf_rng_state);</span><br><span class="line">  buflen = strnlen(buf, KRF_PROCFS_MAX_SIZE);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (*off &gt; <span class="number">0</span> || size &lt; buflen) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (copy_to_user(ubuf, buf, buflen)) &#123;</span><br><span class="line">    <span class="keyword">return</span> -EFAULT;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  *off = buflen;</span><br><span class="line">  <span class="keyword">return</span> buflen;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注意：[/proc/krf/rng_state]随机数文件无内容，利用该文件的write方法作为桥梁，实际修改的是内核的krf_rng_state变量</span></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">rng_state_file_write</span><span class="params">(<span class="keyword">struct</span> file *f, <span class="type">const</span> <span class="type">char</span> __user *ubuf, <span class="type">size_t</span> size,</span></span><br><span class="line"><span class="params">                                    <span class="type">loff_t</span> *off)</span> &#123;</span><br><span class="line">  <span class="type">char</span> buf[KRF_PROCFS_MAX_SIZE + <span class="number">1</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="type">size_t</span> buflen = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (size &gt; KRF_PROCFS_MAX_SIZE) &#123;</span><br><span class="line">    size = KRF_PROCFS_MAX_SIZE;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (copy_from_user(buf, ubuf, size)) &#123;</span><br><span class="line">    <span class="keyword">return</span> -EFAULT;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (kstrtouint(buf, <span class="number">0</span>, &amp;krf_rng_state) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> -EINVAL;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  buflen = strnlen(buf, KRF_PROCFS_MAX_SIZE);</span><br><span class="line"></span><br><span class="line">  *off = buflen;</span><br><span class="line">  <span class="keyword">return</span> buflen;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注意：传入的ubuf的内容是系统调用号，krfctl中的table.gen.c保存了系统调用名称与系统调用号的映射关系表</span></span><br><span class="line"><span class="comment">// 注意：[/proc/krf/control]故障注入控制文件无内容，利用该文件的write方法作为桥梁调用control_file_handler，实际修改的是内核的系统调用表</span></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">control_file_write</span><span class="params">(<span class="keyword">struct</span> file *f, <span class="type">const</span> <span class="type">char</span> __user *ubuf, <span class="type">size_t</span> size,</span></span><br><span class="line"><span class="params">                                  <span class="type">loff_t</span> *off)</span> &#123;</span><br><span class="line">  <span class="type">char</span> buf[KRF_PROCFS_MAX_SIZE + <span class="number">1</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="type">size_t</span> buflen = <span class="number">0</span>;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> sys_num = KRF_NR_SYSCALLS;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (size &gt; KRF_PROCFS_MAX_SIZE) &#123;</span><br><span class="line">    size = KRF_PROCFS_MAX_SIZE;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (copy_from_user(buf, ubuf, size)) &#123;</span><br><span class="line">    <span class="keyword">return</span> -EFAULT;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (kstrtouint(buf, <span class="number">0</span>, &amp;sys_num) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> -EINVAL;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (control_file_handler(sys_num) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  buflen = strnlen(buf, KRF_PROCFS_MAX_SIZE);</span><br><span class="line"></span><br><span class="line">  *off = buflen;</span><br><span class="line">  <span class="keyword">return</span> buflen;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注意：[/proc/krf/log_faults]日志开关文件无内容，利用该文件的read方法作为桥梁，实际读取的是内核的krf_log_faults变量</span></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">log_faults_file_read</span><span class="params">(<span class="keyword">struct</span> file *f, <span class="type">char</span> __user *ubuf, <span class="type">size_t</span> size, <span class="type">loff_t</span> *off)</span> &#123;</span><br><span class="line">  <span class="type">char</span> buf[KRF_PROCFS_MAX_SIZE + <span class="number">1</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="type">size_t</span> buflen = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">sprintf</span>(buf, <span class="string">&quot;%u\n&quot;</span>, krf_log_faults);</span><br><span class="line">  buflen = strnlen(buf, KRF_PROCFS_MAX_SIZE);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (*off &gt; <span class="number">0</span> || size &lt; buflen) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (copy_to_user(ubuf, buf, buflen)) &#123;</span><br><span class="line">    <span class="keyword">return</span> -EFAULT;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  *off = buflen;</span><br><span class="line">  <span class="keyword">return</span> buflen;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注意：[/proc/krf/log_faults]日志开关文件无内容，利用该文件的write方法作为桥梁，实际修改的是内核的krf_log_faults变量</span></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">log_faults_file_write</span><span class="params">(<span class="keyword">struct</span> file *f, <span class="type">const</span> <span class="type">char</span> __user *ubuf, <span class="type">size_t</span> size,</span></span><br><span class="line"><span class="params">                                     <span class="type">loff_t</span> *off)</span> &#123;</span><br><span class="line">  <span class="type">char</span> buf[KRF_PROCFS_MAX_SIZE + <span class="number">1</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="type">size_t</span> buflen = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (size &gt; KRF_PROCFS_MAX_SIZE) &#123;</span><br><span class="line">    size = KRF_PROCFS_MAX_SIZE;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (copy_from_user(buf, ubuf, size)) &#123;</span><br><span class="line">    <span class="keyword">return</span> -EFAULT;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (kstrtouint(buf, <span class="number">0</span>, &amp;krf_log_faults) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> -EINVAL;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果通过krfctl工具配置，这一句代码没有什么作用，但是如果用户是通过直接修改/proc/krf/log_faults文件则有用(非零值归为一)</span></span><br><span class="line">  krf_log_faults = !!krf_log_faults;</span><br><span class="line"></span><br><span class="line">  buflen = strnlen(buf, KRF_PROCFS_MAX_SIZE);</span><br><span class="line"></span><br><span class="line">  *off = buflen;</span><br><span class="line">  <span class="keyword">return</span> buflen;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注意：[/proc/krf/targeting]筛选模式文件无内容，利用该文件的read方法作为桥梁调用targeting_file_read_handler，实际读取的是内核的krf_target_options结构体</span></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">targeting_file_read</span><span class="params">(<span class="keyword">struct</span> file *f, <span class="type">char</span> __user *ubuf, <span class="type">size_t</span> size, <span class="type">loff_t</span> *off)</span> &#123;</span><br><span class="line">  <span class="type">char</span> buf[KRF_PROCFS_MAX_SIZE + <span class="number">1</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="type">size_t</span> buflen = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  targeting_file_read_handler(buf);</span><br><span class="line"></span><br><span class="line">  buflen = strnlen(buf, KRF_PROCFS_MAX_SIZE);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (*off &gt; <span class="number">0</span> || size &lt; buflen) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (copy_to_user(ubuf, buf, buflen)) &#123;</span><br><span class="line">    <span class="keyword">return</span> -EFAULT;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  *off = buflen;</span><br><span class="line">  <span class="keyword">return</span> buflen;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// // 注意：[/proc/krf/targeting]筛选模式文件无内容，利用该文件的write方法作为桥梁调用targeting_file_write_handler，实际修改的是内核的krf_target_options结构体</span></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">targeting_file_write</span><span class="params">(<span class="keyword">struct</span> file *f, <span class="type">const</span> <span class="type">char</span> __user *ubuf, <span class="type">size_t</span> size,</span></span><br><span class="line"><span class="params">                                    <span class="type">loff_t</span> *off)</span> &#123;</span><br><span class="line">  <span class="type">char</span> buf[KRF_PROCFS_MAX_SIZE + <span class="number">1</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="type">size_t</span> buflen = <span class="number">0</span>;</span><br><span class="line">  <span class="type">krf_target_mode_t</span> mode;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> data;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (size &gt; KRF_PROCFS_MAX_SIZE) &#123;</span><br><span class="line">    size = KRF_PROCFS_MAX_SIZE;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (copy_from_user(buf, ubuf, size)) &#123;</span><br><span class="line">    <span class="keyword">return</span> -EFAULT;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">sscanf</span>(buf, <span class="string">&quot;%u %u&quot;</span>, &amp;mode, &amp;data) != <span class="number">2</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> -EINVAL;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (targeting_file_write_handler(mode, data) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> -EINVAL;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  buflen = strnlen(buf, KRF_PROCFS_MAX_SIZE);</span><br><span class="line"></span><br><span class="line">  *off = buflen;</span><br><span class="line">  <span class="keyword">return</span> buflen;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>判断故障注入是否触发的函数:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> __always_inline <span class="type">int</span> <span class="title function_">krf_targeted</span><span class="params">(<span class="type">krf_ctx_t</span> *context)</span> &#123;</span><br><span class="line">  <span class="type">int</span> targeted = <span class="number">1</span>;</span><br><span class="line">  <span class="type">size_t</span> i = <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// 对于选定有效的筛选模式，必须全部通过检测才返回正数（true），否则返回0（false）</span></span><br><span class="line">  <span class="comment">// 注意：无有效筛选模式时返回0（false），这也是默认情况</span></span><br><span class="line">  <span class="keyword">for</span> (; i &lt; KRF_T_NUM_MODES; i++) &#123;</span><br><span class="line">    <span class="comment">// 遇到不符合的模式项，直接退出后续模式的匹配</span></span><br><span class="line">    <span class="keyword">if</span> (targeted == <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 遇到有效筛选模式，其对应的二进制位为1</span></span><br><span class="line">    <span class="keyword">if</span> (krf_target_options.mode_mask &amp; (<span class="number">1</span> &lt;&lt; i)) &#123;</span><br><span class="line">      <span class="keyword">switch</span> (i) &#123;</span><br><span class="line">      <span class="keyword">case</span> KRF_T_MODE_PERSONALITY:</span><br><span class="line">        <span class="keyword">if</span> (krf_personality(krf_target_options.target_data[i], context))</span><br><span class="line">          targeted++;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          targeted = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> KRF_T_MODE_PID:</span><br><span class="line">        <span class="keyword">if</span> (krf_pid(krf_target_options.target_data[i], context))</span><br><span class="line">          targeted++;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          targeted = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> KRF_T_MODE_UID:</span><br><span class="line">        <span class="keyword">if</span> (krf_uid(krf_target_options.target_data[i], context))</span><br><span class="line">          targeted++;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          targeted = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> KRF_T_MODE_GID:</span><br><span class="line">        <span class="keyword">if</span> (krf_gid(krf_target_options.target_data[i], context))</span><br><span class="line">          targeted++;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          targeted = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> KRF_T_MODE_INODE:</span><br><span class="line">        <span class="keyword">if</span> (krf_inode(krf_target_options.target_data[i], context))</span><br><span class="line">          targeted++;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          targeted = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (targeted &amp; (~<span class="number">1</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-2krfctl程序源码剖析"><a href="#4-2krfctl程序源码剖析" class="headerlink" title="4.2krfctl程序源码剖析"></a>4.2krfctl程序源码剖析</h3><p>首先，还是先看一下头文件中的内容:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> KRF_PROC_DIR <span class="string">&quot;krf&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KRF_RNG_STATE_FILENAME <span class="string">&quot;rng_state&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KRF_PROBABILITY_FILENAME <span class="string">&quot;probability&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KRF_CONTROL_FILENAME <span class="string">&quot;control&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KRF_LOG_FAULTS_FILENAME <span class="string">&quot;log_faults&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KRF_TARGETING_FILENAME <span class="string">&quot;targeting&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* control will interpret any number larger than its syscall table</span></span><br><span class="line"><span class="comment"> * as a command to clear all current masks.</span></span><br><span class="line"><span class="comment"> * it&#x27;s a good bet that linux will never have 65535 syscalls.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CLEAR_MAGIC <span class="string">&quot;65535&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CONTROL_FILE <span class="string">&quot;/proc/&quot;</span> KRF_PROC_DIR <span class="string">&quot;/&quot;</span> KRF_CONTROL_FILENAME</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RNG_STATE_FILE <span class="string">&quot;/proc/&quot;</span> KRF_PROC_DIR <span class="string">&quot;/&quot;</span> KRF_RNG_STATE_FILENAME</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PROBABILITY_FILE <span class="string">&quot;/proc/&quot;</span> KRF_PROC_DIR <span class="string">&quot;/&quot;</span> KRF_PROBABILITY_FILENAME</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG_FAULTS_FILE <span class="string">&quot;/proc/&quot;</span> KRF_PROC_DIR <span class="string">&quot;/&quot;</span> KRF_LOG_FAULTS_FILENAME</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TARGETING_FILE <span class="string">&quot;/proc/&quot;</span> KRF_PROC_DIR <span class="string">&quot;/&quot;</span> KRF_TARGETING_FILENAME</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">syscall_lookup_t</span> &#123;</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *sys_name;</span><br><span class="line">  <span class="comment">/* no point in storing it as an int if we&#x27;re just going to convert it */</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *sys_num;</span><br><span class="line">&#125; <span class="type">syscall_lookup_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">1.table.gen.c:</span></span><br><span class="line"><span class="comment">#include &lt;stdlib.h&gt;</span></span><br><span class="line"><span class="comment">#include &quot;krfctl.h&quot;</span></span><br><span class="line"><span class="comment">syscall_lookup_t syscall_lookup_table[] = &#123;</span></span><br><span class="line"><span class="comment">&#123; &quot;read&quot;, &quot;0&quot; &#125;,</span></span><br><span class="line"><span class="comment">&#123; &quot;write&quot;, &quot;1&quot; &#125;,</span></span><br><span class="line"><span class="comment">&#123; &quot;open&quot;, &quot;2&quot; &#125;,</span></span><br><span class="line"><span class="comment">&#123; &quot;close&quot;, &quot;3&quot; &#125;,</span></span><br><span class="line"><span class="comment">&#123; &quot;stat&quot;, &quot;4&quot; &#125;,</span></span><br><span class="line"><span class="comment">&#123; &quot;fstat&quot;, &quot;5&quot; &#125;,</span></span><br><span class="line"><span class="comment">&#123; &quot;lstat&quot;, &quot;6&quot; &#125;,</span></span><br><span class="line"><span class="comment">&#123; &quot;poll&quot;, &quot;7&quot; &#125;,</span></span><br><span class="line"><span class="comment">&#123; &quot;lseek&quot;, &quot;8&quot; &#125;,</span></span><br><span class="line"><span class="comment">&#123; &quot;mmap&quot;, &quot;9&quot; &#125;,</span></span><br><span class="line"><span class="comment">...</span></span><br><span class="line"><span class="comment">&#123; NULL, 0 &#125;,</span></span><br><span class="line"><span class="comment">&#125;;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">fault_profile_t</span> &#123;</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *profile;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *description;</span><br><span class="line">  <span class="comment">/* GCC doesn&#x27;t like flexible array initialization within</span></span><br><span class="line"><span class="comment">   * structures, so just give ourselves enough room for</span></span><br><span class="line"><span class="comment">   * sensibly sized profiles.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *syscalls[<span class="number">256</span>];</span><br><span class="line">&#125; <span class="type">fault_profile_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">2.profile.gen.c:</span></span><br><span class="line"><span class="comment">#include &lt;stdlib.h&gt;</span></span><br><span class="line"><span class="comment">#include &quot;krfctl.h&quot;</span></span><br><span class="line"><span class="comment">fault_profile_t fault_profile_table[] = &#123;</span></span><br><span class="line"><span class="comment">&#123; &quot;net&quot;, &quot;socket and network syscalls&quot;, &#123; &quot;shutdown&quot;, &quot;getsockopt&quot;, &quot;setsockopt&quot;, &quot;listen&quot;, &quot;accept&quot;, &quot;bind&quot;, &quot;recvmsg&quot;, &quot;getpeername&quot;, &quot;getsockname&quot;, &quot;recvfrom&quot;, &quot;socket&quot;, &quot;sendto&quot;, &quot;socketpair&quot;, &quot;connect&quot;, &quot;sendmsg&quot;, NULL &#125; &#125;,</span></span><br><span class="line"><span class="comment">...</span></span><br><span class="line"><span class="comment">&#123; NULL, NULL, &#123; NULL &#125; &#125;,</span></span><br><span class="line"><span class="comment">&#125;;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="type">syscall_lookup_t</span> syscall_lookup_table[];</span><br><span class="line"><span class="keyword">extern</span> <span class="type">fault_profile_t</span> fault_profile_table[];</span><br></pre></td></tr></table></figure>

<p>然后，看一下krfctl应用程序的入口函数:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 遍历系统调用映射表，查找对应的系统调用号</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *<span class="title function_">lookup_syscall_number</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *sys_name)</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">syscall_lookup_t</span> *elem = syscall_lookup_table; elem-&gt;sys_name != <span class="literal">NULL</span>; elem++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(sys_name, elem-&gt;sys_name)) &#123;</span><br><span class="line">      <span class="keyword">return</span> elem-&gt;sys_num;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 遍历系统调用分类表，查找对应的系统调用列表</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> **<span class="title function_">lookup_syscall_profile</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *profile)</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">fault_profile_t</span> *elem = fault_profile_table; elem-&gt;profile != <span class="literal">NULL</span>; elem++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(profile, elem-&gt;profile)) &#123;</span><br><span class="line">      <span class="keyword">return</span> elem-&gt;syscalls;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">fault_syscall_spec</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *s)</span> &#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *sys_name = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 字符串拷贝，内部调用malloc函数</span></span><br><span class="line">  <span class="type">char</span> *spec = strdup(s);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 字符串切割依次得到每个系统调用名</span></span><br><span class="line">  sys_name = strtok(spec, <span class="string">&quot;, &quot;</span>);</span><br><span class="line">  <span class="keyword">while</span> (sys_name) &#123;</span><br><span class="line">    <span class="comment">// 故障注入</span></span><br><span class="line">    fault_syscall(sys_name);</span><br><span class="line">    sys_name = strtok(<span class="literal">NULL</span>, <span class="string">&quot;, &quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 及时释放内存，防止内存泄漏</span></span><br><span class="line">  <span class="built_in">free</span>(spec);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">fault_syscall_profile</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *profile)</span> &#123;</span><br><span class="line">  <span class="comment">// 获取某一方面的系统调用列表</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> **syscalls = lookup_syscall_profile(profile);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (syscalls == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    errx(<span class="number">1</span>, <span class="string">&quot;couldn&#x27;t find fault profile: %s&quot;</span>, profile);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 逐个进行故障注入</span></span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; syscalls[i]; i++) &#123;</span><br><span class="line">    fault_syscall(syscalls[i]);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">fault_syscall</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *sys_name)</span> &#123;</span><br><span class="line">  <span class="type">int</span> fd;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *sys_num;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* check for wait4 and select */</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(sys_name, <span class="string">&quot;wait4&quot;</span>) || !<span class="built_in">strcmp</span>(sys_name, <span class="string">&quot;select&quot;</span>))</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,</span><br><span class="line">            <span class="string">&quot;Warning: faulting syscall %s can potentially cause kernel oops on module unload\n&quot;</span>,</span><br><span class="line">            sys_name);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* TODO(ww): Opening the control file once per syscall is</span></span><br><span class="line"><span class="comment">   * pretty nasty, but I don&#x27;t like passing a fd around.</span></span><br><span class="line"><span class="comment">   * Maybe a static variable that we test-and-set?</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">if</span> ((fd = open(CONTROL_FILE, O_WRONLY)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    err(errno, <span class="string">&quot;open &quot;</span> CONTROL_FILE);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!(sys_num = lookup_syscall_number(sys_name))) &#123;</span><br><span class="line">    warnx(<span class="string">&quot;WARNING: couldn&#x27;t find syscall: %s&quot;</span>, sys_name);</span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (write(fd, sys_num, <span class="built_in">strlen</span>(sys_num)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">/* friendly error message on unsupported syscall */</span></span><br><span class="line">    <span class="keyword">if</span> (errno == EOPNOTSUPP) &#123;</span><br><span class="line">      errx(errno, <span class="string">&quot;faulting for %s unimplemented&quot;</span>, sys_name);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      err(errno, <span class="string">&quot;write &quot;</span> CONTROL_FILE);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  close(fd);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">clear_faulty_calls</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  <span class="type">int</span> fd;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((fd = open(CONTROL_FILE, O_WRONLY)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    err(errno, <span class="string">&quot;open &quot;</span> CONTROL_FILE);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (write(fd, CLEAR_MAGIC, <span class="built_in">strlen</span>(CLEAR_MAGIC)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    err(errno, <span class="string">&quot;write &quot;</span> CONTROL_FILE);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  close(fd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">set_rng_state</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *state)</span> &#123;</span><br><span class="line">  <span class="type">int</span> fd;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((fd = open(RNG_STATE_FILE, O_WRONLY)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    err(errno, <span class="string">&quot;open &quot;</span> RNG_STATE_FILE);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (write(fd, state, <span class="built_in">strlen</span>(state)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    err(errno, <span class="string">&quot;write &quot;</span> RNG_STATE_FILE);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  close(fd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">set_prob_state</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *state)</span> &#123;</span><br><span class="line">  <span class="type">int</span> fd;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((fd = open(PROBABILITY_FILE, O_WRONLY)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    err(errno, <span class="string">&quot;open &quot;</span> PROBABILITY_FILE);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (write(fd, state, <span class="built_in">strlen</span>(state)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    err(errno, <span class="string">&quot;write &quot;</span> PROBABILITY_FILE);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  close(fd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">toggle_fault_logging</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  <span class="type">int</span> fd;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">32</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> state;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((fd = open(LOG_FAULTS_FILE, O_RDWR)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    err(errno, <span class="string">&quot;open &quot;</span> LOG_FAULTS_FILE);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (read(fd, buf, <span class="keyword">sizeof</span>(buf) - <span class="number">1</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    err(errno, <span class="string">&quot;read &quot;</span> LOG_FAULTS_FILE);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">sscanf</span>(buf, <span class="string">&quot;%u&quot;</span>, &amp;state) != <span class="number">1</span>) &#123;</span><br><span class="line">    errx(<span class="number">1</span>, <span class="string">&quot;weird logging state: %s&quot;</span>, buf);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  state = !state;</span><br><span class="line">  <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">  <span class="built_in">snprintf</span>(buf, <span class="keyword">sizeof</span>(buf), <span class="string">&quot;%u&quot;</span>, state);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (write(fd, buf, <span class="built_in">strlen</span>(buf)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    err(errno, <span class="string">&quot;write &quot;</span> LOG_FAULTS_FILE);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  close(fd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">set_targeting</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> mode, <span class="type">const</span> <span class="type">char</span> *data)</span> &#123;</span><br><span class="line">  <span class="type">int</span> fd;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">32</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="keyword">if</span> ((fd = open(TARGETING_FILE, O_WRONLY)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    err(errno, <span class="string">&quot;open &quot;</span> TARGETING_FILE);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">snprintf</span>(buf, <span class="keyword">sizeof</span>(buf), <span class="string">&quot;%u %s&quot;</span>, mode, data) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    err(errno, <span class="string">&quot;snprintf&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (write(fd, buf, <span class="built_in">strlen</span>(buf)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    err(errno, <span class="string">&quot;write &quot;</span> TARGETING_FILE);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  close(fd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 筛选模式数组</span></span><br><span class="line"><span class="type">char</span> *<span class="type">const</span> targeting_opts[] = &#123;[KRF_T_MODE_PERSONALITY] = <span class="string">&quot;personality&quot;</span>,</span><br><span class="line">                                [KRF_T_MODE_PID] = <span class="string">&quot;PID&quot;</span>,</span><br><span class="line">                                [KRF_T_MODE_UID] = <span class="string">&quot;UID&quot;</span>,</span><br><span class="line">                                [KRF_T_MODE_GID] = <span class="string">&quot;GID&quot;</span>,</span><br><span class="line">                                [KRF_T_MODE_INODE] = <span class="string">&quot;INODE&quot;</span>,</span><br><span class="line">                                [KRF_T_NUM_MODES] = <span class="literal">NULL</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 主控函数，通过[/proc/krf/xxx]等文件的文件操作结构体中预先绑定的读写函数进行故障注入的配置</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">  <span class="type">char</span> *subopts, *value;</span><br><span class="line">  <span class="type">int</span> c;</span><br><span class="line">  <span class="keyword">while</span> ((c = getopt(argc, argv, <span class="string">&quot;F:P:cr:p:LT:Ch&quot;</span>)) != <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (c) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;F&#x27;</span>: &#123;</span><br><span class="line">      fault_syscall_spec(optarg);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;P&#x27;</span>: &#123;</span><br><span class="line">      fault_syscall_profile(optarg);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;c&#x27;</span>: &#123;</span><br><span class="line">      clear_faulty_calls();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;r&#x27;</span>: &#123;</span><br><span class="line">      set_rng_state(optarg);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;p&#x27;</span>: &#123;</span><br><span class="line">      set_prob_state(optarg);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;L&#x27;</span>: &#123;</span><br><span class="line">      toggle_fault_logging();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;T&#x27;</span>: &#123;</span><br><span class="line">      subopts = optarg;</span><br><span class="line">      <span class="type">int</span> ca;</span><br><span class="line">      <span class="keyword">while</span> (*subopts != <span class="string">&#x27;\0&#x27;</span>) &#123;</span><br><span class="line">        ca = getsubopt(&amp;subopts, targeting_opts, &amp;value);</span><br><span class="line">        <span class="keyword">if</span> (value == <span class="literal">NULL</span>) &#123;</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">&quot;error: there must be a value input for the targeting option\n&quot;</span>);</span><br><span class="line">          <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (ca &gt;= KRF_T_NUM_MODES) &#123;</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">&quot;error: unknown targeting option %s\n&quot;</span>, value);</span><br><span class="line">          <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        set_targeting(ca, value);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;C&#x27;</span>: &#123;</span><br><span class="line">      set_targeting(<span class="number">0</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;h&#x27;</span>:</span><br><span class="line">    <span class="keyword">default</span>: &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;usage: krfctl &lt;options&gt;\n&quot;</span></span><br><span class="line">             <span class="string">&quot;options:\n&quot;</span></span><br><span class="line">             <span class="string">&quot; -h                          display this help message\n&quot;</span></span><br><span class="line">             <span class="string">&quot; -F &lt;syscall&gt; [syscall...]   fault the given syscalls\n&quot;</span></span><br><span class="line">             <span class="string">&quot; -P &lt;profile&gt;                fault the given syscall profile\n&quot;</span></span><br><span class="line">             <span class="string">&quot; -c                          clear the syscall table of faulty calls\n&quot;</span></span><br><span class="line">             <span class="string">&quot; -r &lt;state&gt;                  set the RNG state\n&quot;</span></span><br><span class="line">             <span class="string">&quot; -p &lt;prob&gt;                   set the fault probability\n&quot;</span></span><br><span class="line">             <span class="string">&quot; -L                          toggle faulty call logging\n&quot;</span></span><br><span class="line">             <span class="string">&quot; -T &lt;variable&gt;=&lt;value&gt;       enable targeting option &lt;variable&gt; with value &lt;value&gt;\n&quot;</span></span><br><span class="line">             <span class="string">&quot; -C                          clear the targeting options\n&quot;</span></span><br><span class="line">             <span class="string">&quot;targeting options:\n&quot;</span></span><br><span class="line">             <span class="string">&quot; personality, PID, UID, GID, and INODE\n&quot;</span></span><br><span class="line">             <span class="string">&quot;available profiles (for -P flag):\n&quot;</span></span><br><span class="line">             <span class="string">&quot; &quot;</span>);</span><br><span class="line">      <span class="type">fault_profile_t</span> *elem = fault_profile_table;</span><br><span class="line">      <span class="keyword">while</span> (elem-&gt;profile != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\t%s\t%s\n&quot;</span>, elem-&gt;profile, elem-&gt;description);</span><br><span class="line">        elem++;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-3krfexec程序源码剖析"><a href="#4-3krfexec程序源码剖析" class="headerlink" title="4.3krfexec程序源码剖析"></a>4.3krfexec程序源码剖析</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> KRF_PERSONALITY 28</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (argc &lt; <span class="number">2</span> || !<span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">&quot;-h&quot;</span>)) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;usage: krfexec &lt;command or file&gt; [args]\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 检查personality筛选模式是否选定且为期望值，设置进程的personality属性。</span></span><br><span class="line">  krfexec_prep();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 将核心转储的资源限制设置为无穷大,允许进程在发生崩溃或异常终止时生成任意大小的核心转储文件。</span></span><br><span class="line">  <span class="comment">// 核心转储文件包含了崩溃进程的内存镜像，对于调试和分析崩溃原因非常有用。</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">rlimit</span> <span class="title">core_limit</span>;</span></span><br><span class="line">  core_limit.rlim_cur = core_limit.rlim_max = RLIM_INFINITY;</span><br><span class="line">  <span class="keyword">if</span> (setrlimit(RLIMIT_CORE, &amp;core_limit) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    err(errno, <span class="string">&quot;setrlimit&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 进程镜像替换，执行目标程序如ls</span></span><br><span class="line">  <span class="keyword">if</span> (execvp(argv[<span class="number">1</span>], argv + <span class="number">1</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    err(errno, <span class="string">&quot;exec %s&quot;</span>, argv[<span class="number">1</span>]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">/* noreturn */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">krfexec_prep</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  <span class="comment">// Check if personality is being targeted</span></span><br><span class="line">  <span class="type">int</span> fd;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">64</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="type">int</span> <span class="built_in">set</span> = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ((fd = open(TARGETING_FILE, O_RDONLY)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    err(errno, <span class="string">&quot;open &quot;</span> TARGETING_FILE);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (read(fd, buf, <span class="keyword">sizeof</span>(buf) - <span class="number">1</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    err(errno, <span class="string">&quot;read&quot;</span> TARGETING_FILE);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">unsigned</span> mode, data;</span><br><span class="line">  <span class="keyword">while</span> (<span class="built_in">sscanf</span>(buf, <span class="string">&quot;%u %u&quot;</span>, &amp;mode, &amp;data) == <span class="number">2</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (mode != KRF_T_MODE_PERSONALITY)</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (data == KRF_PERSONALITY) &#123;</span><br><span class="line">      <span class="built_in">set</span> = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      errx(<span class="number">1</span>, <span class="string">&quot;Personality set to a value that krfexec does not recognize. Use `krfctl -T &quot;</span></span><br><span class="line">              <span class="string">&quot;personality=28` to properly set.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">set</span>) &#123;</span><br><span class="line">    errx(<span class="number">1</span>, <span class="string">&quot;Personality targeting disabled. Run `krfctl -T personality=28` to enable.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  close(fd);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置进程的personality</span></span><br><span class="line">  <span class="keyword">if</span> (personality(KRF_PERSONALITY | ADDR_NO_RANDOMIZE) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    err(errno, <span class="string">&quot;personality&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="/tags/">Tag</a></li>
        
          <li><a target="_blank" rel="noopener" href="http://github.com/hulingF">Projects</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#KRF%E6%A1%86%E6%9E%B6%E5%8E%9F%E7%90%86%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90"><span class="toc-number">1.</span> <span class="toc-text">KRF框架原理深入剖析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-KRF%E6%95%85%E9%9A%9C%E6%B3%A8%E5%85%A5%E5%AE%9E%E6%88%98%E6%BC%94%E7%BB%83"><span class="toc-number">1.1.</span> <span class="toc-text">1.KRF故障注入实战演练</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-KRF%E6%80%BB%E4%BD%93%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.2.</span> <span class="toc-text">2.KRF总体架构设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-KRF%E6%A1%86%E6%9E%B6%E6%9E%84%E5%BB%BA%E8%BF%87%E7%A8%8B"><span class="toc-number">1.3.</span> <span class="toc-text">3.KRF框架构建过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1%E6%A0%B9%E7%9B%AE%E5%BD%95Makefile"><span class="toc-number">1.3.1.</span> <span class="toc-text">3.1根目录Makefile</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2krfx%E6%A0%B8%E5%BF%83%E6%A8%A1%E5%9D%97%E6%9E%84%E5%BB%BA"><span class="toc-number">1.3.2.</span> <span class="toc-text">3.2krfx核心模块构建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3krfctl%E5%AD%90%E6%A8%A1%E5%9D%97%E6%9E%84%E5%BB%BA"><span class="toc-number">1.3.3.</span> <span class="toc-text">3.3krfctl子模块构建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4%E5%85%B6%E4%BB%96%E5%AD%90%E6%A8%A1%E5%9D%97%E6%9E%84%E5%BB%BA"><span class="toc-number">1.3.4.</span> <span class="toc-text">3.4其他子模块构建</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-KRF%E6%A1%86%E6%9E%B6%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90"><span class="toc-number">1.4.</span> <span class="toc-text">4.KRF框架源码剖析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1krfx%E5%86%85%E6%A0%B8%E6%A8%A1%E5%9D%97%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90"><span class="toc-number">1.4.1.</span> <span class="toc-text">4.1krfx内核模块源码剖析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2krfctl%E7%A8%8B%E5%BA%8F%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90"><span class="toc-number">1.4.2.</span> <span class="toc-text">4.2krfctl程序源码剖析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3krfexec%E7%A8%8B%E5%BA%8F%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90"><span class="toc-number">1.4.3.</span> <span class="toc-text">4.3krfexec程序源码剖析</span></a></li></ol></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://hulingf.github.io/2024/02/12/KRF%E6%A1%86%E6%9E%B6%E5%8E%9F%E7%90%86%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://hulingf.github.io/2024/02/12/KRF%E6%A1%86%E6%9E%B6%E5%8E%9F%E7%90%86%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90/&text=KRF框架原理深入剖析"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://hulingf.github.io/2024/02/12/KRF%E6%A1%86%E6%9E%B6%E5%8E%9F%E7%90%86%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90/&title=KRF框架原理深入剖析"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://hulingf.github.io/2024/02/12/KRF%E6%A1%86%E6%9E%B6%E5%8E%9F%E7%90%86%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90/&is_video=false&description=KRF框架原理深入剖析"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=KRF框架原理深入剖析&body=Check out this article: https://hulingf.github.io/2024/02/12/KRF%E6%A1%86%E6%9E%B6%E5%8E%9F%E7%90%86%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://hulingf.github.io/2024/02/12/KRF%E6%A1%86%E6%9E%B6%E5%8E%9F%E7%90%86%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90/&title=KRF框架原理深入剖析"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://hulingf.github.io/2024/02/12/KRF%E6%A1%86%E6%9E%B6%E5%8E%9F%E7%90%86%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90/&title=KRF框架原理深入剖析"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://hulingf.github.io/2024/02/12/KRF%E6%A1%86%E6%9E%B6%E5%8E%9F%E7%90%86%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90/&title=KRF框架原理深入剖析"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://hulingf.github.io/2024/02/12/KRF%E6%A1%86%E6%9E%B6%E5%8E%9F%E7%90%86%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90/&title=KRF框架原理深入剖析"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://hulingf.github.io/2024/02/12/KRF%E6%A1%86%E6%9E%B6%E5%8E%9F%E7%90%86%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90/&name=KRF框架原理深入剖析&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://hulingf.github.io/2024/02/12/KRF%E6%A1%86%E6%9E%B6%E5%8E%9F%E7%90%86%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90/&t=KRF框架原理深入剖析"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2024
    hulingF
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/hulingF">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'hulingF';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>

<!-- utterances Comments -->

</body>
</html>
